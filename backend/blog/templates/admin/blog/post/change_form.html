{% extends "admin/change_form.html" %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" href="{% static 'admin/css/tiptap_admin.css' %}">
{{ block.super }}
{% endblock %}

{% block content %}
<div class="tiptap-layout" style="display:flex; gap:18px; align-items:flex-start;">
  <div class="tiptap-main" style="flex:1 1 65%; min-width:520px;">
    {# Основная форма: рендерим все поля, но контент - в нашем редакторе #}
    <form method="post" enctype="multipart/form-data" id="post-form">
      {% csrf_token %}
      <div>
        {% for fieldset in adminform %}
          <fieldset class="module aligned">
            {% for line in fieldset %}
              <div class="form-row">
                {% for field in line %}
                  {% if field.name == 'content' %}
                    <div class="field-box">
                      <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                      {{ field.field }}
                      {% if field.help_text %}<p class="help">{{ field.help_text }}</p>{% endif %}
                    </div>
                  {% else %}
                    <div class="field-box">
                      {{ field }}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endfor %}
          </fieldset>
        {% endfor %}
      </div>

      <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button type="button" class="button" id="btn-save-draft">Сохранить</button>
        <button type="button" class="button" id="btn-preview">Предпросмотр</button>
        <button type="button" class="button" id="btn-toggle-preview">Показать/Скрыть превью</button>
        <button type="button" class="button" id="btn-revisions">Ревизии</button>
        <span id="autosave-indicator" style="color:#6b7280; margin-left:10px">Autosave: idle</span>
      </div>

      <div id="editor-and-preview" style="display:flex; gap:12px; margin-top:12px;">
        <div id="editor-container" style="flex:1; min-width:300px;">
          {# TipTap widget находится в поле content (textarea): он инициализирует редактор #}
          <!-- тут редактор будет отрисован виджетом -->
        </div>

        <div id="preview-container" style="flex:1; min-width:300px;">
          <div class="tiptap-preview" id="live-preview" aria-live="polite" style="min-height:280px; padding:12px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; overflow:auto;">
            Предпросмотр появится здесь...
          </div>
        </div>
      </div>

      {# Hidden submit to allow real saving (server expects content in textarea) #}
      <input type="hidden" name="_save" value="1">
    </form>
  </div>

  <aside class="tiptap-side" style="flex:0 0 320px; max-width:320px;">
    <div class="panel" style="padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; margin-bottom:12px;">
      <h4>Сведения</h4>
      <div><strong>Автор:</strong> {{ original.author }}</div>
      <div><strong>Статус:</strong> {{ original.status }}</div>
      <div style="margin-top:8px"><a class="button" href="{% url 'admin-media-library' %}?post_id={{ original.pk }}">Медиа библиотека</a></div>
    </div>

    <div class="panel" id="revisions-panel" style="padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; margin-bottom:12px;">
      <h4>Ревизии</h4>
      <div id="revisions-list">Загрузка…</div>
    </div>

    <div class="panel" style="padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#fff;">
      <h4>SEO / Помощь</h4>
      <div>Слов: <span id="word-count">0</span></div>
      <div>Знаков: <span id="char-count">0</span></div>
      <div style="margin-top:6px"><button id="btn-insert-toc" class="button">Вставить оглавление</button></div>
    </div>
  </aside>
</div>

{% endblock %}

{% block extrahead %}
<script>
window.ADMIN_POST_ID = {{ original.pk|default:'null' }};
</script>
<script src="{% static 'admin/js/tiptap_admin_extra.js' %}"></script>
<link rel="stylesheet" href="{% static 'admin/css/tiptap_admin.css' %}">
{% endblock %}
