{# backend/blog/templates/admin/blog/post/change_form.html #}
{% extends "admin/change_form.html" %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" href="{% static 'admin/css/tiptap_admin.css' %}">
<style>
/* Минимальная сетка: левый редактор, правый предпросмотр/метапанель */
.tiptap-layout { display:flex; gap:18px; align-items:flex-start; }
.tiptap-main { flex: 1 1 65%; min-width: 520px; }
.tiptap-side { flex: 0 0 320px; max-width: 320px; }
.tiptap-side .panel { padding:10px; border:1px solid #e5e7eb; border-radius:6px; background:#fff; margin-bottom:12px; }
.tiptap-toolbar-row { display:flex; gap:6px; align-items:center; margin-bottom:8px; }
.tiptap-preview { border:1px solid #e5e7eb; border-radius:6px; padding:12px; min-height:300px; background:#fff; overflow:auto; }
.tiptap-footer { margin-top:8px; font-size:13px; color:#6b7280; display:flex; justify-content:space-between; align-items:center; }
</style>
{{ block.super }}
{% endblock %}

{% block content %}
<div class="tiptap-layout">
  <div class="tiptap-main">
    {# Render standard admin form fields as usual but put content field into the TipTap widget area #}
    <div>
      {% for fieldset in adminform %}
        {% for line in fieldset %}
          {% for field in line %}
            {% if field.name == 'content' %}
              <div class="form-row field-content">
                <label class="required">{{ field.label_tag }}</label>
                {{ field.field }}
                {% if field.errors %}{{ field.errors }}{% endif %}
                {% if field.help_text %}<p class="help">{{ field.help_text }}</p>{% endif %}
              </div>
            {% else %}
              {{ field|unordered_list }} {# fallback render for other fields - admin will fill them normally #}
            {% endif %}
          {% endfor %}
        {% endfor %}
      {% endfor %}
    </div>

    <div class="tiptap-toolbar-row">
      <button type="button" class="button" id="btn-save-draft">Save draft</button>
      <button type="button" class="button" id="btn-preview">Preview</button>
      <button type="button" class="button" id="btn-toggle-preview">Toggle preview</button>
      <button type="button" class="button" id="btn-revisions">Revisions</button>
      <button type="button" class="button" id="btn-fullscreen">Fullscreen</button>
      <span id="autosave-indicator" style="margin-left:8px;color:#6b7280">Autosave: idle</span>
    </div>

    <div id="editor-and-preview" style="display:flex; gap:12px; align-items:flex-start;">
      <div id="editor-container" style="flex:1;">
        {# TIPTAP widget renders as textarea + contenteditable; already in widget template #}
      </div>
      <div id="preview-container" style="flex:1;">
        <div class="tiptap-preview" id="live-preview" aria-live="polite"></div>
      </div>
    </div>

    <div class="tiptap-footer">
      <div>Words: <span id="word-count">0</span> • Characters: <span id="char-count">0</span></div>
      <div>Read time: <span id="read-time">0</span> min</div>
    </div>
  </div>

  <aside class="tiptap-side">
    <div class="panel">
      <h4>Post meta</h4>
      <div>
        <strong>Status:</strong> {{ original.status }}
      </div>
      <div>
        <strong>Author:</strong> {{ original.author }}
      </div>
      <div style="margin-top:8px">
        <a class="button" href="{% url 'admin-media-library' %}?post_id={{ original.pk }}">Open Media Library</a>
      </div>
    </div>

    <div class="panel">
      <h4>Revisions</h4>
      <div id="revisions-list">Loading…</div>
    </div>

    <div class="panel">
      <h4>SEO</h4>
      <div><strong>Meta description</strong><div>{{ original.meta_description|default:"—" }}</div></div>
      <div style="margin-top:6px"><a class="button" id="btn-insert-toc">Insert TOC</a></div>
    </div>
  </aside>
</div>

{{ block.super }}
{% endblock %}

{% block extrahead %}
<script>
window.ADMIN_POST_ID = {{ original.pk|default:'null' }};
window.ADMIN_POST_EDIT_URL = "{% url 'admin:blog_post_change' original.pk %}" ;
</script>
<script src="{% static 'admin/js/tiptap_widget_extra.js' %}"></script>
{% endblock %}
