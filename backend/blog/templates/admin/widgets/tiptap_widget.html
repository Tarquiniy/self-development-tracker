{# backend/templates/admin/widgets/tiptap_widget.html #}
{% load static %}
<div class="admin-tiptap-widget" data-upload-url="{{ widget.attrs.data-upload-url|default:'/api/blog/media/upload/' }}" data-preview-token-url="{{ widget.attrs.data-preview-token-url|default:'/api/blog/preview-token/' }}">
  <textarea name="{{ widget.name }}" id="{{ widget.attrs.id }}" style="display:none;">{{ widget.value|default:"" }}</textarea>

  <div class="tiptap-toolbar" style="margin-bottom:8px;">
    <button type="button" data-cmd="toggleBold" title="Bold"><b>B</b></button>
    <button type="button" data-cmd="toggleItalic" title="Italic"><i>I</i></button>
    <button type="button" data-cmd="toggleStrike" title="Strike"><s>S</s></button>
    <button type="button" data-cmd="toggleHeading1">H1</button>
    <button type="button" data-cmd="toggleHeading2">H2</button>
    <button type="button" data-cmd="toggleBulletList">UL</button>
    <button type="button" data-cmd="toggleOrderedList">OL</button>
    <button type="button" data-cmd="insertTable">Table</button>
    <button type="button" data-cmd="insertCodeBlock">Code</button>
    <button type="button" data-cmd="setLink">Link</button>
    <button type="button" data-cmd="uploadImage">Image</button>
    <input type="file" accept="image/*" class="tiptap-upload-input" style="display:none">
  </div>

  <div class="tiptap-editor-wrapper" style="border:1px solid #e5e7eb; padding:8px; border-radius:6px; background:#fff;">
    <div class="tiptap-editor" contenteditable="true" style="min-height:300px; outline:none; padding:6px;">
      {% if widget.value %}
        {{ widget.value|safe }}
      {% else %}
        <p></p>
      {% endif %}
    </div>
  </div>
</div>

<script type="module">
(async function(){
  const root = document.currentScript.previousElementSibling;
  const textarea = root.querySelector('textarea');
  const editorEl = root.querySelector('.tiptap-editor');
  const toolbar = root.querySelector('.tiptap-toolbar');
  const uploadInput = root.querySelector('.tiptap-upload-input');
  const uploadUrl = root.dataset.uploadUrl || '/api/blog/media/upload/';
  const autosaveUrl = '/api/blog/revisions/autosave/';

  function getCSRFToken(){
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    if (match) return match[1];
    const m2 = document.querySelector('meta[name="csrfmiddlewaretoken"]');
    return m2 ? m2.content : '';
  }

  function sanitizeClient(html){
    // light client-side cleanup
    return html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '').replace(/\son\w+\s*=\s*"(?:[^"]*)"/gi, '').replace(/\son\w+\s*=\s*'(?:[^']*)'/gi, '');
  }

  // Try import TipTap ESM modules from jsdelivr / esm.sh if available; fallback to contenteditable
  try {
    const [{ Editor }, StarterKitModule, LinkModule, ImageModule, PlaceholderModule, CharacterCountModule, UnderlineModule, HistoryModule, TableModule, TableRowModule, TableCellModule, TableHeaderModule, CodeBlockLowlightModule] = await Promise.all([
      import('https://esm.sh/@tiptap/core'),
      import('https://esm.sh/@tiptap/starter-kit'),
      import('https://esm.sh/@tiptap/extension-link'),
      import('https://esm.sh/@tiptap/extension-image'),
      import('https://esm.sh/@tiptap/extension-placeholder'),
      import('https://esm.sh/@tiptap/extension-character-count'),
      import('https://esm.sh/@tiptap/extension-underline'),
      import('https://esm.sh/@tiptap/extension-history'),
      import('https://esm.sh/@tiptap/extension-table'),
      import('https://esm.sh/@tiptap/extension-table-row'),
      import('https://esm.sh/@tiptap/extension-table-cell'),
      import('https://esm.sh/@tiptap/extension-table-header'),
      import('https://esm.sh/@tiptap/extension-code-block-lowlight'),
    ]);

    const StarterKit = StarterKitModule.default || StarterKitModule;
    const Link = LinkModule.default || LinkModule;
    const Image = ImageModule.default || ImageModule;
    const Placeholder = PlaceholderModule.default || PlaceholderModule;
    const CharacterCount = CharacterCountModule.default || CharacterCountModule;
    const Underline = UnderlineModule.default || UnderlineModule;
    const History = HistoryModule.default || HistoryModule;
    const Table = TableModule.default || TableModule;
    const TableRow = TableRowModule.default || TableRowModule;
    const TableCell = TableCellModule.default || TableCellModule;
    const TableHeader = TableHeaderModule.default || TableHeaderModule;
    const CodeBlockLowlight = CodeBlockLowlightModule.default || CodeBlockLowlightModule;

    // optional lowlight
    let lowlight = null;
    try {
      const ll = await import('https://esm.sh/lowlight/lib/core');
      lowlight = ll.default || ll;
      try { lowlight.registerLanguage('javascript', (await import('https://esm.sh/highlight.js/lib/languages/javascript')).default); } catch(e){}
      try { lowlight.registerLanguage('python', (await import('https://esm.sh/highlight.js/lib/languages/python')).default); } catch(e){}
    } catch(e){
      lowlight = null;
    }

    const extensions = [
      StarterKit(),
      Link.configure({ openOnClick:false }),
      Image.configure({ inline:false }),
      Placeholder.configure({ placeholder: 'Начните вводить текст...' }),
      CharacterCount.configure({ limit: 20000 }),
      Underline(),
      History(),
      Table.configure({ resizable: true }),
      TableRow(),
      TableCell(),
      TableHeader(),
      ...(CodeBlockLowlight && lowlight ? [ CodeBlockLowlight.configure({ lowlight }) ] : []),
    ];

    const editor = new Editor({
      element: editorEl,
      extensions,
      content: textarea.value && textarea.value.trim() ? textarea.value : '<p></p>',
      onUpdate: ({ editor }) => {
        textarea.value = editor.getHTML();
        // dispatch a custom event for admin extras
        window.dispatchEvent(new CustomEvent('tiptap:update', { detail: { html: textarea.value } }));
      }
    });

    // expose for admin extras script
    window.__tiptap_current_editor = editor;

    // toolbar
    toolbar.addEventListener('click', function(e){
      const btn = e.target.closest('button');
      if (!btn) return;
      const cmd = btn.getAttribute('data-cmd');
      e.preventDefault();
      if (cmd === 'insertTable') editor.chain().focus().insertTable({ rows:3, cols:3 }).run();
      else if (cmd === 'insertCodeBlock') editor.chain().focus().toggleCodeBlock().run();
      else if (cmd === 'uploadImage') uploadInput && uploadInput.click();
      else if (cmd === 'setLink'){
        const url = prompt('Ссылка (https://...)', 'https://');
        if (url) editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
      } else {
        // mapping
        if (cmd === 'toggleBold') editor.chain().focus().toggleBold().run();
        if (cmd === 'toggleItalic') editor.chain().focus().toggleItalic().run();
        if (cmd === 'toggleStrike') editor.chain().focus().toggleStrike().run();
        if (cmd === 'toggleHeading1') editor.chain().focus().toggleHeading({ level:1 }).run();
        if (cmd === 'toggleHeading2') editor.chain().focus().toggleHeading({ level:2 }).run();
        if (cmd === 'toggleBulletList') editor.chain().focus().toggleBulletList().run();
        if (cmd === 'toggleOrderedList') editor.chain().focus().toggleOrderedList().run();
      }
    });

    // upload handling
    uploadInput && uploadInput.addEventListener('change', async function(){
      const file = this.files && this.files[0]; if (!file) return;
      const fd = new FormData(); fd.append('file', file);
      try {
        const res = await fetch(uploadUrl, { method:'POST', body: fd, credentials:'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() }});
        const json = await res.json();
        const url = json.url || (json.uploaded && json.uploaded[0] && json.uploaded[0].url);
        if (url) editor.chain().focus().setImage({ src: url }).run();
        else alert('Файл загружен, но URL не получен');
      } catch(e){
        console.error(e); alert('Ошибка загрузки');
      }
      this.value = '';
    });

    // drag&drop
    editorEl.addEventListener('drop', async (ev)=>{
      ev.preventDefault();
      const f = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
      if (f){
        const fd = new FormData(); fd.append('file', f);
        try {
          const res = await fetch(uploadUrl, { method:'POST', body: fd, credentials:'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() }});
          const json = await res.json();
          const url = json.url || (json.uploaded && json.uploaded[0] && json.uploaded[0].url);
          if (url) editor.chain().focus().setImage({ src: url }).run();
        } catch(e){ console.error('drop upload failed', e); }
      }
    });

    // autosave (periodic) — only if admin page has POST id
    let autosaveTimer = null;
    const POST_ID = window.ADMIN_POST_ID || null;
    const AUTOSAVE_INTERVAL = 15000;
    async function autosave(){
      if (!POST_ID) return;
      const payload = new FormData();
      payload.append('post_id', POST_ID);
      payload.append('title', (document.querySelector('input[name="title"]') || {value:''}).value);
      payload.append('content', sanitizeClient(editor.getHTML()));
      payload.append('excerpt', (document.querySelector('textarea[name="excerpt"]') || {value:''}).value);
      payload.append('autosave', '1');
      try {
        window.dispatchEvent(new CustomEvent('tiptap:autosave:start'));
        const r = await fetch(autosaveUrl, { method:'POST', body: payload, credentials:'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() }});
        const j = await r.json();
        if (j.success) window.dispatchEvent(new CustomEvent('tiptap:autosave:done', { detail: j }));
      } catch(e){
        console.error('autosave failed', e);
        window.dispatchEvent(new CustomEvent('tiptap:autosave:error', { detail: e }));
      }
    }
    if (POST_ID) autosaveTimer = setInterval(autosave, AUTOSAVE_INTERVAL);

    // ensure content in textarea when form submitted
    const form = document.querySelector('#post-form') || textarea.closest('form');
    if (form) form.addEventListener('submit', ()=>{ textarea.value = sanitizeClient(editor.getHTML()); });

  } catch (err){
    console.warn('TipTap import failed, falling back to simple contenteditable', err);
    // fallback: simple contenteditable -> sync to textarea
    function sync(){ textarea.value = editorEl.innerHTML; window.dispatchEvent(new CustomEvent('tiptap:update', { detail: { html: textarea.value } })); }
    editorEl.addEventListener('input', sync);
    const form = textarea.closest('form');
    if (form) form.addEventListener('submit', sync);
  }
})();
</script>
