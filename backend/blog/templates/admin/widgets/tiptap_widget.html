{# admin/widgets/tiptap_widget.html - –ø–æ–ª–Ω—ã–π TipTap widget –¥–ª—è Django admin (ESM/CDN + fallback) #}
{% load static %}
<style>
.tiptap-root { margin-top: 0.35rem; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
.tiptap-toolbar { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; align-items:center; }
.tiptap-toolbar button { padding:6px 8px; border-radius:6px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-size:13px; }
.tiptap-toolbar button.active { background: linear-gradient(180deg, rgba(59,130,246,0.08), rgba(59,130,246,0.03)); box-shadow: inset 0 -2px 0 rgba(59,130,246,0.15); }
.tiptap-editor { min-height:260px; border-radius:8px; border:1px solid #e6e7eb; padding:12px; background:#fff; outline:none; }
.tiptap-editor:focus { box-shadow:0 0 0 4px rgba(59,130,246,0.06); border-color:#93c5fd; }
.tiptap-hidden-textarea { display:none; }
.tiptap-help { margin-top:6px; font-size:12px; color:#6b7280; }
.tiptap-upload-input { display:none; }
@media (prefers-color-scheme: dark) {
  .tiptap-editor { background:#071025; color:#e6eef8; border-color:#1f2937; }
  .tiptap-toolbar button { background:#0b1220; color:#d1d5db; border-color:#374151; }
}
</style>

<div class="tiptap-root" data-widget-name="{{ widget.name }}" {% for k,v in widget.attrs.items %} {{ k }}="{{ v|escape }}" {% endfor %}>
  <textarea name="{{ widget.name }}" class="tiptap-hidden-textarea" {% include "django/forms/widgets/attrs.html" %}>{{ widget.value|default_if_none:"" }}</textarea>

  <div class="tiptap-toolbar" role="toolbar" aria-label="Editor toolbar">
    <button type="button" data-cmd="toggleBold" title="Bold (Ctrl/Cmd+B)"><strong>B</strong></button>
    <button type="button" data-cmd="toggleItalic" title="Italic (Ctrl/Cmd+I)"><em>I</em></button>
    <button type="button" data-cmd="toggleStrike" title="Strike">S</button>
    <button type="button" data-cmd="toggleUnderline" title="U">U</button>
    <button type="button" data-cmd="toggleHeading1">H1</button>
    <button type="button" data-cmd="toggleHeading2">H2</button>
    <button type="button" data-cmd="toggleBulletList">‚Ä¢</button>
    <button type="button" data-cmd="toggleOrderedList">1.</button>
    <button type="button" data-cmd="toggleBlockquote">‚ùù</button>
    <button type="button" data-cmd="toggleCodeBlock">&lt;/&gt;</button>
    <button type="button" data-cmd="setLink">üîó</button>
    <button type="button" data-cmd="unsetLink">‚õî</button>
    <label>
      <input type="file" accept="image/*" class="tiptap-upload-input" />
      <button type="button" data-cmd="uploadImage">üñºÔ∏è</button>
    </label>
    <button type="button" data-cmd="undo">‚Ü∂</button>
    <button type="button" data-cmd="redo">‚Ü∑</button>
  </div>

  <div id="{{ widget.attrs.id|default:widget.name }}_tiptap" class="tiptap-editor" contenteditable="true" role="textbox" aria-multiline="true">
    {% if widget.value %}{{ widget.value|safe }}{% else %}<p></p>{% endif %}
  </div>

  <div class="tiptap-help">Hotkeys: <kbd>Ctrl/Cmd+B</kbd>, <kbd>Ctrl/Cmd+I</kbd>. –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ø—Ä–∏ submit.</div>
</div>

<!-- –≤—Å—Ç–∞–≤—å—Ç–µ –≤–º–µ—Å—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π <script type="module"> ... -->
<script type="module">
(async function(){
  const root = document.currentScript.previousElementSibling;
  const textarea = root.querySelector('textarea[name="{{ widget.name }}"]');
  const editorEl = root.querySelector('.tiptap-editor');
  const toolbar = root.querySelector('.tiptap-toolbar');
  const uploadInput = root.querySelector('.tiptap-upload-input');
  const uploadUrl = root.getAttribute('data-upload-url') || root.dataset.uploadUrl || '/api/blog/media/upload/';
  const revisionsUrlBase = '/api/blog/revisions/';
  const autosaveUrl = '/api/blog/revisions/autosave/';

  function getCSRFToken(){
    const name = 'csrftoken=';
    const cookies = document.cookie.split(';').map(c => c.trim());
    for (const c of cookies) if (c.startsWith(name)) return decodeURIComponent(c.substring(name.length));
    const meta = document.querySelector('meta[name="csrfmiddlewaretoken"], meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : null;
  }

  // Helper: simple sanitizer (allowlist) - server-side must also sanitize!
  function sanitizeHTML(html){
    // very small client-side safe cleanup: strip <script> tags and on* attributes
    html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
    html = html.replace(/\son\w+\s*=\s*"(?:[^"]*)"/gi, '');
    html = html.replace(/\son\w+\s*=\s*'(?:[^']*)'/gi, '');
    return html;
  }

  // Revisions panel UI (modal)
  function showRevisionsModal(postId){
    const modalId = 'revisions-modal';
    let modal = document.getElementById(modalId);
    if (!modal){
      modal = document.createElement('div');
      modal.id = modalId;
      Object.assign(modal.style, {position:'fixed', right:'20px', top:'80px', width:'420px', maxHeight:'70vh', overflow:'auto', background:'#fff', padding:'12px', border:'1px solid #ccc', zIndex:9999, boxShadow:'0 8px 32px rgba(0,0,0,0.12)'});
      document.body.appendChild(modal);
    }
    modal.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center;"><strong>Revisions</strong><button id="close-rev">Close</button></div><div id="rev-list" style="margin-top:8px">Loading...</div>';
    modal.querySelector('#close-rev').addEventListener('click', ()=>modal.remove());
    // fetch revisions
    fetch(`${revisionsUrlBase}${postId}/`, { credentials: 'same-origin' })
      .then(r => r.json())
      .then(data => {
        const list = modal.querySelector('#rev-list');
        list.innerHTML = '';
        const items = data.results || [];
        if (!items.length) list.innerHTML = '<p>No revisions</p>';
        for (const it of items){
          const div = document.createElement('div');
          div.style.borderBottom = '1px solid #eee';
          div.style.padding = '8px 0';
          div.innerHTML = `<b>${it.title || '(no title)'}</b><div style="font-size:12px;color:#666">${it.created_at} ${it.autosave?'<em>(autosave)</em>':''}</div>
            <div style="margin-top:6px"><button data-rev="${it.id}" class="rev-preview">Preview</button> <button data-rev="${it.id}" class="rev-restore">Restore</button></div>`;
          list.appendChild(div);
        }
        list.querySelectorAll('.rev-preview').forEach(btn=>{
          btn.addEventListener('click', e=>{
            const id = e.currentTarget.dataset.rev;
            // preview: fetch token by autosave endpoint? server returns preview_url inside autosave creation previously.
            // We'll call a small endpoint to get revision content and open in new window via POST preview token
            fetch(`/api/blog/revisions/${postId}/`, { credentials: 'same-origin' }).then(()=>{/*noop*/});
            // Simpler: open modal with content preview (client-side fetch)
            fetch(`/api/blog/revisions/${postId}/`, { credentials:'same-origin' }).then(r=>r.json()).then(d=>{
              const rev = d.results.find(r=>r.id==id);
              if (rev){
                const w = window.open('about:blank', '_blank');
                w.document.write(`<html><head><title>${rev.title}</title></head><body>${rev.content || ''}</body></html>`);
                w.document.close();
              } else alert('Revision not found');
            });
          });
        });
        list.querySelectorAll('.rev-restore').forEach(btn=>{
          btn.addEventListener('click', async e=>{
            const id = e.currentTarget.dataset.rev;
            if (!confirm('Restore this revision? Current content will be saved as a revision')) return;
            const res = await fetch(`/api/blog/revisions/restore/${id}/`, { method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() } });
            const json = await res.json();
            if (json.success){
              alert('Revision restored ‚Äî reloading page to show restored content');
              window.location.reload();
            } else {
              alert('Restore failed: ' + (json.message || 'unknown'));
            }
          });
        });
      }).catch(err=>{
        modal.querySelector('#rev-list').innerText = 'Error loading revisions';
        console.error(err);
      });
  }

  // Auto-save every N ms if post_id present
  let autosaveInterval = 15000; // 15s
  let autosaveTimer = null;
  let lastSavedAt = null;

  async function autosaveIfNeeded(postId){
    try {
      const html = sanitizeHTML(editor.getHTML());
      const title = document.querySelector('input[name="title"]') ? document.querySelector('input[name="title"]').value : '';
      const excerpt = document.querySelector('textarea[name="excerpt"]') ? document.querySelector('textarea[name="excerpt"]').value : '';
      const payload = new FormData();
      payload.append('post_id', postId || '');
      payload.append('title', title);
      payload.append('content', html);
      payload.append('excerpt', excerpt);
      payload.append('autosave', '1');
      const res = await fetch(autosaveUrl, { method:'POST', credentials:'same-origin', body: payload, headers: { 'X-CSRFToken': getCSRFToken() } });
      const j = await res.json();
      if (j.success){
        lastSavedAt = new Date().toISOString();
        // update UI
        let el = root.querySelector('.tiptap-help .autosave-status');
        if (!el){
          el = document.createElement('span'); el.className='autosave-status'; el.style.marginLeft='8px';
          root.querySelector('.tiptap-help').appendChild(el);
        }
        el.textContent = 'Autosaved at ' + (new Date()).toLocaleTimeString();
      }
    } catch (e){
      console.error('autosave error', e);
    }
  }

  // Load TipTap modules (StarterKit + Table + Link + Image + CodeBlockLowlight + Placeholder + CharacterCount + HardBreak + TaskList + BubbleMenu)
  try {
    const [{ Editor }, StarterKitModule, LinkModule, ImageModule, PlaceholderModule, CharacterCountModule, UnderlineModule, HistoryModule, TableModule, TableRowModule, TableCellModule, TableHeaderModule, CodeBlockLowlightModule] = await Promise.all([
      import('https://esm.sh/@tiptap/core'),
      import('https://esm.sh/@tiptap/starter-kit'),
      import('https://esm.sh/@tiptap/extension-link'),
      import('https://esm.sh/@tiptap/extension-image'),
      import('https://esm.sh/@tiptap/extension-placeholder'),
      import('https://esm.sh/@tiptap/extension-character-count'),
      import('https://esm.sh/@tiptap/extension-underline'),
      import('https://esm.sh/@tiptap/extension-history'),
      import('https://esm.sh/@tiptap/extension-table'),
      import('https://esm.sh/@tiptap/extension-table-row'),
      import('https://esm.sh/@tiptap/extension-table-cell'),
      import('https://esm.sh/@tiptap/extension-table-header'),
      import('https://esm.sh/@tiptap/extension-code-block-lowlight'),
    ]);
    const StarterKit = StarterKitModule.default || StarterKitModule;
    const Link = LinkModule.default || LinkModule;
    const Image = ImageModule.default || ImageModule;
    const Placeholder = PlaceholderModule.default || PlaceholderModule;
    const CharacterCount = CharacterCountModule.default || CharacterCountModule;
    const Underline = UnderlineModule.default || UnderlineModule;
    const History = HistoryModule.default || HistoryModule;
    const Table = TableModule.default || TableModule;
    const TableRow = TableRowModule.default || TableRowModule;
    const TableCell = TableCellModule.default || TableCellModule;
    const TableHeader = TableHeaderModule.default || TableHeaderModule;
    const CodeBlockLowlight = CodeBlockLowlightModule.default || CodeBlockLowlightModule;

    // lowlight for syntax highlighting
    let lowlight = null;
    try {
      const ll = await import('https://esm.sh/lowlight/lib/core');
      lowlight = ll.default || ll;
      try { lowlight.registerLanguage('javascript', (await import('https://esm.sh/highlight.js/lib/languages/javascript')).default); } catch(e){}
      try { lowlight.registerLanguage('python', (await import('https://esm.sh/highlight.js/lib/languages/python')).default); } catch(e){}
    } catch(e){ lowlight = null; }

    const extensions = [
      StarterKit(),
      Link.configure({ openOnClick:false }),
      Image.configure({ inline:false }),
      Placeholder.configure({ placeholder: 'Start typing...' }),
      CharacterCount.configure({ limit: 20000 }),
      Underline(),
      History(),
      Table.configure({ resizable: true }),
      TableRow(),
      TableCell(),
      TableHeader(),
      ...(CodeBlockLowlight && lowlight ? [ CodeBlockLowlight.configure({ lowlight }) ] : []),
    ];

    const editor = new Editor({
      element: editorEl,
      extensions,
      content: textarea.value && textarea.value.trim() ? textarea.value : '<p></p>',
      onUpdate: ({ editor }) => { textarea.value = editor.getHTML(); }
    });

    // toolbar commands (add insert table and code)
    toolbar.addEventListener('click', async function(e){
      const btn = e.target.closest('button'); if(!btn) return;
      const cmd = btn.getAttribute('data-cmd'); if(!cmd) return; e.preventDefault();
      switch(cmd){
        case 'insertTable':
          editor.chain().focus().insertTable({ rows:3, cols:3 }).run(); break;
        case 'insertCodeBlock':
          editor.chain().focus().toggleCodeBlock().run(); break;
        case 'insertEmbed':
          {
            const url = prompt('Paste embed URL (YouTube, Vimeo, etc.)');
            if(url){
              // simple iframe embed insertion - server MUST sanitize when saving
              editor.chain().focus().insertContent(`<div class="embed-wrapper"><iframe src="${url}" frameborder="0" allowfullscreen></iframe></div>`).run();
            }
          } break;
        default:
          // existing commands mapping
          // copied from earlier code: toggleBold, toggleItalic etc.
          if (cmd === 'toggleBold') editor.chain().focus().toggleBold().run();
          else if (cmd === 'toggleItalic') editor.chain().focus().toggleItalic().run();
          else if (cmd === 'toggleStrike') editor.chain().focus().toggleStrike().run();
          else if (cmd === 'toggleUnderline') editor.chain().focus().toggleUnderline().run();
          else if (cmd === 'toggleHeading1') editor.chain().focus().toggleHeading({ level:1 }).run();
          else if (cmd === 'toggleHeading2') editor.chain().focus().toggleHeading({ level:2 }).run();
          else if (cmd === 'toggleBulletList') editor.chain().focus().toggleBulletList().run();
          else if (cmd === 'toggleOrderedList') editor.chain().focus().toggleOrderedList().run();
          else if (cmd === 'toggleBlockquote') editor.chain().focus().toggleBlockquote().run();
          else if (cmd === 'toggleCodeBlock') editor.chain().focus().toggleCodeBlock().run();
          else if (cmd === 'setLink'){
            const url = prompt('Insert link (https://...)','https://'); if(url) editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
          } else if (cmd === 'unsetLink') editor.chain().focus().unsetLink().run();
          else if (cmd === 'undo') editor.chain().focus().undo().run();
          else if (cmd === 'redo') editor.chain().focus().redo().run();
          else if (cmd === 'uploadImage') uploadInput && uploadInput.click();
          break;
      }
    });

    // upload handler (drag/drop + input)
    uploadInput && uploadInput.addEventListener('change', async function(){
      const file = this.files && this.files[0]; if(!file) return;
      const fd = new FormData(); fd.append('file', file);
      try {
        const res = await fetch(uploadUrl, { method:'POST', body: fd, credentials: 'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() } });
        const json = await res.json();
        const url = json.url || (json.uploaded && json.uploaded[0] && json.uploaded[0].url) || null;
        if(url) editor.chain().focus().setImage({ src: url }).run();
        else alert('Upload did not return URL');
      } catch(e){ console.error(e); alert('Upload failed'); }
      this.value = '';
    });

    // drag & drop on editorEl
    editorEl.addEventListener('drop', async (ev)=>{
      ev.preventDefault();
      const file = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
      if (file){
        const fd = new FormData(); fd.append('file', file);
        try {
          const res = await fetch(uploadUrl, { method:'POST', body: fd, credentials: 'same-origin', headers:{ 'X-CSRFToken': getCSRFToken() } });
          const json = await res.json();
          const url = json.url || (json.uploaded && json.uploaded[0] && json.uploaded[0].url) || null;
          if (url) editor.chain().focus().setImage({ src: url }).run();
        } catch(e){ console.error('drop upload failed', e) }
      }
    });

    // selection update -> toolbar active states (as before)
    editor.on('selectionUpdate', () => {
      toolbar.querySelectorAll('button[data-cmd]').forEach(btn => {
        const cmd = btn.getAttribute('data-cmd');
        let active = false;
        try {
          if (cmd === 'toggleBold') active = editor.isActive('bold');
          else if (cmd === 'toggleItalic') active = editor.isActive('italic');
          else if (cmd === 'toggleStrike') active = editor.isActive('strike');
          else if (cmd === 'toggleUnderline') active = editor.isActive('underline');
          else if (cmd === 'toggleBulletList') active = editor.isActive('bulletList');
          else if (cmd === 'toggleOrderedList') active = editor.isActive('orderedList');
          else if (cmd === 'toggleHeading1') active = editor.isActive('heading', { level: 1 });
          else if (cmd === 'toggleHeading2') active = editor.isActive('heading', { level: 2 });
        } catch(e){ active = false; }
        btn.classList.toggle('active', !!active);
      });
    });

    // keyboard shortcuts
    editor.registerPlugin({
      props: {
        handleKeyDown(view, event) {
          if ((event.ctrlKey || event.metaKey) && !event.shiftKey) {
            if (event.key.toLowerCase() === 'b') { editor.chain().focus().toggleBold().run(); event.preventDefault(); return true; }
            if (event.key.toLowerCase() === 'i') { editor.chain().focus().toggleItalic().run(); event.preventDefault(); return true; }
            if (event.key.toLowerCase() === 'k') { 
              const url = prompt('Insert link (https://...)','https://'); if(url) editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run(); event.preventDefault(); return true;
            }
          }
          return false;
        }
      }
    });

    // periodic autosave
    const postIdElem = document.querySelector('input[name="id"]') || document.querySelector('[name="_post_id"]') || null;
    const postId = postIdElem ? postIdElem.value : null;
    if (postId){
      autosaveTimer = setInterval(()=>autosaveIfNeeded(postId), autosaveInterval);
    }

    // expose revisions modal opener to global (for admin button)
    window.openRevisionsPanel = showRevisionsModal;
    // expose preview opener (will request preview token via autosave to get ephemeral token)
    window.openPreviewForPost = async function(_postId){
      // call autosave endpoint as "preview" without necessarily creating a DB revision (just to generate a signed token)
      try {
        const payload = new FormData();
        payload.append('post_id', _postId);
        payload.append('title', document.querySelector('input[name="title"]') ? document.querySelector('input[name="title"]').value : '');
        payload.append('content', sanitizeHTML(editor.getHTML()));
        payload.append('excerpt', document.querySelector('textarea[name="excerpt"]') ? document.querySelector('textarea[name="excerpt"]').value : '');
        payload.append('autosave', '0');
        const res = await fetch(autosaveUrl, { method:'POST', credentials:'same-origin', body: payload, headers: { 'X-CSRFToken': getCSRFToken() }});
        const j = await res.json();
        if (j.preview_url) {
          window.open(j.preview_url, '_blank');
        } else if (j.preview_token) {
          window.open('/preview/' + j.preview_token, '_blank');
        } else alert('Preview failed');
      } catch(e){ console.error('preview error', e); alert('Preview failed'); }
    };

    // ensure textarea sync on submit
    const form = editorEl.closest('form');
    if (form) form.addEventListener('submit', ()=>{ textarea.value = sanitizeHTML(editor.getHTML()); });

    return;
  } catch(err){
    console.error('TipTap ESM import failed (advanced widget):', err);
    // fallback to basic contenteditable (as before)
    function sync(){ textarea.value = editorEl.innerHTML; }
    editorEl.addEventListener('blur', sync);
    editorEl.addEventListener('input', sync);
    if (textarea.value && !editorEl.innerHTML.trim()) editorEl.innerHTML = textarea.value;
    const form = editorEl.closest('form');
    if (form) form.addEventListener('submit', sync);
    return;
  }
})();
</script>
