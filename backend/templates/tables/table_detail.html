{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Календарь -->
    <div class="calendar-section">
        <h3>История прогресса</h3>
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month" class="calendar-nav-btn">‹</button>
                <h4 id="current-month"></h4>
                <button id="next-month" class="calendar-nav-btn">›</button>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Календарь будет заполнен JavaScript -->
            </div>
        </div>
    </div>

    <!-- Лепестковая диаграмма и таблица (существующий код) -->
    <div class="table-section">
        <!-- Ваша существующая лепестковая диаграмма и таблица -->
        <div id="radar-chart-container">
            <!-- Ваш существующий код диаграммы -->
        </div>
    </div>
</div>

<style>
/* Стили для календаря */
.calendar-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-container {
    max-width: 100%;
    margin: 0 auto;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 0 10px;
}

.calendar-nav-btn {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 16px;
}

.calendar-nav-btn:hover {
    background: #2563eb;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}

.calendar-day-header {
    text-align: center;
    font-weight: bold;
    padding: 8px;
    background: #f8fafc;
    border-radius: 4px;
}

.calendar-day {
    aspect-ratio: 1;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    min-height: 40px;
}

.calendar-day:hover {
    background: #f1f5f9;
}

.calendar-day.empty {
    background: #f8fafc;
    border: none;
    cursor: default;
}

.calendar-day.has-data {
    background: #eff6ff;
    border-color: #3b82f6;
}

.day-number {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 2px;
}

.day-progress {
    font-size: 10px;
    color: #64748b;
}

.progress-dots {
    display: flex;
    gap: 1px;
    margin-top: 2px;
}

.progress-dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: #94a3b8;
}

.progress-dot.filled {
    background: #10b981;
}

.calendar-popup {
    position: absolute;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
    min-width: 200px;
    display: none;
}

.calendar-popup.show {
    display: block;
}

.popup-date {
    font-weight: bold;
    margin-bottom: 8px;
    color: #1e293b;
}

.popup-categories {
    font-size: 12px;
}

.popup-category {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.category-name {
    color: #64748b;
}

.category-value {
    font-weight: 600;
    color: #1e293b;
}
</style>

<script>
class SimpleCalendar {
    constructor(containerId, tableId) {
        this.container = document.getElementById(containerId);
        this.tableId = tableId;
        this.currentDate = new Date();
        this.progressData = {};
        this.init();
    }

    init() {
        this.render();
        this.loadProgressData();
        this.bindEvents();
    }

    render() {
        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                           'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
        
        document.getElementById('current-month').textContent = 
            `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;

        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';

        // Заголовки дней недели
        const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        days.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendarGrid.appendChild(dayHeader);
        });

        // Дни месяца
        const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
        const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
        
        // Пустые ячейки до первого дня
        for (let i = 0; i < (firstDay.getDay() + 6) % 7; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendarGrid.appendChild(emptyDay);
        }

        // Дни месяца
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = this.formatDate(new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day));
            const dayData = this.progressData[dateStr];
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day' + (dayData ? ' has-data' : '');
            dayElement.dataset.date = dateStr;

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayElement.appendChild(dayNumber);

            if (dayData) {
                const progress = document.createElement('div');
                progress.className = 'day-progress';
                
                // Вычисляем средний прогресс
                const values = Object.values(dayData.data);
                const avgProgress = values.reduce((a, b) => a + parseInt(b), 0) / values.length;
                progress.textContent = Math.round(avgProgress) + '%';
                
                dayElement.appendChild(progress);

                // Добавляем точки прогресса
                const dots = document.createElement('div');
                dots.className = 'progress-dots';
                
                Object.values(dayData.data).slice(0, 3).forEach(value => {
                    const dot = document.createElement('div');
                    dot.className = `progress-dot ${parseInt(value) > 50 ? 'filled' : ''}`;
                    dots.appendChild(dot);
                });
                
                dayElement.appendChild(dots);
            }

            calendarGrid.appendChild(dayElement);
        }
    }

    formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    async loadProgressData() {
        try {
            const response = await fetch(`/api/tables/progress/?table=${this.tableId}`);
            const progressEntries = await response.json();
            
            this.progressData = {};
            progressEntries.forEach(entry => {
                this.progressData[entry.date] = entry;
            });
            
            this.render();
        } catch (error) {
            console.error('Error loading progress data:', error);
        }
    }

    bindEvents() {
        document.getElementById('prev-month').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.render();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.render();
        });

        // Обработчик клика по дням календаря
        document.getElementById('calendar-grid').addEventListener('click', (e) => {
            const dayElement = e.target.closest('.calendar-day');
            if (dayElement && dayElement.dataset.date) {
                this.showDayDetails(dayElement);
            }
        });
    }

    showDayDetails(dayElement) {
        // Удаляем существующее всплывающее окно
        const existingPopup = document.querySelector('.calendar-popup');
        if (existingPopup) {
            existingPopup.remove();
        }

        const date = dayElement.dataset.date;
        const dayData = this.progressData[date];
        
        if (!dayData) return;

        const popup = document.createElement('div');
        popup.className = 'calendar-popup show';
        
        const rect = dayElement.getBoundingClientRect();
        popup.style.top = (rect.bottom + window.scrollY) + 'px';
        popup.style.left = (rect.left + window.scrollX) + 'px';

        const dateStr = new Date(date).toLocaleDateString('ru-RU');
        popup.innerHTML = `
            <div class="popup-date">${dateStr}</div>
            <div class="popup-categories">
                ${Object.entries(dayData.data).map(([category, value]) => `
                    <div class="popup-category">
                        <span class="category-name">${category}:</span>
                        <span class="category-value">${value}%</span>
                    </div>
                `).join('')}
            </div>
        `;

        document.body.appendChild(popup);

        // Закрытие при клике вне окна
        setTimeout(() => {
            const closePopup = (e) => {
                if (!popup.contains(e.target) && !dayElement.contains(e.target)) {
                    popup.remove();
                    document.removeEventListener('click', closePopup);
                }
            };
            document.addEventListener('click', closePopup);
        }, 100);
    }
}

// Инициализация календаря при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Получаем ID таблицы из данных страницы или URL
    const tableId = '{{ table.id }}' || window.location.pathname.split('/').filter(Boolean).pop();
    if (tableId) {
        new SimpleCalendar('calendar-grid', tableId);
    }
});
</script>
{% endblock %}