{% extends "base.html" %}
{% load static %}

{% block title %}Календарь прогресса - {{ table.title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<link href="{% static 'tables/css/calendar.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <div>
            <h1 class="calendar-title">Календарь прогресса</h1>
            <p>Отслеживайте ваш прогресс по дням</p>
        </div>
        <div class="calendar-controls">
            <div class="calendar-view-buttons">
                <button class="calendar-view-btn active" onclick="window.tableCalendar.changeView('dayGridMonth')">Месяц</button>
                <button class="calendar-view-btn" onclick="window.tableCalendar.changeView('timeGridWeek')">Неделя</button>
                <button class="calendar-view-btn" onclick="window.tableCalendar.changeView('timeGridDay')">День</button>
            </div>
            <button class="calendar-nav-btn" onclick="window.refreshCalendar()">
                Обновить
            </button>
        </div>
    </div>

    <div class="calendar-content">
        <!-- Статистика -->
        <div class="calendar-stats" id="calendar-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-entries">—</div>
                <div class="stat-label">Всего записей</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-progress">—</div>
                <div class="stat-label">Средний прогресс</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="current-streak">—</div>
                <div class="stat-label">Текущая серия</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="best-streak">—</div>
                <div class="stat-label">Лучшая серия</div>
            </div>
        </div>

        <!-- Календарь -->
        <div id="calendar-container" data-table-id="{{ table.id|default:'' }}"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js"></script>
<script src="{% static 'tables/js/calendar.js' %}"></script>

<script>
// Загрузка статистики
document.addEventListener('DOMContentLoaded', function() {
    {% if table.id %}
    loadCalendarStats('{{ table.id }}');
    {% endif %}
});

async function loadCalendarStats(tableId) {
    try {
        const response = await fetch(`/api/tables/calendar/stats/${tableId}/`);
        const stats = await response.json();
        
        // Обновляем статистику (здесь нужно адаптировать под вашу структуру данных)
        document.getElementById('total-entries').textContent = stats.total_entries || '0';
        document.getElementById('avg-progress').textContent = stats.avg_progress ? Math.round(stats.avg_progress) + '%' : '0%';
        document.getElementById('current-streak').textContent = stats.current_streak || '0';
        document.getElementById('best-streak').textContent = stats.best_streak || '0';
    } catch (error) {
        console.error('Error loading calendar stats:', error);
    }
}
</script>
{% endblock %}