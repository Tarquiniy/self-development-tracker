{% extends "admin/base_site.html" %}
{% load static %}

{# admin/dashboard.html — современный и безопасный дашборд #}

{% block title %}Админ — Панель управления{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
<script src="{% static 'admin/js/dashboard.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="pt-admin-dashboard container">
  <header class="pt-dash-header">
    <div>
      <h1>Панель управления</h1>
      <p class="muted">Быстрый доступ к статистике и созданию контента</p>
    </div>
    <div class="pt-dash-actions">
      <a class="btn btn-primary" href="{% url 'admin:blog_post_add' %}">Создать пост</a>
      <a class="btn btn-outline" href="{% url 'admin:blog_post_changelist' %}">Список постов</a>
      <a class="btn btn-outline" href="{% url 'admin-media-library' %}">Медиатека</a>
    </div>
  </header>

  <section class="pt-dash-counters">
    <div class="card counter">
      <div class="card-body">
        <div class="counter-value">{{ posts_count|default:0 }}</div>
        <div class="counter-label">Постов</div>
      </div>
    </div>
    <div class="card counter">
      <div class="card-body">
        <div class="counter-value">{{ comments_count|default:0 }}</div>
        <div class="counter-label">Комментариев</div>
      </div>
    </div>
    <div class="card counter">
      <div class="card-body">
        <div class="counter-value">{{ users_count|default:0 }}</div>
        <div class="counter-label">Пользователей</div>
      </div>
    </div>
  </section>

  <section class="pt-dash-main grid">
    <div class="card area">
      <div class="card-header"><strong>Активность (последние {{ days|default:30 }} дней)</strong></div>
      <div class="card-body">
        <canvas id="pt-stats-chart" height="140" aria-label="График активности"></canvas>
      </div>
    </div>

    <div class="card area">
      <div class="card-header"><strong>Последние посты</strong></div>
      <div class="card-body">
        {% if recent_posts %}
          <ul class="recent-posts">
            {% for p in recent_posts %}
              <li>
                <a href="{% url 'admin:blog_post_change' p.pk %}">{{ p.title|default:"(без названия)" }}</a>
                <div class="meta">{{ p.author }} • {{ p.published_at|date:"Y-m-d H:i" }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">Нет последних постов.</p>
        {% endif %}
      </div>
    </div>
  </section>
</div>

{# Передаём данные в JS безопасно #}
{{ labels|default:"[]"|json_script:"pt-dashboard-labels" }}
{{ posts|default:"[]"|json_script:"pt-dashboard-posts" }}
{{ comments|default:"[]"|json_script:"pt-dashboard-comments" }}
{{ views|default:"[]"|json_script:"pt-dashboard-views" }}
{% endblock %}