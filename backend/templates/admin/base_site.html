{% extends "admin/base.html" %}
{% load static i18n %}

{# Исправленный шаблон — НЕ использует имена переменных с ведущим подчёркиванием. #}

{% block extrahead %}
<script>
(function(){
  function ensureDollar(){
    try {
      if (window.jQuery) {
        if (!window.$) window.$ = window.jQuery;
        return true;
      }
    } catch(e){}
    return false;
  }
  if (!ensureDollar()) {
    var tries = 0;
    var t = setInterval(function(){
      if (ensureDollar() || ++tries > 200) clearInterval(t);
    }, 25);
  }
})();
</script>

<style>
/* Стили для заметной кнопки медиатеки */
.media-lib-btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  background: #0d6efd;
  color: #fff !important;
  text-decoration: none;
  padding: 9px 12px;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 1px 0 rgba(0,0,0,0.06);
  line-height: 1;
  font-size: 14px;
}
.media-lib-btn.sidebar {
  display: block;
  width: calc(100% - 16px);
  text-align: left;
  padding-left: 14px;
  margin: 6px 8px;
}
.media-lib-btn svg { vertical-align: middle; }
.media-lib-btn:focus, .media-lib-btn:hover { opacity: 0.95; text-decoration: none; }
</style>

{{ block.super }}
{% endblock extrahead %}

{% block contenttitle %}
  {{ block.super }}
  {# Верхняя (резервная) кнопка медиатеки — будет видна, если боковая вставка не сработает #}
  {% url 'admin-media-library' as media_url %}
  <div style="margin-top:8px;">
    <a id="media_lib_top" class="media-lib-btn" href="{% if media_url %}{{ media_url }}{% else %}/admin/media-library/{% endif %}" title="{% trans 'Открыть медиабиблиотеку' %}">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;margin-right:6px" aria-hidden="true"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 13l2.5 3 2-2.5L15 17" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>{% trans "Медиа библиотека" %}</span>
    </a>
  </div>
{% endblock contenttitle %}

{% block extrafooter %}
{{ block.super }}
<script>
(function(){
  // пробуем получить href медиатеки из верхней кнопки
  var mediaHref = (function(){
    var top = document.getElementById('media_lib_top');
    if (top && top.getAttribute) return top.getAttribute('href') || '/admin/media-library/';
    return '/admin/media-library/';
  })();

  function makeButton(sidebarStyle){
    var a = document.createElement('a');
    a.className = 'media-lib-btn' + (sidebarStyle ? ' sidebar' : '');
    a.setAttribute('href', mediaHref);
    a.setAttribute('title', 'Открыть медиабиблиотеку');
    a.setAttribute('aria-label','Медиа библиотека');
    a.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="vertical-align:middle;margin-right:6px;"><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 13l2.5 3 2-2.5L15 17" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg><span style="vertical-align:middle;">Медиа библиотека</span>';
    return a;
  }

  function alreadyExists(container){
    if(!container) return false;
    var links = container.querySelectorAll('a.media-lib-btn, a[href*="media-library"]');
    return links && links.length > 0;
  }

  function tryInsert(){
    var selectors = [
      '#nav-sidebar',
      '.app-list',
      '.module',
      '.grp-module',
      '.sidebar',
      '.nav-sidebar',
      '.col-side',
      '.sidenav',
      '#user-tools',
      '.model-list',
      '.admindoc'
    ];
    for (var i=0;i<selectors.length;i++){
      var sel = selectors[i];
      var el = document.querySelector(sel);
      if (!el) continue;
      if (alreadyExists(el)) return true;
      try {
        var btn = makeButton(true);
        if (el.firstElementChild) el.insertBefore(btn, el.firstElementChild);
        else el.appendChild(btn);
        return true;
      } catch(e){
        continue;
      }
    }

    // fallback: поиск по тексту "Админпанель" или "Панель"
    var anchors = Array.prototype.slice.call(document.querySelectorAll('a, button, div, span'));
    for (var j=0;j<anchors.length;j++){
      var node = anchors[j];
      if (!node || !node.textContent) continue;
      var txt = node.textContent.trim();
      if (!txt) continue;
      if (/Админпанель|Панель|Dashboard/i.test(txt)) {
        if (node.parentNode && !alreadyExists(node.parentNode)) {
          try {
            var btn2 = makeButton(true);
            node.parentNode.insertBefore(btn2, node.nextSibling);
            return true;
          } catch(e){}
        }
      }
    }

    return false;
  }

  document.addEventListener('DOMContentLoaded', function(){
    tryInsert();
    setTimeout(tryInsert, 120);
    setTimeout(tryInsert, 700);
  });
})();
</script>
{% endblock extrafooter %}
