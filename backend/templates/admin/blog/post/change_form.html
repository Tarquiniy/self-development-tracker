{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tiptap/extension-text-style@2/dist/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tiptap/core@2/dist/style.css">

    <style>
        .editor-wrapper {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            margin-top: 16px;
        }
        .editor-main {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .editor-sidebar {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }
        .editor-toolbar button {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .editor-toolbar button.active {
            background: #0ea5e9;
            color: white;
        }
        .editor-content {
            min-height: 300px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .seo-box, .publish-box, .meta-box {
            background: white;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .seo-box input, .seo-box textarea {
            width: 100%;
            margin-top: 6px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .post-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            background: #f8fafc;
            margin-top: 12px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="editor-wrapper">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
    <div class="editor-main">
        <div class="editor-toolbar" id="editor-toolbar"></div>
        <div id="editor-content" class="editor-content"></div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="editor-sidebar">
        <!-- SEO -->
        <div class="seo-box">
            <h3>SEO</h3>
            <label>Slug:</label>
            <input type="text" name="slug" id="id_slug" value="{{ original.slug|default:'' }}">
            <label>–ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea name="meta_description" rows="3">{{ original.meta_description|default:'' }}</textarea>
            <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</label>
            <input type="text" name="meta_keywords" value="{{ original.meta_keywords|default:'' }}">
        </div>

        <!-- –ü—É–±–ª–∏–∫–∞—Ü–∏—è -->
        <div class="publish-box">
            <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
            <p>–°—Ç–∞—Ç—É—Å: 
                <select name="status">
                    <option value="draft" {% if original.status == "draft" %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                    <option value="published" {% if original.status == "published" %}selected{% endif %}>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</option>
                    <option value="archived" {% if original.status == "archived" %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
                </select>
            </p>
            <p>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: <input type="datetime-local" name="published_at" value="{{ original.published_at|date:'Y-m-d\TH:i' }}"></p>
            <button type="submit" class="default">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <!-- –ú–µ—Ç–∞ -->
        <div class="meta-box">
            <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–≥–∏</h3>
            {{ adminform.form.categories }}
            {{ adminform.form.tags }}
        </div>

        <!-- –ü—Ä–µ–≤—å—é -->
        <div class="meta-box">
            <h3>–ü—Ä–µ–≤—å—é –ø–æ—Å—Ç–∞</h3>
            <div id="post-preview" class="post-preview">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–≤—å—é...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_extra %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/@tiptap/core@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const { Editor } = window['@tiptap/core'];
    const StarterKit = window['@tiptap/starter-kit'].StarterKit;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    const editor = new Editor({
        element: document.querySelector('#editor-content'),
        extensions: [StarterKit],
        content: `{{ original.content|default:""|escapejs }}`,
        onUpdate: ({ editor }) => {
            document.querySelector('#post-preview').innerHTML = editor.getHTML();
        }
    });

    // Toolbar
    const toolbar = document.getElementById("editor-toolbar");
    const buttons = [
        {cmd: 'toggleBold', label: 'B'},
        {cmd: 'toggleItalic', label: 'I'},
        {cmd: 'toggleStrike', label: 'S'},
        {cmd: 'toggleBulletList', label: '‚Ä¢ —Å–ø–∏—Å–æ–∫'},
        {cmd: 'toggleOrderedList', label: '1. —Å–ø–∏—Å–æ–∫'},
        {cmd: 'toggleBlockquote', label: '‚Äú —Ü–∏—Ç–∞—Ç–∞'},
        {cmd: 'toggleCodeBlock', label: '</>'},
    ];

    buttons.forEach(b => {
        const btn = document.createElement("button");
        btn.innerText = b.label;
        btn.onclick = () => {
            editor.chain().focus()[b.cmd]().run();
            updateToolbar();
        };
        toolbar.appendChild(btn);
    });

    function updateToolbar() {
        toolbar.querySelectorAll("button").forEach((btn, i) => {
            const cmd = buttons[i].cmd.replace("toggle","").toLowerCase();
            btn.classList.toggle("active", editor.isActive(cmd));
        });
    }

    editor.on('selectionUpdate', updateToolbar);

    // Ctrl+S = —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    document.addEventListener("keydown", e => {
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
            e.preventDefault();
            document.querySelector("form").submit();
        }
    });
});
</script>
{% endblock %}
