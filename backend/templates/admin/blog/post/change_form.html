{# backend/templates/admin/blog/post/change_form.html - REPLACE ENTIRE FILE #}
{% extends "admin/change_form.html" %}
{% load static i18n %}

{# Подключаем наши стили/скрипты через стандартные блоки админки. #}
{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
{% endblock %}

{% block content %}
    {{ block.super }}
{% endblock %}

{# вставляем безопасный JS внизу страницы (после загрузки админ-формы) #}
{% block footer_extra %}
    {{ block.super }}
    <script>
    (function () {
        'use strict';

        // Защита от ReferenceError 'grp is not defined' — если где-то на странице используется grp.
        if (typeof grp === 'undefined') {
            window.grp = null;
        }

        // Текущий post id — null если создаём новый объект (add view)
        var CURRENT_POST_ID = {% if object %}{{ object.id }}{% else %}null{% endif %};
        window.ADMIN_CURRENT_POST_ID = CURRENT_POST_ID;

        // Вспомогательная функция: получить CSRF-token из cookie (Django default)
        function getCsrf() {
            var m = document.cookie.match(/(^|;)\\s*csrftoken=([^;]+)/);
            return m ? decodeURIComponent(m[2]) : '';
        }

        // Отправка запроса привязки attachment -> post
        function attachToPost(attachmentId, postId) {
            if (!attachmentId) return Promise.resolve(null);
            if (!postId) return Promise.resolve(null);

            return fetch('/api/blog/media/attach/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrf()
                },
                body: JSON.stringify({
                    attachment_id: Number(attachmentId),
                    post_id: Number(postId)
                })
            }).then(function (r) {
                if (!r.ok) return r.json().catch(function(){return {success:false, status:r.status};});
                return r.json();
            }).catch(function (err) {
                console.error('attachToPost network error', err);
                return { success: false, message: 'network error' };
            });
        }

        // Обработчик сообщений от медиатеки
        window.addEventListener('message', function (ev) {
            try {
                var data = ev.data;
                if (!data || data.source !== 'media-library' || data.action !== 'select') {
                    return;
                }
                var att = data.attachment;
                if (!att) return;

                // Если есть поле featured_image — заполняем его
                try {
                    var featuredInput = document.querySelector('input[name="featured_image"]');
                    if (featuredInput) {
                        featuredInput.value = att.url || '';
                        // генерируем событие change (некоторые виджеты могут слушать)
                        var evt;
                        try { evt = new Event('change', { bubbles: true }); } catch(e) { evt = document.createEvent('HTMLEvents'); evt.initEvent('change', true, false); }
                        featuredInput.dispatchEvent(evt);
                    }
                } catch (e) {
                    console.warn('Error setting featured_image value', e);
                }

                // Обновляем превью, если такой контейнер есть в шаблоне
                try {
                    var preview = document.getElementById('featured-image-preview');
                    if (preview && att.url) {
                        preview.innerHTML = '<img src="' + att.url + '" alt="" style="max-width:100%;height:auto;object-fit:cover;border-radius:6px;">';
                    }
                } catch (e) { /* ignore */ }

                // Если у записи уже есть id -> прикрепляем немедленно
                if (CURRENT_POST_ID) {
                    attachToPost(att.id, CURRENT_POST_ID).then(function (resp) {
                        if (resp && resp.success) {
                            console.log('Attachment attached immediately', resp);
                        } else {
                            console.warn('Immediate attach failed', resp);
                        }
                    });
                } else {
                    // Если мы создаём новый пост — сохраняем в localStorage для автопривязки после сохранения поста
                    try {
                        localStorage.setItem('pending_attachment_id', String(att.id));
                        if (att.url) localStorage.setItem('pending_attachment_url', att.url);
                        // дополнительный маркер для debug
                        localStorage.setItem('pending_attachment_saved_at', String(Date.now()));
                        console.log('Saved pending attachment to localStorage', att.id);
                    } catch (e) {
                        console.warn('localStorage not available', e);
                    }
                }
            } catch (err) {
                console.error('media-library message handler error', err);
            }
        }, false);

        // При загрузке страницы: если у нас есть pending_attachment и текущий post id - выполнить привязку
        document.addEventListener('DOMContentLoaded', function () {
            try {
                var pending = null;
                try { pending = localStorage.getItem('pending_attachment_id'); } catch(e){ pending = null; }
                var pendingUrl = null;
                try { pendingUrl = localStorage.getItem('pending_attachment_url'); } catch(e){ pendingUrl = null; }
                if (pending && CURRENT_POST_ID) {
                    // привязываем и очищаем маркеры
                    attachToPost(Number(pending), Number(CURRENT_POST_ID)).then(function (resp) {
                        if (resp && resp.success) {
                            console.log('Pending attachment attached after save', resp);
                            try { localStorage.removeItem('pending_attachment_id'); localStorage.removeItem('pending_attachment_url'); localStorage.removeItem('pending_attachment_saved_at'); } catch(e){}
                        } else {
                            console.warn('Failed to attach pending attachment', resp);
                        }
                    });
                    // установим значение featured_image если нужно
                    if (pendingUrl) {
                        var featuredInput = document.querySelector('input[name="featured_image"]');
                        if (featuredInput) featuredInput.value = pendingUrl;
                    }
                }
            } catch (e) {
                console.error('post-load pending attach handler error', e);
            }
        });

        // Защита: при выгрузке страницы удаляем устаревшие маркеры старше 10 минут
        (function cleanupOldPending() {
            try {
                var ts = localStorage.getItem('pending_attachment_saved_at');
                if (!ts) return;
                var age = Date.now() - Number(ts || 0);
                if (age > 1000 * 60 * 10) { // 10 минут
                    try { localStorage.removeItem('pending_attachment_id'); localStorage.removeItem('pending_attachment_url'); localStorage.removeItem('pending_attachment_saved_at'); } catch (e) {}
                }
            } catch (e) {}
        })();

    })();
    </script>
{% endblock %}
