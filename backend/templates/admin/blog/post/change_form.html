{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
  {{ block.super }}

  <link rel="stylesheet" href="{% static 'admin/css/admin-post-form.css' %}">

  {# CKEditor #}
  <script src="https://cdn.ckeditor.com/4.21.0/standard-all/ckeditor.js"></script>
  <script src="{% static 'admin/js/ckeditor_admin_extra.js' %}"></script>

  <style>
    .ck-editor__editable_inline {
      min-height:260px;
      background:#fff;
      color:#0f1724;
      border-radius:6px;
      padding:12px;
      border:1px solid #e6eef3;
    }
    .action-extra { margin-left:8px; }
    .featured-preview {
      margin-top:8px;
      max-width:320px;
      display:block;
      border-radius:6px;
      border:1px solid #e6eef3;
    }
  </style>

  <script>
    (function(){

      function getPostId(){
        const m = window.location.pathname.match(/\/(\d+)\/change\/$/);
        if (m) return m[1];
        return null;
      }

      window.openMediaLibrary = function(e){
        if(e) e.preventDefault();

        const postId = getPostId();
        let url = "{% url 'admin-media-library' %}";

        if (postId) {
          url += "?select=1&field=featured_image";
        }

        window.open(url, 'media-library', 'width=1100,height=750');
        return false;
      };

      // Получение выбранного изображения из медиабиблиотеки
      window.addEventListener('message', function(ev){
        const msg = ev.data;
        if (!msg || msg.type !== 'media-selected') return;

        const imageUrl = msg.url;
        if (!imageUrl) return;

        const input =
          document.getElementById('id_featured_image') ||
          document.querySelector('input[name="featured_image"]');

        if (input) input.value = imageUrl;

        let preview = document.getElementById('featured_image_preview');
        if (!preview) {
          preview = document.createElement('img');
          preview.id = 'featured_image_preview';
          preview.className = 'featured-preview';
          input.parentNode.appendChild(preview);
        }
        preview.src = imageUrl;

      }, false);

    })();
  </script>
{% endblock %}

{% block submit_buttons_top %}
  {{ block.super }}
  <a href="#" class="button action-extra"
     onclick="return openMediaLibrary(event)">
    {% trans "Медиатека" %}
  </a>
{% endblock %}

{% block content %}
  {{ block.super }}
{% endblock %}
