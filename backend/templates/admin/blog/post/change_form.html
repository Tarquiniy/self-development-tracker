{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/post-edit-modern.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="post-edit-modern">
    <!-- –•–µ–¥–µ—Ä -->
    <header class="post-edit-header">
        <div class="header-content">
            <h1>
                {% if original %}
                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞: {{ original.title }}
                {% else %}
                    üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
                {% endif %}
            </h1>
            <div class="header-actions">
                {% if original %}
                <a href="{{ original.get_absolute_url }}" target="_blank" class="btn btn-outline">
                    üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                </a>
                {% endif %}
                <button type="submit" class="btn btn-primary" name="_save">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="submit" class="btn btn-secondary" name="_continue">
                    üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                </button>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
        <div class="status-bar">
            <div class="status-item">
                <span class="label">–°—Ç–∞—Ç—É—Å:</span>
                <span class="value status-{{ original.status|default:'draft' }}">
                    {{ original.get_status_display|default:"–ß–µ—Ä–Ω–æ–≤–∏–∫" }}
                </span>
            </div>
            <div class="status-item">
                <span class="label">–ê–≤—Ç–æ—Ä:</span>
                <span class="value">{{ user.get_full_name|default:user.username }}</span>
            </div>
            {% if original %}
            <div class="status-item">
                <span class="label">–°–æ–∑–¥–∞–Ω:</span>
                <span class="value">{{ original.created_at|date:"d.m.Y H:i" }}</span>
            </div>
            <div class="status-item">
                <span class="label">–û–±–Ω–æ–≤–ª–µ–Ω:</span>
                <span class="value">{{ original.updated_at|date:"d.m.Y H:i" }}</span>
            </div>
            {% endif %}
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="post-edit-layout">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ SLUG -->
            <div class="card">
                <div class="card-header">
                    <h3>üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞</label>
                        {{ adminform.form.title }}
                        <div class="char-counter" id="title-counter">0/255</div>
                    </div>
                    <div class="form-row">
                        <label for="id_slug">URL-–∞–¥—Ä–µ—Å (SLUG)</label>
                        {{ adminform.form.slug }}
                        <div class="help-text">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞</div>
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="card">
                <div class="card-header">
                    <h3>üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</h3>
                    <div class="content-stats">
                        <span id="word-count">0 —Å–ª–æ–≤</span>
                        <span id="read-time">~0 –º–∏–Ω —á—Ç–µ–Ω–∏—è</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_excerpt">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                        {{ adminform.form.excerpt }}
                        <div class="char-counter" id="excerpt-counter">0 —Å–∏–º–≤–æ–ª–æ–≤</div>
                    </div>
                    <div class="form-row">
                        <label for="id_content">–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç</label>
                        {{ adminform.form.content }}
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="sidebar">
            <!-- –ü—É–±–ª–∏–∫–∞—Ü–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h3>üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_status">–°—Ç–∞—Ç—É—Å</label>
                        {{ adminform.form.status }}
                    </div>
                    <div class="form-row">
                        <label for="id_published_at">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                        {{ adminform.form.published_at }}
                    </div>
                    <div class="form-row">
                        <label for="id_author">–ê–≤—Ç–æ—Ä</label>
                        {{ adminform.form.author }}
                    </div>
                    <div class="quick-actions">
                        <button type="submit" class="btn-action btn-publish" name="_publish">
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å
                        </button>
                        <button type="submit" class="btn-action btn-draft" name="_draft">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
                        </button>
                    </div>
                </div>
            </div>

            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
            <div class="card">
                <div class="card-header">
                    <h3>üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_featured_image">–ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        {{ adminform.form.featured_image }}
                        <div class="image-preview" id="featured-image-preview"></div>
                    </div>
                    <div class="form-row">
                        <label for="id_og_image">OG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        {{ adminform.form.og_image }}
                        <div class="image-preview" id="og-image-preview"></div>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–≥–∏ -->
            <div class="card">
                <div class="card-header">
                    <h3>üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
                        {{ adminform.form.categories }}
                    </div>
                    <div class="form-row">
                        <label for="id_tags">–¢–µ–≥–∏</label>
                        {{ adminform.form.tags }}
                    </div>
                </div>
            </div>

            <!-- SEO -->
            <div class="card">
                <div class="card-header">
                    <h3>üîç SEO –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <label for="id_meta_title">–ú–µ—Ç–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        {{ adminform.form.meta_title }}
                        <div class="char-counter" id="meta-title-counter">0/60</div>
                    </div>
                    <div class="form-row">
                        <label for="id_meta_description">–ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ</label>
                        {{ adminform.form.meta_description }}
                        <div class="char-counter" id="meta-description-counter">0/160</div>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            {% if original %}
            <div class="card">
                <div class="card-header">
                    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                </div>
                <div class="card-body">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ original.views.count }}</div>
                            <div class="stat-label">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">
                                {% with reactions=original.reactions.first %}
                                    {{ reactions.likes_count|default:0 }}
                                {% endwith %}
                            </div>
                            <div class="stat-label">–õ–∞–π–∫–æ–≤</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ original.comments.count }}</div>
                            <div class="stat-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
    {% for fieldset in adminform %}
        {% for line in fieldset %}
            {% for field in line %}
                {% if field.is_hidden %}
                    {{ field.field }}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}
    
    {% block inline_field_sets %}
    {% for inline_admin_formset in inline_admin_formsets %}
        {% include inline_admin_formset.opts.template %}
    {% endfor %}
    {% endblock %}

    {% block after_related_objects %}{% endblock %}

    {% block submit_buttons_bottom %}
    <div class="submit-row">
        <div class="submit-actions">
            <button type="submit" class="btn btn-primary" name="_save">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
            <button type="submit" class="btn btn-secondary" name="_continue">
                üìã –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
            <button type="submit" class="btn btn-outline" name="_addanother">
                ‚ûï –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
            </button>
            {% if original %}
            <a href="{% url 'admin:blog_post_delete' original.pk %}" class="btn btn-danger">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </a>
            {% endif %}
        </div>
    </div>
    {% endblock %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –°—á–µ—Ç—á–∏–∫–∏ —Å–∏–º–≤–æ–ª–æ–≤
    function setupCharCounter(textareaId, counterId, maxLength) {
        const textarea = document.getElementById(textareaId);
        const counter = document.getElementById(counterId);
        
        if (textarea && counter) {
            function updateCounter() {
                const length = textarea.value.length;
                counter.textContent = `${length}/${maxLength}`;
                
                if (length > maxLength * 0.9) {
                    counter.style.color = '#dc3545';
                } else if (length > maxLength * 0.7) {
                    counter.style.color = '#ffc107';
                } else {
                    counter.style.color = '#6c757d';
                }
            }
            
            textarea.addEventListener('input', updateCounter);
            updateCounter();
        }
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤
    setupCharCounter('id_title', 'title-counter', 255);
    setupCharCounter('id_excerpt', 'excerpt-counter', 500);
    setupCharCounter('id_meta_title', 'meta-title-counter', 60);
    setupCharCounter('id_meta_description', 'meta-description-counter', 160);
    
    // –ü–æ–¥—Å—á–µ—Ç —Å–ª–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ —á—Ç–µ–Ω–∏—è
    const contentField = document.getElementById('id_content');
    const wordCount = document.getElementById('word-count');
    const readTime = document.getElementById('read-time');
    
    if (contentField && wordCount && readTime) {
        function updateContentStats() {
            const text = contentField.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const readingTime = Math.ceil(words / 200);
            
            wordCount.textContent = `${words} —Å–ª–æ–≤`;
            readTime.textContent = `~${readingTime} –º–∏–Ω —á—Ç–µ–Ω–∏—è`;
        }
        
        contentField.addEventListener('input', updateContentStats);
        updateContentStats();
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    function setupImagePreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        
        if (input && preview) {
            function updatePreview() {
                const url = input.value;
                if (url) {
                    preview.innerHTML = `<img src="${url}" alt="Preview" style="max-width: 100%; border-radius: 8px; margin-top: 8px;">`;
                } else {
                    preview.innerHTML = '';
                }
            }
            
            input.addEventListener('input', updatePreview);
            updatePreview();
        }
    }
    
    setupImagePreview('id_featured_image', 'featured-image-preview');
    setupImagePreview('id_og_image', 'og-image-preview');
    
    // –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    const publishBtn = document.querySelector('.btn-publish');
    const draftBtn = document.querySelector('.btn-draft');
    
    if (publishBtn) {
        publishBtn.addEventListener('click', function(e) {
            document.getElementById('id_status').value = 'published';
        });
    }
    
    if (draftBtn) {
        draftBtn.addEventListener('click', function(e) {
            document.getElementById('id_status').value = 'draft';
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ meta title
    const titleField = document.getElementById('id_title');
    const metaTitleField = document.getElementById('id_meta_title');
    
    if (titleField && metaTitleField) {
        titleField.addEventListener('blur', function() {
            if (!metaTitleField.value) {
                metaTitleField.value = titleField.value;
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                const event = new Event('input');
                metaTitleField.dispatchEvent(event);
            }
        });
    }
});
</script>
{% endblock %}