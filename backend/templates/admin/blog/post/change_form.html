{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tiptap/core@2/dist/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tiptap/extension-text-style@2/dist/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

    <style>
        .editor-wrapper {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 20px;
            margin-top: 16px;
        }
        .editor-main {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        .editor-toolbar button {
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            background: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .editor-toolbar button.active {
            background: #0ea5e9;
            color: white;
        }
        .editor-content {
            min-height: 400px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .sidebar-box {
            background: white;
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
            margin-bottom: 14px;
        }
        .sidebar-box input, .sidebar-box textarea, .sidebar-box select {
            width: 100%;
            margin-top: 6px;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .post-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            background: #f8fafc;
            margin-top: 12px;
            max-height: 200px;
            overflow: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="editor-wrapper">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
    <div class="editor-main">
        <div class="editor-toolbar" id="editor-toolbar"></div>
        <div id="editor-content" class="editor-content"></div>
    </div>

    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div>
        <div class="sidebar-box">
            <h3>SEO</h3>
            <label>Slug:</label>
            <input type="text" name="slug" id="id_slug" value="{{ original.slug|default:'' }}">
            <label>–ú–µ—Ç–∞-–æ–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea name="meta_description" rows="3" maxlength="160">{{ original.meta_description|default:'' }}</textarea>
            <small id="meta-count"></small>
            <label>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</label>
            <input type="text" name="meta_keywords" value="{{ original.meta_keywords|default:'' }}">
        </div>

        <div class="sidebar-box">
            <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select name="status">
                <option value="draft" {% if original.status == "draft" %}selected{% endif %}>–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                <option value="published" {% if original.status == "published" %}selected{% endif %}>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω</option>
                <option value="archived" {% if original.status == "archived" %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
            </select>
            <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</label>
            <input type="datetime-local" name="published_at" value="{{ original.published_at|date:'Y-m-d\TH:i' }}">
            <button type="submit" class="default">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>

        <div class="sidebar-box">
            <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–≥–∏</h3>
            {{ adminform.form.categories }}
            {{ adminform.form.tags }}
        </div>

        <div class="sidebar-box">
            <h3>–ü—Ä–µ–≤—å—é –ø–æ—Å—Ç–∞</h3>
            <div id="post-preview" class="post-preview">–ù–∞—á–Ω–∏—Ç–µ –ø–µ—á–∞—Ç–∞—Ç—å...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_extra %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/@tiptap/core@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/starter-kit@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-link@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-table@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-highlight@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-color@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tiptap/extension-text-style@2"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/index.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const { Editor } = window['@tiptap/core'];
    const StarterKit = window['@tiptap/starter-kit'].StarterKit;
    const Link = window['@tiptap/extension-link'].default;
    const Table = window['@tiptap/extension-table'].default;
    const Highlight = window['@tiptap/extension-highlight'].default;
    const TextStyle = window['@tiptap/extension-text-style'].default;
    const Color = window['@tiptap/extension-color'].default;

    const editor = new Editor({
        element: document.querySelector('#editor-content'),
        extensions: [StarterKit, Link, Table, Highlight, TextStyle, Color],
        content: `{{ original.content|default:""|escapejs }}`,
        onUpdate: ({ editor }) => {
            document.querySelector('#post-preview').innerHTML = editor.getHTML();
            localStorage.setItem("draft_autosave", editor.getHTML());
        }
    });

    // Toolbar
    const toolbar = document.getElementById("editor-toolbar");
    const buttons = [
        {cmd:'toggleBold',label:'B'},
        {cmd:'toggleItalic',label:'I'},
        {cmd:'toggleStrike',label:'S'},
        {cmd:'toggleUnderline',label:'U'},
        {cmd:'toggleHeading',opts:{level:2},label:'H2'},
        {cmd:'toggleHeading',opts:{level:3},label:'H3'},
        {cmd:'toggleBulletList',label:'‚Ä¢ —Å–ø–∏—Å–æ–∫'},
        {cmd:'toggleOrderedList',label:'1. —Å–ø–∏—Å–æ–∫'},
        {cmd:'toggleBlockquote',label:'‚Äú —Ü–∏—Ç–∞—Ç–∞'},
        {cmd:'toggleCodeBlock',label:'</>'},
        {cmd:'setHorizontalRule',label:'‚Äî HR'},
        {cmd:'toggleHighlight',label:'‚ßâ –ø–æ–¥—Å–≤–µ—Ç–∫–∞'},
        {cmd:'setColor',opts:'#ef4444',label:'–ö—Ä–∞—Å–Ω—ã–π'},
        {cmd:'setColor',opts:'#10b981',label:'–ó–µ–ª—ë–Ω—ã–π'},
        {cmd:'setColor',opts:'#3b82f6',label:'–°–∏–Ω–∏–π'}
    ];

    buttons.forEach(b=>{
        const btn=document.createElement("button");
        btn.innerText=b.label;
        btn.onclick=()=>{ editor.chain().focus()[b.cmd](b.opts||{}).run(); };
        toolbar.appendChild(btn);
    });

    // –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    const saved = localStorage.getItem("draft_autosave");
    if(saved && !editor.getHTML().trim()){
        editor.commands.setContent(saved);
    }

    // Ctrl+S = —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    document.addEventListener("keydown", e=>{
        if((e.ctrlKey||e.metaKey)&&e.key==="s"){
            e.preventDefault();
            document.querySelector("form").submit();
        }
    });

    // SEO —Å—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
    const metaField=document.querySelector("textarea[name=meta_description]");
    const metaCount=document.getElementById("meta-count");
    function updateMeta(){
        metaCount.textContent=`${metaField.value.length}/160`;
        metaCount.style.color=metaField.value.length>160?"red":"#6b7280";
    }
    metaField.addEventListener("input",updateMeta);
    updateMeta();
});
</script>
{% endblock %}
