{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
:root {
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --primary-light: #818cf8;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --radius: 8px;
  --radius-lg: 12px;
}

/* Modern reset and base styles */
.post-editor-modern {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  color: var(--gray-800);
  background: var(--gray-50);
  min-height: 100vh;
}

/* Header */
.editor-header {
  background: white;
  border-bottom: 1px solid var(--gray-200);
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 2rem;
}

.header-title h1 {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gray-900);
}

.header-actions {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

/* Main layout */
.editor-main {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 2rem;
  align-items: start;
}

/* Content area */
.content-area {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* Sidebar */
.sidebar-area {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  position: sticky;
  top: 100px;
}

/* Cards */
.editor-card {
  background: white;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  overflow: hidden;
  transition: box-shadow 0.2s ease;
}

.editor-card:hover {
  box-shadow: var(--shadow-md);
}

.card-header {
  padding: 1.25rem 1.5rem;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header h3 {
  margin: 0;
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-body {
  padding: 1.5rem;
}

/* Form elements */
.form-group {
  margin-bottom: 1.25rem;
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--gray-700);
  font-size: 0.875rem;
}

.form-input,
.form-textarea,
.form-select {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1.5px solid var(--gray-300);
  border-radius: var(--radius);
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: white;
  box-sizing: border-box;
}

.form-input:focus,
.form-textarea:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 80px;
  line-height: 1.5;
  font-family: inherit;
}

/* Title field special styling */
.title-field {
  font-size: 1.5rem !important;
  font-weight: 700;
  padding: 1rem 1.25rem !important;
  border: 2px solid var(--gray-300) !important;
}

.title-field:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1) !important;
}

/* Content editor */
.editor-container {
  border-radius: var(--radius-lg);
  overflow: hidden;
  border: 1.5px solid var(--gray-300);
  min-height: 500px;
}

.editor-container:focus-within {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  line-height: 1;
  box-sizing: border-box;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn-secondary {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--gray-200);
}

.btn-outline {
  background: transparent;
  border: 1.5px solid var(--gray-300);
  color: var(--gray-700);
}

.btn-outline:hover:not(:disabled) {
  background: var(--gray-50);
  border-color: var(--gray-400);
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.75rem;
}

/* Quick actions */
.quick-actions {
  display: grid;
  gap: 0.75rem;
}

.btn-action {
  width: 100%;
  justify-content: center;
  padding: 0.875rem 1rem;
  background: var(--gray-50);
  border: 1.5px solid var(--gray-200);
  color: var(--gray-700);
  font-weight: 500;
}

.btn-action:hover {
  background: white;
  border-color: var(--primary);
  color: var(--primary);
  transform: translateY(-1px);
  box-shadow: var(--shadow-sm);
}

/* Status indicators */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.375rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  background: var(--gray-100);
  color: var(--gray-700);
}

.status-draft {
  background: #fef3c7;
  color: #92400e;
}

.status-published {
  background: #d1fae5;
  color: #065f46;
}

/* Character counters */
.char-counter {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0.5rem;
  font-size: 0.75rem;
  color: var(--gray-500);
}

.char-counter.warning {
  color: var(--warning);
}

.char-counter.error {
  color: var(--error);
}

/* Image preview */
.image-preview {
  margin-top: 1rem;
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid var(--gray-200);
}

.image-preview img {
  width: 100%;
  height: auto;
  display: block;
  max-height: 200px;
  object-fit: cover;
}

/* Toolbar */
.editor-toolbar {
  display: flex;
  gap: 0.5rem;
  padding: 1rem 1.5rem;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
}

.toolbar-group {
  display: flex;
  gap: 0.25rem;
}

/* Responsive */
@media (max-width: 1200px) {
  .editor-main {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  
  .sidebar-area {
    position: static;
  }
}

@media (max-width: 768px) {
  .editor-main {
    padding: 1rem;
  }
  
  .header-content {
    flex-direction: column;
    align-items: stretch;
    gap: 1rem;
  }
  
  .header-actions {
    justify-content: stretch;
  }
  
  .header-actions .btn {
    flex: 1;
    justify-content: center;
  }
}

/* Loading states */
.loading {
  opacity: 0.7;
  pointer-events: none;
  position: relative;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  border: 2px solid var(--gray-300);
  border-top: 2px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Notifications */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 1rem 1.5rem;
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  border-left: 4px solid var(--primary);
  z-index: 1000;
  max-width: 320px;
  animation: slideIn 0.3s ease;
}

.notification.success {
  border-left-color: var(--success);
}

.notification.error {
  border-left-color: var(--error);
}

.notification.warning {
  border-left-color: var(--warning);
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* CKEditor customization */
.ck.ck-editor {
  border: none !important;
}

.ck.ck-editor__editable {
  border: none !important;
  padding: 1.5rem !important;
  font-size: 1rem !important;
  line-height: 1.7 !important;
  min-height: 500px !important;
}

.ck.ck-toolbar {
  background: var(--gray-50) !important;
  border: none !important;
  border-bottom: 1px solid var(--gray-200) !important;
  padding: 0.75rem 1rem !important;
}

/* Hide default Django admin elements */
.submit-row {
  display: none !important;
}

/* Field improvements */
.select2-container {
  width: 100% !important;
}

.select2-selection {
  border: 1.5px solid var(--gray-300) !important;
  border-radius: var(--radius) !important;
  min-height: 42px !important;
}

.select2-selection:focus {
  border-color: var(--primary) !important;
  outline: none !important;
}

/* Django form field styling */
.django-field {
  margin-bottom: 1rem;
}

.django-field label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--gray-700);
  font-size: 0.875rem;
}

.django-field input[type="text"],
.django-field input[type="url"],
.django-field textarea,
.django-field select {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 1.5px solid var(--gray-300);
  border-radius: var(--radius);
  font-size: 0.875rem;
  transition: all 0.2s ease;
  background: white;
  box-sizing: border-box;
}

.django-field input[type="text"]:focus,
.django-field input[type="url"]:focus,
.django-field textarea:focus,
.django-field select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Help text */
.help {
  color: var(--gray-500);
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* Error styling */
.errorlist {
  color: var(--error);
  font-size: 0.75rem;
  margin: 0.25rem 0 0 0;
  padding: 0;
  list-style: none;
}

/* Checkbox and radio styling */
.django-field input[type="checkbox"],
.django-field input[type="radio"] {
  margin-right: 0.5rem;
}

/* Make sure all Django form elements are visible */
form#post_form div {
  display: block !important;
}
</style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <!-- Header -->
  <header class="editor-header">
    <div class="header-content">
      <div class="header-title">
        <h1>
          {% if original %}
            <span class="status-indicator {% if original.status == 'published' %}status-published{% else %}status-draft{% endif %}">
              {% if original.status == 'published' %}📢{% else %}📝{% endif %}
              {{ original.get_status_display }}
            </span>
            Редактирование: {{ original.title|default:"Без названия"|truncatechars:50 }}
          {% else %}
            📝 Создание нового поста
          {% endif %}
        </h1>
      </div>
      <div class="header-actions">
        <button type="submit" name="_save" class="btn btn-primary">
          <span>💾 Сохранить</span>
        </button>
        <button type="submit" name="_continue" class="btn btn-secondary">
          <span>🔄 Сохранить и продолжить</span>
        </button>
        <a href="{% url 'admin:blog_post_changelist' %}" class="btn btn-outline">
          <span>← Назад</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="editor-main">
    <!-- Left Column - Content -->
    <div class="content-area">
      <!-- Title & Slug -->
      <div class="editor-card">
        <div class="card-header">
          <h3>📌 Основная информация</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label" for="id_title">Заголовок поста *</label>
            <input type="text" name="title" value="{{ adminform.form.title.value|default:'' }}" id="id_title" class="form-input title-field" placeholder="Введите captivating заголовок..." maxlength="255" required>
            {% if adminform.form.title.help_text %}
            <div class="help">{{ adminform.form.title.help_text }}</div>
            {% endif %}
            {% if adminform.form.title.errors %}
            <div class="errorlist">{{ adminform.form.title.errors }}</div>
            {% endif %}
          </div>
          <div class="form-group">
            <label class="form-label" for="id_slug">URL Slug</label>
            <input type="text" name="slug" value="{{ adminform.form.slug.value|default:'' }}" id="id_slug" class="form-input" placeholder="avtomaticeskiy-slug">
            <div class="char-counter">
              <span>Используется в URL</span>
              <button type="button" id="generate-slug" class="btn btn-sm btn-outline">🔄 Сгенерировать</button>
            </div>
            {% if adminform.form.slug.help_text %}
            <div class="help">{{ adminform.form.slug.help_text }}</div>
            {% endif %}
            {% if adminform.form.slug.errors %}
            <div class="errorlist">{{ adminform.form.slug.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Content Editor -->
      <div class="editor-card">
        <div class="card-header">
          <h3>📝 Содержание</h3>
          <div class="editor-toolbar">
            <div class="toolbar-group">
              <button type="button" id="word-count-btn" class="btn btn-sm btn-outline">📊 Статистика</button>
              <button type="button" id="auto-save-toggle" class="btn btn-sm btn-outline">💾 Автосохранение</button>
            </div>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <div class="editor-container">
            <div class="django-field">
              {{ adminform.form.content }}
              {% if adminform.form.content.help_text %}
              <div class="help">{{ adminform.form.content.help_text }}</div>
              {% endif %}
              {% if adminform.form.content.errors %}
              <div class="errorlist">{{ adminform.form.content.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Excerpt -->
      <div class="editor-card">
        <div class="card-header">
          <h3>📋 Краткое описание</h3>
        </div>
        <div class="card-body">
          <div class="form-group">
            <textarea name="excerpt" id="id_excerpt" class="form-textarea" placeholder="Краткое описание поста, отображается в превью..." rows="3">{{ adminform.form.excerpt.value|default:'' }}</textarea>
            <div class="char-counter">
              <span id="excerpt-counter">0</span>/320 символов
            </div>
            {% if adminform.form.excerpt.help_text %}
            <div class="help">{{ adminform.form.excerpt.help_text }}</div>
            {% endif %}
            {% if adminform.form.excerpt.errors %}
            <div class="errorlist">{{ adminform.form.excerpt.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Sidebar -->
    <div class="sidebar-area">
      <!-- Publication -->
      <div class="editor-card">
        <div class="card-header">
          <h3>🚀 Публикация</h3>
        </div>
        <div class="card-body">
          <!-- Status -->
          <div class="form-group">
            <label class="form-label" for="id_status">Статус</label>
            <select name="status" id="id_status" class="form-select">
              {% for value, label in adminform.form.status.field.choices %}
                <option value="{{ value }}" {% if adminform.form.status.value == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if adminform.form.status.help_text %}
            <div class="help">{{ adminform.form.status.help_text }}</div>
            {% endif %}
            {% if adminform.form.status.errors %}
            <div class="errorlist">{{ adminform.form.status.errors }}</div>
            {% endif %}
          </div>

          <!-- Published At -->
          <div class="form-group">
            <label class="form-label" for="id_published_at">Дата публикации</label>
            <input type="datetime-local" name="published_at" value="{{ adminform.form.published_at.value|date:'Y-m-d\TH:i'|default:'' }}" id="id_published_at" class="form-input">
            {% if adminform.form.published_at.help_text %}
            <div class="help">{{ adminform.form.published_at.help_text }}</div>
            {% endif %}
            {% if adminform.form.published_at.errors %}
            <div class="errorlist">{{ adminform.form.published_at.errors }}</div>
            {% endif %}
          </div>

          <!-- Author -->
          <div class="form-group">
            <label class="form-label" for="id_author">Автор</label>
            <select name="author" id="id_author" class="form-select">
              <option value="">---------</option>
              {% for value, label in adminform.form.author.field.choices %}
                <option value="{{ value }}" {% if adminform.form.author.value == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if adminform.form.author.help_text %}
            <div class="help">{{ adminform.form.author.help_text }}</div>
            {% endif %}
            {% if adminform.form.author.errors %}
            <div class="errorlist">{{ adminform.form.author.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Categories & Tags -->
      <div class="editor-card">
        <div class="card-header">
          <h3>🏷️ Классификация</h3>
        </div>
        <div class="card-body">
          <!-- Categories -->
          <div class="form-group">
            <label class="form-label" for="id_categories">Категории</label>
            <select name="categories" id="id_categories" class="form-select" multiple style="height: 120px;">
              {% for value, label in adminform.form.categories.field.choices %}
                <option value="{{ value }}" {% if value in adminform.form.categories.value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if adminform.form.categories.help_text %}
            <div class="help">{{ adminform.form.categories.help_text }}</div>
            {% endif %}
            {% if adminform.form.categories.errors %}
            <div class="errorlist">{{ adminform.form.categories.errors }}</div>
            {% endif %}
          </div>

          <!-- Tags -->
          <div class="form-group">
            <label class="form-label" for="id_tags">Теги</label>
            <select name="tags" id="id_tags" class="form-select" multiple style="height: 120px;">
              {% for value, label in adminform.form.tags.field.choices %}
                <option value="{{ value }}" {% if value in adminform.form.tags.value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if adminform.form.tags.help_text %}
            <div class="help">{{ adminform.form.tags.help_text }}</div>
            {% endif %}
            {% if adminform.form.tags.errors %}
            <div class="errorlist">{{ adminform.form.tags.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Featured Images -->
      <div class="editor-card">
        <div class="card-header">
          <h3>🖼️ Изображения</h3>
        </div>
        <div class="card-body">
          <!-- Featured Image -->
          <div class="form-group">
            <label class="form-label" for="id_featured_image">Главное изображение</label>
            <input type="url" name="featured_image" value="{{ adminform.form.featured_image.value|default:'' }}" id="id_featured_image" class="form-input" placeholder="https://example.com/image.jpg">
            {% if adminform.form.featured_image.value %}
            <div class="image-preview">
              <img src="{{ adminform.form.featured_image.value }}" alt="Preview" onerror="this.style.display='none'">
            </div>
            {% endif %}
            {% if adminform.form.featured_image.help_text %}
            <div class="help">{{ adminform.form.featured_image.help_text }}</div>
            {% endif %}
            {% if adminform.form.featured_image.errors %}
            <div class="errorlist">{{ adminform.form.featured_image.errors }}</div>
            {% endif %}
          </div>

          <!-- OG Image -->
          <div class="form-group">
            <label class="form-label" for="id_og_image">Open Graph изображение</label>
            <input type="url" name="og_image" value="{{ adminform.form.og_image.value|default:'' }}" id="id_og_image" class="form-input" placeholder="https://example.com/og-image.jpg">
            {% if adminform.form.og_image.value %}
            <div class="image-preview">
              <img src="{{ adminform.form.og_image.value }}" alt="Preview" onerror="this.style.display='none'">
            </div>
            {% endif %}
            {% if adminform.form.og_image.help_text %}
            <div class="help">{{ adminform.form.og_image.help_text }}</div>
            {% endif %}
            {% if adminform.form.og_image.errors %}
            <div class="errorlist">{{ adminform.form.og_image.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- SEO -->
      <div class="editor-card">
        <div class="card-header">
          <h3>🔍 SEO оптимизация</h3>
        </div>
        <div class="card-body">
          <!-- Meta Title -->
          <div class="form-group">
            <label class="form-label" for="id_meta_title">Мета-заголовок</label>
            <input type="text" name="meta_title" value="{{ adminform.form.meta_title.value|default:'' }}" id="id_meta_title" class="form-input" placeholder="Мета-заголовок для SEO..." maxlength="255">
            {% if adminform.form.meta_title.help_text %}
            <div class="help">{{ adminform.form.meta_title.help_text }}</div>
            {% endif %}
            {% if adminform.form.meta_title.errors %}
            <div class="errorlist">{{ adminform.form.meta_title.errors }}</div>
            {% endif %}
          </div>

          <!-- Meta Description -->
          <div class="form-group">
            <label class="form-label" for="id_meta_description">Мета-описание</label>
            <textarea name="meta_description" id="id_meta_description" class="form-textarea" placeholder="Мета-описание для SEO..." rows="3">{{ adminform.form.meta_description.value|default:'' }}</textarea>
            <div class="char-counter">
              <span id="meta-desc-counter">0</span>/160 символов
            </div>
            {% if adminform.form.meta_description.help_text %}
            <div class="help">{{ adminform.form.meta_description.help_text }}</div>
            {% endif %}
            {% if adminform.form.meta_description.errors %}
            <div class="errorlist">{{ adminform.form.meta_description.errors }}</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="editor-card">
        <div class="card-header">
          <h3>⚡ Быстрые действия</h3>
        </div>
        <div class="card-body">
          <div class="quick-actions">
            <button type="button" id="preview-btn" class="btn btn-action">
              👁️ Предпросмотр
            </button>
            <button type="button" id="fill-meta" class="btn btn-action">
              📝 Заполнить SEO
            </button>
            <button type="button" id="check-seo" class="btn btn-action">
              🔍 Проверить SEO
            </button>
            <a href="{% url 'admin:blog_medialibrary_changelist' %}" class="btn btn-action" target="_blank">
              🗂️ Медиатека
            </a>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- CSRF Token and other hidden fields -->
{% csrf_token %}
{% for field in adminform.form.hidden_fields %}
  {{ field }}
{% endfor %}
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
// Modern Post Editor JavaScript
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Modern Post Editor initialized');
  
  // Auto-save functionality
  let autoSaveEnabled = true;
  let autoSaveInterval;
  
  // Initialize all features
  initAutoSave();
  initCharacterCounters();
  initQuickActions();
  initSlugGeneration();
  initSEOTools();
  initFormEnhancements();
  
  function initAutoSave() {
    const toggleBtn = document.getElementById('auto-save-toggle');
    if (!toggleBtn) return;
    
    // Load auto-save preference from localStorage
    const saved = localStorage.getItem('autoSaveEnabled');
    if (saved !== null) {
      autoSaveEnabled = JSON.parse(saved);
    }
    
    updateAutoSaveButton();
    
    toggleBtn.addEventListener('click', function() {
      autoSaveEnabled = !autoSaveEnabled;
      localStorage.setItem('autoSaveEnabled', JSON.stringify(autoSaveEnabled));
      updateAutoSaveButton();
      
      if (autoSaveEnabled) {
        startAutoSave();
        showNotification('Автосохранение включено', 'success');
      } else {
        stopAutoSave();
        showNotification('Автосохранение отключено', 'warning');
      }
    });
    
    function updateAutoSaveButton() {
      toggleBtn.textContent = autoSaveEnabled ? '💾 Вкл' : '⏸️ Выкл';
      toggleBtn.classList.toggle('btn-secondary', !autoSaveEnabled);
      toggleBtn.classList.toggle('btn-outline', autoSaveEnabled);
    }
    
    function startAutoSave() {
      if (autoSaveInterval) clearInterval(autoSaveInterval);
      autoSaveInterval = setInterval(() => {
        if (autoSaveEnabled && hasUnsavedChanges()) {
          saveDraft();
        }
      }, 30000);
    }
    
    function stopAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
      }
    }
    
    function saveDraft() {
      // In a real implementation, this would be an AJAX call to save the draft
      console.log('💾 Auto-saving draft...');
      // showNotification('Черновик сохранен', 'success');
    }
    
    startAutoSave();
  }
  
  function initCharacterCounters() {
    const excerptField = document.getElementById('id_excerpt');
    const metaDescField = document.getElementById('id_meta_description');
    
    function updateCounter(field, counterId, maxLength) {
      const counter = document.getElementById(counterId);
      if (!counter || !field) return;
      
      const length = field.value.length;
      counter.textContent = length;
      
      // Update counter color based on length
      counter.parentElement.classList.remove('warning', 'error');
      if (length > maxLength) {
        counter.parentElement.classList.add('error');
      } else if (length > maxLength * 0.9) {
        counter.parentElement.classList.add('warning');
      }
    }
    
    if (excerptField) {
      updateCounter(excerptField, 'excerpt-counter', 320);
      excerptField.addEventListener('input', () => updateCounter(excerptField, 'excerpt-counter', 320));
    }
    
    if (metaDescField) {
      updateCounter(metaDescField, 'meta-desc-counter', 160);
      metaDescField.addEventListener('input', () => updateCounter(metaDescField, 'meta-desc-counter', 160));
    }
  }
  
  function initQuickActions() {
    // Preview button
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
      previewBtn.addEventListener('click', function() {
        const postId = getPostId();
        if (postId) {
          window.open(`/preview/${postId}`, '_blank');
        } else {
          showNotification('Сохраните пост для предпросмотра', 'warning');
        }
      });
    }
    
    // Word count button
    const wordCountBtn = document.getElementById('word-count-btn');
    if (wordCountBtn) {
      wordCountBtn.addEventListener('click', showWordCount);
    }
  }
  
  function initSlugGeneration() {
    const generateBtn = document.getElementById('generate-slug');
    const titleField = document.getElementById('id_title');
    const slugField = document.getElementById('id_slug');
    
    if (generateBtn && titleField && slugField) {
      generateBtn.addEventListener('click', function() {
        const title = titleField.value.trim();
        if (title) {
          const slug = generateSlug(title);
          slugField.value = slug;
          showNotification('Slug сгенерирован', 'success');
        } else {
          showNotification('Введите заголовок сначала', 'warning');
        }
      });
      
      // Auto-generate slug when title changes (if slug is empty)
      titleField.addEventListener('blur', function() {
        if (!slugField.value.trim()) {
          const title = titleField.value.trim();
          if (title) {
            slugField.value = generateSlug(title);
          }
        }
      });
    }
  }
  
  function initSEOTools() {
    const fillMetaBtn = document.getElementById('fill-meta');
    const checkSeoBtn = document.getElementById('check-seo');
    const titleField = document.getElementById('id_title');
    const excerptField = document.getElementById('id_excerpt');
    const metaTitleField = document.getElementById('id_meta_title');
    const metaDescField = document.getElementById('id_meta_description');
    
    if (fillMetaBtn && titleField) {
      fillMetaBtn.addEventListener('click', function() {
        const title = titleField.value.trim();
        const excerpt = excerptField ? excerptField.value.trim() : '';
        
        if (title) {
          // Fill meta title if empty
          if (metaTitleField && !metaTitleField.value.trim()) {
            metaTitleField.value = title;
          }
          
          // Fill meta description if empty
          if (metaDescField && !metaDescField.value.trim()) {
            if (excerpt) {
              metaDescField.value = excerpt.substring(0, 160);
            } else {
              metaDescField.value = title.substring(0, 160);
            }
          }
          
          showNotification('SEO данные заполнены', 'success');
        } else {
          showNotification('Введите заголовок сначала', 'warning');
        }
      });
    }
    
    if (checkSeoBtn) {
      checkSeoBtn.addEventListener('click', function() {
        const title = titleField ? titleField.value.trim() : '';
        const metaTitle = metaTitleField ? metaTitleField.value.trim() : '';
        const metaDesc = metaDescField ? metaDescField.value.trim() : '';
        
        let issues = [];
        
        if (!title) issues.push('• Заголовок поста не заполнен');
        if (!metaTitle) issues.push('• Мета-заголовок не заполнен');
        if (!metaDesc) issues.push('• Мета-описание не заполнено');
        
        if (metaTitle && metaTitle.length > 60) {
          issues.push('• Мета-заголовок слишком длинный (>60 символов)');
        }
        
        if (metaDesc && metaDesc.length > 160) {
          issues.push('• Мета-описание слишком длинное (>160 символов)');
        }
        
        if (issues.length === 0) {
          showNotification('✅ SEO оптимизация отличная!', 'success');
        } else {
          showNotification('🔍 Проблемы с SEO:<br>' + issues.join('<br>'), 'warning');
        }
      });
    }
  }
  
  function initFormEnhancements() {
    // Add loading state to form submission
    const form = document.getElementById('post_form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const title = document.getElementById('id_title').value.trim();
        if (!title) {
          e.preventDefault();
          showNotification('Заголовок обязателен для заполнения', 'error');
          document.getElementById('id_title').focus();
          return;
        }
        
        // Show saving indicator
        const submitBtn = document.querySelector('button[name="_save"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span>⏳ Сохранение...</span>';
        }
      });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Ctrl+S or Cmd+S for save
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.querySelector('button[name="_save"]').click();
      }
    });
  }
  
  function generateSlug(text) {
    return text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/[\s_-]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .substring(0, 50);
  }
  
  function getPostId() {
    const urlMatch = window.location.pathname.match(/\/admin\/blog\/post\/(\d+)\/change/);
    return urlMatch ? urlMatch[1] : null;
  }
  
  function hasUnsavedChanges() {
    // Simple check - in real implementation, compare with original values
    return true;
  }
  
  function showWordCount() {
    const contentField = document.querySelector('[name="content"]');
    if (!contentField) return;
    
    const text = contentField.value || '';
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    const charCount = text.length;
    const readingTime = Math.ceil(wordCount / 200);
    
    showNotification(
      `📊 Статистика контента:<br><br>` +
      `• Слов: <strong>${wordCount}</strong><br>` +
      `• Символов: <strong>${charCount}</strong><br>` +
      `• Время чтения: <strong>${readingTime} мин</strong>`,
      'info',
      5000
    );
  }
  
  function showNotification(message, type = 'info', duration = 3000) {
    // Remove existing notifications
    const existing = document.querySelector('.notification');
    if (existing) existing.remove();
    
    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    // Auto remove
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, duration);
  }
});
</script>
{% endblock %}