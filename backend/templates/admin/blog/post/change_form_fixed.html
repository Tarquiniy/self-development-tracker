{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Медиа библиотека</title>
  <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f6f8fb;color:#111;padding:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .media-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .media-item{background:#fff;border-radius:8px;padding:8px;border:1px solid #e6eef6;cursor:pointer;text-align:center}
    .media-item img{max-width:100%;height:120px;object-fit:cover;border-radius:6px}
  </style>
</head>
<body>
  <div class="topbar">
    <h2>Медиатека</h2>
    <div>
      <input id="file-input" type="file" multiple accept="image/*">
      <button id="upload-btn">Загрузить</button>
    </div>
  </div>

  <div class="container">
    <div id="media-grid" class="media-grid"></div>
  </div>

  <script>
    // Lightweight media library script - loads files via fetch to upload endpoint
    const grid = document.getElementById('media-grid');
    async function loadMedia(){
      try{
        const res = await fetch('/admin/media/list-json/');
        const data = await res.json();
        grid.innerHTML = '';
        data.forEach(item=>{
          const el = document.createElement('div');
          el.className = 'media-item';
          el.innerHTML = `<img src="${item.url}" alt=""><div style="font-size:12px;margin-top:6px">${item.name}</div>`;
          el.addEventListener('click', ()=> {
            // try to insert to opener window
            if (window.opener && typeof window.opener.__insertMediaToEditor === 'function'){
              window.opener.__insertMediaToEditor(item.url);
              window.close();
            } else {
              navigator.clipboard.writeText(item.url);
              alert('Ссылка скопирована в буфер');
            }
          });
          grid.appendChild(el);
        });
      }catch(e){
        console.warn('media load',e);
        grid.innerHTML = '<div>Ошибка загрузки медиа</div>';
      }
    }
    document.getElementById('upload-btn').addEventListener('click', async ()=>{
      const input = document.getElementById('file-input');
      if(!input.files.length) return alert('Выберите файлы');
      const fd = new FormData();
      for(const f of input.files) fd.append('files', f);
      const res = await fetch('/admin/media/upload/', { method:'POST', body: fd });
      if(res.ok) { loadMedia(); input.value=''; }
      else alert('Ошибка загрузки');
    });

    loadMedia();
  </script>
</body>
</html>
