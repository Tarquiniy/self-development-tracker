{# backend/templates/admin/blog/post/change_form_fixed.html #}
{% extends "admin/change_form.html" %}
{% load i18n static admin_urls %}

{% block extrahead %}
  {{ block.super }}
  <!-- Inter font (optional, fallback included) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'admin/css/change-form.css' %}">
{% endblock %}

{% block content %}
<div class="pt-editor-page">
  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <!-- Topbar -->
    <div class="pt-topbar">
      <div class="pt-topbar-left">
        <div class="pt-title">
          {% if original and original.title %}
            {{ original.title|truncatechars:80 }}
          {% else %}
            üìù {% trans "–ù–æ–≤—ã–π –ø–æ—Å—Ç" %}
          {% endif %}
        </div>
        <div class="pt-sub muted">
          {% if original and original.pk %}
            {% trans "ID" %}: {{ original.pk }} ‚Ä¢ {% trans "–û–±–Ω–æ–≤–ª—ë–Ω" %}: {{ original.updated_at|default:"‚Äî" }}
          {% endif %}
        </div>
      </div>

      <div class="pt-topbar-right">
        <button type="submit" name="_save" class="pt-btn pt-btn-primary">üíæ {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}</button>
        <button type="submit" name="_continue" class="pt-btn">üîÅ {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å" %}</button>
        <a href="{% url 'admin:blog_post_changelist' %}" class="pt-btn pt-btn-ghost">{% trans "–ù–∞–∑–∞–¥" %}</a>
      </div>
    </div>

    <!-- Main grid -->
    <div class="pt-editor-grid">
      <!-- LEFT: main content -->
      <main class="pt-main">
        <!-- Primary card: title + slug -->
        <section class="pt-card">
          <div class="pt-card-header">üìå {% trans "–û—Å–Ω–æ–≤–Ω–æ–µ" %}</div>
          <div class="pt-card-body">
            <div class="pt-field">
              <label class="pt-label" for="{{ adminform.form.title.auto_id }}">{{ adminform.form.title.label }}</label>
              {{ adminform.form.title }}
              {% if adminform.form.title.errors %}<div class="pt-error">{{ adminform.form.title.errors|join:", " }}</div>{% endif %}
            </div>

            <div class="pt-split">
              <div style="flex:1" class="pt-field">
                <label class="pt-label" for="{{ adminform.form.slug.auto_id }}">{{ adminform.form.slug.label }}</label>
                {{ adminform.form.slug }}
                {% if adminform.form.slug.errors %}<div class="pt-error">{{ adminform.form.slug.errors|join:", " }}</div>{% endif %}
              </div>
              <div style="width:140px;display:flex;align-items:flex-end;justify-content:flex-end">
                <button type="button" id="pt-gen-slug" class="pt-btn pt-btn-outline">üîÑ {% trans "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" %}</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Content card (CKEditor) -->
        <section class="pt-card">
          <div class="pt-card-header">üìù {% trans "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" %}</div>
          <div class="pt-card-body">
            <div class="pt-field">
              {{ adminform.form.content }}
              {% if adminform.form.content.errors %}<div class="pt-error">{{ adminform.form.content.errors|join:", " }}</div>{% endif %}
            </div>
          </div>
        </section>

        <!-- Excerpt -->
        <section class="pt-card">
          <div class="pt-card-header">üìã {% trans "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" %}</div>
          <div class="pt-card-body">
            <div class="pt-field">
              {{ adminform.form.excerpt }}
              <div class="pt-charcounter"><span id="pt-excerpt-count">0</span> / 320</div>
              {% if adminform.form.excerpt.errors %}<div class="pt-error">{{ adminform.form.excerpt.errors|join:", " }}</div>{% endif %}
            </div>
          </div>
        </section>

        {# Any additional fieldsets that are not in sidebar: render them here #}
        {% for fieldset in adminform %}
          {% if fieldset.name and fieldset not in None %}
            {# We already rendered many fields; this loop keeps compatibility but avoids duplicates #}
          {% endif %}
        {% endfor %}
      </main>

      <!-- RIGHT: sidebar -->
      <aside class="pt-sidebar">
        <section class="pt-card">
          <div class="pt-card-header">üöÄ {% trans "–ü—É–±–ª–∏–∫–∞—Ü–∏—è" %}</div>
          <div class="pt-card-body">
            {% if adminform.form.status %}
              <div class="pt-field">{{ adminform.form.status }}</div>
            {% endif %}
            {% if adminform.form.published_at %}
              <div class="pt-field">{{ adminform.form.published_at }}</div>
            {% endif %}
            {% if adminform.form.author %}
              <div class="pt-field">{{ adminform.form.author }}</div>
            {% endif %}
          </div>
        </section>

        <section class="pt-card">
          <div class="pt-card-header">üè∑Ô∏è {% trans "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è" %}</div>
          <div class="pt-card-body">
            {% if adminform.form.categories %}<div class="pt-field">{{ adminform.form.categories }}</div>{% endif %}
            {% if adminform.form.tags %}<div class="pt-field">{{ adminform.form.tags }}</div>{% endif %}
          </div>
        </section>

        <section class="pt-card">
          <div class="pt-card-header">üîé {% trans "SEO" %}</div>
          <div class="pt-card-body">
            {% if adminform.form.meta_title %}<div class="pt-field">{{ adminform.form.meta_title }}</div>{% endif %}
            {% if adminform.form.meta_description %}
              <div class="pt-field">{{ adminform.form.meta_description }}<div class="pt-charcounter"><span id="pt-meta-count">0</span> / 160</div></div>
            {% endif %}
            <div style="margin-top:8px">
              <button type="button" id="pt-fill-seo" class="pt-btn pt-btn-outline">üìù {% trans "–ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO" %}</button>
            </div>
          </div>
        </section>

        <section class="pt-card">
          <div class="pt-card-header">üñºÔ∏è {% trans "–ú–µ–¥–∏–∞" %}</div>
          <div class="pt-card-body">
            {% if adminform.form.featured_image %}<div class="pt-field">{{ adminform.form.featured_image }}</div>{% endif %}
            {% if adminform.form.og_image %}<div class="pt-field">{{ adminform.form.og_image }}</div>{% endif %}
            <div class="pt-field">
              <a href="{% url 'media-library' %}" class="pt-btn pt-btn-ghost" target="_blank">{% trans "–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞—Ç–µ–∫—É" %}</a>
            </div>
          </div>
        </section>
      </aside>
    </div>

    {# Keep hidden fields and default submit area to preserve admin behaviour #}
    <div style="display:none;">
      {% for field in adminform.form.hidden_fields %}{{ field }}{% endfor %}
      {% block submit_buttons_bottom %}{% endblock %}
    </div>
  </form>
</div>
{% endblock %}

{% block footer %}
  {{ block.super }}
  <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>
  <script src="{% static 'admin/js/change-form.js' %}"></script>

  <script>
    // small inline safety: set preview url if available
    window.__pt_post_preview = {% if original and original.get_absolute_url %}"{{ original.get_absolute_url|escapejs }}"{% else %}null{% endif %};
  </script>
{% endblock %}
