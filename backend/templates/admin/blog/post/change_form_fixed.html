{# backend/templates/admin/blog/post/change_form_fixed.html #}
{% extends "admin/change_form.html" %}
{% load i18n static admin_urls %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/change-form.css' %}">
  <style>
    /* small inline safety: if external css not loaded, this keeps layout acceptable */
    .pt-fallback { max-width: 1200px; margin: 12px auto; padding: 0 16px; }
  </style>
{% endblock %}

{% block content %}
<div class="pt-fallback">
  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="pt-editor-page">
      <!-- Top bar -->
      <div class="pt-topbar card">
        <div class="pt-topbar-left">
          <div class="pt-title">
            {% if original %}
              {{ original.title|default:("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ") }}
            {% else %}
              üìù {% trans "–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞" %}
            {% endif %}
          </div>
          <div class="pt-sub muted">
            {% if original and original.pk %}
              ID: {{ original.pk }} ‚Ä¢ {% trans "–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ" %}: {{ original.updated_at|default:"‚Äî" }}
            {% endif %}
          </div>
        </div>

        <div class="pt-topbar-right">
          <button type="submit" name="_save" class="pt-btn pt-btn-primary" title="{% trans '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' %}">üíæ {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}</button>
          <button type="submit" name="_continue" class="pt-btn" title="{% trans '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å' %}">üîÅ {% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å" %}</button>
          <a href="{% url 'admin:blog_post_changelist' %}" class="pt-btn pt-btn-ghost">{% trans "–ù–∞–∑–∞–¥" %}</a>
        </div>
      </div>

      <div class="pt-editor-grid">
        <!-- LEFT: main content -->
        <main class="pt-main">
          <!-- Title & slug (we render adminform.title if present, otherwise fallback) -->
          <section class="pt-card">
            <div class="pt-card-header">üìå {% trans "–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" %}</div>
            <div class="pt-card-body">
              <div class="pt-field">
                <label class="pt-label" for="id_title">{% trans "–ó–∞–≥–æ–ª–æ–≤–æ–∫" %} *</label>
                {{ adminform.form.title }}
                {% if adminform.form.title.errors %}<div class="pt-error">{{ adminform.form.title.errors }}</div>{% endif %}
              </div>

              <div class="pt-field split">
                <div style="flex:1">
                  <label class="pt-label" for="id_slug">{% trans "URL Slug" %}</label>
                  {{ adminform.form.slug }}
                  {% if adminform.form.slug.errors %}<div class="pt-error">{{ adminform.form.slug.errors }}</div>{% endif %}
                </div>
                <div style="width:140px;display:flex;align-items:flex-end;justify-content:flex-end">
                  <button type="button" id="pt-generate-slug" class="pt-btn pt-btn-outline">üîÑ {% trans "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" %}</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Content (CKEditor) -->
          <section class="pt-card">
            <div class="pt-card-header">üìù {% trans "–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ" %}</div>
            <div class="pt-card-body">
              <div class="pt-field">
                {{ adminform.form.content }}
                {% if adminform.form.content.errors %}<div class="pt-error">{{ adminform.form.content.errors }}</div>{% endif %}
              </div>
            </div>
          </section>

          <!-- Excerpt -->
          <section class="pt-card">
            <div class="pt-card-header">üìã {% trans "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" %}</div>
            <div class="pt-card-body">
              <div class="pt-field">
                {{ adminform.form.excerpt }}
                <div class="pt-charcounter"><span id="pt-excerpt-count">0</span> / 320</div>
                {% if adminform.form.excerpt.errors %}<div class="pt-error">{{ adminform.form.excerpt.errors }}</div>{% endif %}
              </div>
            </div>
          </section>

          {# Render any remaining non-sidebar fields (hidden fields are rendered below) #}
          {% comment %} additional main fields could be here {% endcomment %}
        </main>

        <!-- RIGHT: sidebar -->
        <aside class="pt-sidebar">
          <!-- Publish box -->
          <section class="pt-card">
            <div class="pt-card-header">üöÄ {% trans "–ü—É–±–ª–∏–∫–∞—Ü–∏—è" %}</div>
            <div class="pt-card-body">
              {% if adminform.form.status %}
                <div class="pt-field">
                  <label class="pt-label">{% trans "–°—Ç–∞—Ç—É—Å" %}</label>
                  {{ adminform.form.status }}
                </div>
              {% endif %}
              {% if adminform.form.published_at %}
                <div class="pt-field">
                  <label class="pt-label">{% trans "–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏" %}</label>
                  {{ adminform.form.published_at }}
                </div>
              {% endif %}
              {% if adminform.form.author %}
                <div class="pt-field">
                  <label class="pt-label">{% trans "–ê–≤—Ç–æ—Ä" %}</label>
                  {{ adminform.form.author }}
                </div>
              {% endif %}
            </div>
          </section>

          <!-- Categories / Tags -->
          <section class="pt-card">
            <div class="pt-card-header">üè∑Ô∏è {% trans "–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è" %}</div>
            <div class="pt-card-body">
              {% if adminform.form.categories %}
                <div class="pt-field">{{ adminform.form.categories }}</div>
              {% endif %}
              {% if adminform.form.tags %}
                <div class="pt-field">{{ adminform.form.tags }}</div>
              {% endif %}
            </div>
          </section>

          <!-- SEO -->
          <section class="pt-card">
            <div class="pt-card-header">üîé {% trans "SEO" %}</div>
            <div class="pt-card-body">
              {% if adminform.form.meta_title %}
                <div class="pt-field">
                  <label class="pt-label">{% trans "Meta title" %}</label>
                  {{ adminform.form.meta_title }}
                </div>
              {% endif %}
              {% if adminform.form.meta_description %}
                <div class="pt-field">
                  <label class="pt-label">{% trans "Meta description" %}</label>
                  {{ adminform.form.meta_description }}
                  <div class="pt-charcounter"><span id="pt-meta-desc-count">0</span> / 160</div>
                </div>
              {% endif %}
              <div style="margin-top:8px">
                <button type="button" id="pt-fill-seo" class="pt-btn pt-btn-outline">üìù {% trans "–ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞/–æ–ø–∏—Å–∞–Ω–∏—è" %}</button>
              </div>
            </div>
          </section>

          <!-- Featured image -->
          <section class="pt-card">
            <div class="pt-card-header">üñºÔ∏è {% trans "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" %}</div>
            <div class="pt-card-body">
              {% if adminform.form.featured_image %}
                <div class="pt-field">{{ adminform.form.featured_image }}</div>
              {% endif %}
              {% if adminform.form.og_image %}
                <div class="pt-field">{{ adminform.form.og_image }}</div>
              {% endif %}
              <div class="pt-field">
                <a href="{% url 'media-library' %}" target="_blank" class="pt-btn pt-btn-ghost">{% trans "–û—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞—Ç–µ–∫—É" %}</a>
              </div>
            </div>
          </section>
        </aside>
      </div>

      {# Hidden and inline formsets + hidden fields #}
      <div style="display:none">
        {% for field in adminform.form.hidden_fields %}
          {{ field }}
        {% endfor %}
        {% comment %} Keep admin's submit row hidden to preserve behavior {% endcomment %}
        {% block submit_buttons_bottom %}{% endblock %}
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block footer %}
  {{ block.super }}

  <!-- CKEditor 5 classic build (CDN) -->
  <script src="https://cdn.ckeditor.com/ckeditor5/40.2.0/classic/ckeditor.js"></script>

  <script src="{% static 'admin/js/change-form.js' %}"></script>

  <script>
    // Inline fallback: if static JS not loaded, execute core init here
    (function(){
      // Simple check if external script loaded
      if (typeof window.__pt_changeform_init === 'function') return;
      // If external not loaded (for safety), run minimal init (will be overridden by external script when present)
      document.addEventListener('DOMContentLoaded', function(){
        // Initialize CKEditor on #id_content if present
        try {
          const el = document.querySelector('#id_content, textarea[name="content"]');
          if (el && window.ClassicEditor) {
            ClassicEditor.create(el, {
              toolbar: ['heading','|','bold','italic','link','bulletedList','numberedList','blockQuote','insertTable','undo','redo','imageUpload'],
              placeholder: '–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ—Å—Ç–∞...'
            }).catch(err=>console.error('CKEditor init (fallback) error', err));
          }
        } catch(e){ console.warn(e); }
      });
    })();
  </script>
{% endblock %}
