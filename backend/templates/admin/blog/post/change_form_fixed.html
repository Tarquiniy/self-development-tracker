{# backend/templates/admin/blog/post/change_form_fixed.html
   Полноценный change_form для модели Post, адаптированный под структуру БД:
   - рендерит adminform (основная форма)
   - поддержка inline formsets
   - боковая панель: статус, slug, изображение, автор, даты, быстрые метрики (attachments, revisions, views, comments, reactions)
   - JS: автосохранение в localStorage, подсказка slug, предварительный просмотр (POST в новое окно), preview кнопки
   Основа взята из общего админ-layout'а (admin/base_site.html).
#}

{% extends "admin/base_site.html" %}
{% load i18n admin_urls static widget_tweaks %}

{% block title %}
  {% if original %}
    {{ original }} — {% trans "Редактирование записи" %}
  {% else %}
    {% trans "Добавить пост" %}
  {% endif %}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script src="{% static 'admin/js/ckeditor-init.js' %}"></script>
  <script src="{% static 'admin/js/tiptap-init.js' %}"></script>

  <style>
    /* Локальные стили формы, согласованы с admin-modern.css */
    .post-edit-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; align-items:start; }
    .meta-panel { position: sticky; top:86px; }
    .field-label { font-weight:700; margin-bottom:6px; color: #0f172a; }
    .help-text { color: #6b7280; font-size:0.92rem; margin-top:6px; }
    .preview-image { max-width:100%; border-radius:8px; border:1px solid #e8eef8; margin-top:8px; }
    .autosave-indicator { font-size:0.85rem; color:#64748b; margin-left:8px; }
    .slug-auto { font-size:0.85rem; color:#475569; margin-top:6px; display:block; }
    .actions-row { display:flex; gap:10px; align-items:center; }
    .save-primary { background:var(--primary-2); color:#fff; padding:8px 12px; border-radius:8px; border:none; font-weight:700; }
    .save-secondary { background:#f3f4f6; padding:8px 12px; border-radius:8px; border:1px solid #e6eef6; }
    .metrics-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .metric { display:flex; justify-content:space-between; align-items:center; padding:8px; background:#fff; border-radius:8px; box-shadow:0 6px 14px rgba(2,6,23,0.04); }
    .metric .m-label { color:#475569; font-weight:600; }
    .metric .m-value { font-size:1rem; font-weight:800; color:#0f172a; }
  </style>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1 style="margin:0;">
          {% if original %}{{ original }}{% else %}{% trans "Новый пост" %}{% endif %}
        </h1>
        <div style="margin-top:6px;color:var(--muted);">
          {% if original %}{% trans "ID" %}: {{ original.pk }}{% else %}{% trans "Ещё не сохранено" %}{% endif %}
        </div>
      </div>

      <div class="actions-row">
        {% if has_delete_permission and original %}
          <a href="{% url opts|admin_urlname:'delete' original.pk %}{% if preserved_filters %}?{{ preserved_filters }}{% endif %}" class="save-secondary">
            {% trans "Удалить" %}
          </a>
        {% endif %}

        <button type="submit" form="post-form" class="save-primary" id="btn-save">{% trans "Сохранить" %}</button>

        <button type="button" class="save-secondary" id="btn-preview">{% trans "Предпросмотр" %}</button>

        <span class="autosave-indicator" id="autosave-info">{% trans "Последний автосейв:" %} <span id="autosave-time">—</span></span>
      </div>
    </div>

    <div class="card-body">
      <form id="post-form" method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="post-edit-grid">
          <!-- MAIN COLUMN -->
          <section>
            {% if adminform.non_field_errors %}
              <div class="errors">{{ adminform.non_field_errors }}</div>
            {% endif %}

            {# Рендерим fieldsets через adminform (гарантирует корректность с ModelAdmin) #}
            {% for fieldset in adminform %}
              <fieldset class="module aligned" style="margin-bottom:16px;">
                {% if fieldset.name %}
                  <h2 style="margin:0 0 8px 0;font-size:16px;">{{ fieldset.name }}</h2>
                {% endif %}

                <div class="form-row">
                  {% for field in fieldset %}
                    <div style="margin-bottom:14px;">
                      {% if field.is_hidden %}
                        {{ field }}
                      {% else %}
                        <div class="field-label">{{ field.label|safe }}</div>
                        <div class="field widget-wrap">{{ field|add_class:"w-full" }}</div>
                        {% if field.errors %}<div class="errors">{{ field.errors }}</div>{% endif %}
                        {% if field.help_text %}<div class="help-text">{{ field.help_text|safe }}</div>{% endif %}
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
            {% endfor %}

            {# Inlines (attachments, comments, etc.) #}
            {% for inline_admin_formset in inline_admin_formsets %}
              <div class="inline-group card" style="margin-top:18px; padding:14px;">
                <h3 style="margin:0 0 12px 0;">{{ inline_admin_formset.opts.verbose_name_plural }}</h3>

                {% for formset_form in inline_admin_formset %}
                  <div class="inline-related" style="margin-bottom:12px;">
                    {% for field in formset_form %}
                      <div style="margin-bottom:8px;">
                        {% if field.is_hidden %}
                          {{ field }}
                        {% else %}
                          <div class="field-label">{{ field.label }}</div>
                          <div class="field">{{ field }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                    {% if formset_form.original %}
                      <div class="help-text">ID: {{ formset_form.original.pk }}</div>
                    {% endif %}
                  </div>
                {% endfor %}

                {% if inline_admin_formset.has_add_permission %}
                  <p><a class="add-related" href="#">{% trans "Добавить" %} {{ inline_admin_formset.opts.verbose_name }}</a></p>
                {% endif %}
              </div>
            {% endfor %}

            <div style="margin-top:18px;display:flex;gap:8px;">
              <button type="submit" class="save-primary">{% trans "Сохранить" %}</button>
              <a href="{% url 'admin:index' %}" class="save-secondary">{% trans "Отмена" %}</a>
            </div>
          </section>

          <!-- SIDEBAR -->
          <aside class="meta-panel card" aria-label="Post metadata">
            <div class="card-body">
              <h3 style="margin-top:0;">{% trans "Статус и публикация" %}</h3>

              {# Try to render publish/status fields from adminform.form if they exist #}
              {% if adminform.form.publish %}
                <div style="margin-bottom:8px;">
                  <div class="field-label">{{ adminform.form.publish.label }}</div>
                  <div>{{ adminform.form.publish }}</div>
                </div>
              {% endif %}

              {% if adminform.form.status %}
                <div style="margin-bottom:8px;">
                  <div class="field-label">{{ adminform.form.status.label }}</div>
                  <div>{{ adminform.form.status }}</div>
                </div>
              {% endif %}

              {% if adminform.form.published_at %}
                <div style="margin-bottom:8px;">
                  <div class="field-label">{{ adminform.form.published_at.label }}</div>
                  <div>{{ adminform.form.published_at }}</div>
                </div>
              {% endif %}

              <hr style="margin:12px 0;" />

              {# Slug field + suggestion #}
              {% if adminform.form.slug %}
                <div style="margin-bottom:10px;">
                  <div class="field-label">{{ adminform.form.slug.label }}</div>
                  <div>{{ adminform.form.slug }}</div>
                  <span class="slug-auto" id="slug-suggestion">{% trans "Подсказка slug" %}</span>
                </div>
              {% endif %}

              <hr style="margin:12px 0;" />

              {# Featured image #}
              {% if adminform.form.featured_image %}
                <div style="margin-bottom:10px;">
                  <div class="field-label">{{ adminform.form.featured_image.label }}</div>
                  <div>{{ adminform.form.featured_image }}</div>
                  {% if original and original.featured_image %}
                    <img src="{{ original.featured_image.url }}" alt="preview" class="preview-image" id="existing-image-preview" />
                  {% else %}
                    <img src="" alt="" class="preview-image" id="new-image-preview" style="display:none;" />
                  {% endif %}
                </div>
              {% endif %}

              <hr style="margin:12px 0;" />

              {# Author / created info #}
              <div style="margin-bottom:8px;">
                <div class="field-label">{% trans "Автор" %}</div>
                <div style="color:var(--muted);">{% if original %}{{ original.author }}{% else %}{% trans "Не указан" %}{% endif %}</div>
              </div>

              <div style="margin-bottom:8px;">
                <div class="field-label">{% trans "Создано" %}</div>
                <div style="color:var(--muted);">{% if original and original.created_at %}{{ original.created_at|date:"SHORT_DATETIME_FORMAT" }}{% else %}—{% endif %}</div>
              </div>

              <div style="margin-bottom:8px;">
                <div class="field-label">{% trans "Последнее изменение" %}</div>
                <div style="color:var(--muted);">{% if original and original.updated_at %}{{ original.updated_at|date:"SHORT_DATETIME_FORMAT" }}{% else %}—{% endif %}</div>
              </div>

              <hr style="margin:12px 0;" />

              {# Quick metrics (attachments, revisions, views, comments, reactions) #}
              <h4 style="margin:0 0 8px 0;">{% trans "Метрики" %}</h4>
              <div class="metrics-list">
                <div class="metric">
                  <div class="m-label">{% trans "Вложения" %}</div>
                  <div class="m-value">{% if original %}{{ original.blog_postattachment_set.count }}{% else %}0{% endif %}</div>
                </div>

                <div class="metric">
                  <div class="m-label">{% trans "Ревизии" %}</div>
                  <div class="m-value">{% if original %}{{ original.blog_postrevision_set.count }}{% else %}0{% endif %}</div>
                </div>

                <div class="metric">
                  <div class="m-label">{% trans "Просмотры" %}</div>
                  <div class="m-value">{% if original %}{{ original.blog_postview_set.count }}{% else %}0{% endif %}</div>
                </div>

                <div class="metric">
                  <div class="m-label">{% trans "Комментарии" %}</div>
                  <div class="m-value">{% if original %}{{ original.blog_comment_set.count }}{% else %}0{% endif %}</div>
                </div>

                <div class="metric">
                  <div class="m-label">{% trans "Реакции" %}</div>
                  <div class="m-value">{% if original %}{{ original.blog_postreaction_set.count }}{% else %}0{% endif %}</div>
                </div>
              </div>

              <hr style="margin:12px 0;" />

              {# Links: open public URL, open revisions in admin if exists #}
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
                {% if original and original.get_absolute_url %}
                  <a href="{{ original.get_absolute_url }}" target="_blank" class="save-secondary">{% trans "Открыть на сайте" %}</a>
                {% endif %}

                {% if original %}
                  <a href="{% url 'admin:blog_blogpostchange' original.pk %}" class="save-secondary">{% trans "Редактировать в админке (полная страница)" %}</a>
                {% endif %}

                {% comment %} предоставить быстрый переход к ревизиям (если используются reversion) {% endcomment %}
                {% if original %}
                  {% if original.reversion_set %}
                    <a href="{% url 'admin:reversion_revision_changelist' %}?id={{ original.pk }}" class="save-secondary">{% trans "Ревизии (reversion)" %}</a>
                  {% endif %}
                {% endif %}
              </div>

            </div>
          </aside>
        </div>

        {# Hidden fields (сюда попадают prepopulated, next, и т.п.) #}
        {% for hidden in adminform.form.hidden_fields %}
          {{ hidden }}
        {% endfor %}
      </form>
    </div>
  </div>
{% endblock %}

{% block footer_extra %}
  {{ block.super }}
  <script>
    (function () {
      function qs(sel, ctx) { return (ctx || document).querySelector(sel); }
      function qsa(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }
      function nowFmt(){ return new Date().toLocaleString(); }

      // CSRF token
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken');

      // Autosave key uses app_label & model_name from template context
      const modelKey = "{{ opts.app_label }}_{{ opts.model_name }}";
      const pk = "{% if original %}{{ original.pk }}{% else %}new{% endif %}";
      const autosaveKey = "autosave:" + modelKey + ":" + pk;

      const form = qs('#post-form');
      const autosaveTime = qs('#autosave-time');
      const btnPreview = qs('#btn-preview');

      // Load autosaved data (text fields only)
      try {
        const saved = localStorage.getItem(autosaveKey);
        if (saved) {
          const data = JSON.parse(saved);
          Object.keys(data).forEach(function(name){
            const el = form.querySelector('[name="'+name+'"]');
            if (!el) return;
            if (el.type === 'checkbox') el.checked = data[name];
            else if (el.tagName === 'SELECT' && el.multiple) {
              Array.from(el.options).forEach(o => o.selected = (data[name]||[]).includes(o.value));
            } else el.value = data[name];
          });
          autosaveTime.textContent = new Date(data._autosave_time).toLocaleString();
        } else {
          autosaveTime.textContent = '—';
        }
      } catch(e){ console.warn('autosave load failed', e); }

      // Collect fields for autosave
      function collectFormData() {
        const data = {};
        Array.from(form.elements).forEach(function(el){
          if (!el.name) return;
          if (el.type === 'file') return; // skip files
          if (el.type === 'checkbox') data[el.name] = el.checked;
          else if (el.tagName === 'SELECT' && el.multiple) data[el.name] = Array.from(el.selectedOptions).map(o=>o.value);
          else data[el.name] = el.value;
        });
        data._autosave_time = new Date().toISOString();
        return data;
      }

      // Autosave every 30s
      let autosaveTimer = setInterval(function(){
        try {
          const data = collectFormData();
          localStorage.setItem(autosaveKey, JSON.stringify(data));
          autosaveTime.textContent = new Date(data._autosave_time).toLocaleString();
        } catch(e){ console.warn('autosave failed', e); }
      }, 30000);

      // Slug suggestion from title-like fields
      const titleInput = form.querySelector('[name="title"]') || form.querySelector('[name="name"]');
      const slugInput = form.querySelector('[name="slug"]');
      const slugSuggestion = qs('#slug-suggestion');

      function slugify(text){
        return (text || '').toString().toLowerCase()
          .replace(/\s+/g,'-')
          .replace(/[^\w\-]+/g,'')
          .replace(/\-\-+/g,'-')
          .replace(/^-+/, '')
          .replace(/-+$/, '');
      }
      if (titleInput && slugInput && slugSuggestion) {
        const updateSlugHint = () => {
          const hint = slugify(titleInput.value);
          slugSuggestion.textContent = hint ? ('Подсказка: ' + hint) : '{% trans "Подсказка slug" %}';
        };
        titleInput.addEventListener('input', updateSlugHint);
        updateSlugHint();
      }

      // Image preview for file input named "featured_image"
      const imageInput = form.querySelector('input[type=file][name="featured_image"]');
      const newImagePreview = qs('#new-image-preview');
      if (imageInput && newImagePreview) {
        imageInput.addEventListener('change', function(ev){
          const file = ev.target.files && ev.target.files[0];
          if (!file) { newImagePreview.style.display = 'none'; return; }
          const url = URL.createObjectURL(file);
          newImagePreview.src = url;
          newImagePreview.style.display = 'block';
        });
      }

      // Preview: create temporary form and submit via POST to preview URL if exists (uses get_absolute_url preview endpoint fallback)
      function openPreview(){
        const previewWindow = window.open('', '_blank');
        if (!previewWindow) { alert('{% trans "Поп-ап блокируется. Разрешите всплывающие окна." %}'); return; }

        const tempForm = document.createElement('form');
        tempForm.method = 'post';
        tempForm.target = previewWindow.name;
        tempForm.style.display = 'none';

        // preview URL priority: original.get_preview_url (if template context provides), else /preview/ relative, else model absolute url
        const previewUrl = "{{ original.get_preview_url|default:'' }}";
        tempForm.action = previewUrl || window.location.pathname.replace(/\/(change|add)\/?$/, '/preview/') || window.location.pathname;

        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden'; csrfInput.name = 'csrfmiddlewaretoken'; csrfInput.value = csrftoken;
        tempForm.appendChild(csrfInput);

        Array.from(form.elements).forEach(function(el){
          if (!el.name) return;
          if (el.type === 'file') return;
          if (el.type === 'checkbox') {
            const i = document.createElement('input'); i.type='hidden'; i.name=el.name; i.value = el.checked ? 'on' : '';
            tempForm.appendChild(i);
          } else if (el.tagName === 'SELECT' && el.multiple) {
            Array.from(el.selectedOptions).forEach(function(opt){
              const i = document.createElement('input'); i.type='hidden'; i.name = el.name; i.value = opt.value;
              tempForm.appendChild(i);
            });
          } else {
            const i = document.createElement('input'); i.type='hidden'; i.name=el.name; i.value = el.value;
            tempForm.appendChild(i);
          }
        });

        document.body.appendChild(tempForm);
        tempForm.submit();
        tempForm.remove();
      }

      if (btnPreview) btnPreview.addEventListener('click', openPreview);

      // Init editors if available
      function initEditors(){
        try {
          if (window.tiptap && typeof window.initTipTapEditors === 'function') window.initTipTapEditors();
          if (window.CKEDITOR && typeof window.initCkeditors === 'function') window.initCkeditors();
        } catch(e){ console.warn('editor init failed', e); }
      }
      document.addEventListener('DOMContentLoaded', initEditors);

      // Remove local autosave when user submits the form (to avoid stale draft)
      form.addEventListener('submit', function(){
        try { localStorage.removeItem(autosaveKey); } catch(e) {}
      });

    })();
  </script>
{% endblock %}
