{# admin/blog/post/change_form_fixed.html
   Полноценный change_form для модели Post с улучшенным UI:
   - единый layout (совместим с admin/base_site.html)
   - рендер стандартного adminform + инлайнов
   - сайдбар с Publish / Status / Metadata
   - JS: autosave -> localStorage, preview, slugify, image preview
#}

{% extends "admin/base_site.html" %}
{% load i18n admin_urls static widget_tweaks %}

{% block title %}{% if original %}{% blocktrans with title=original %}Change: {{ title }}{% endblocktrans %}{% else %}{% trans "Add post" %}{% endif %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {# Optionally include editor init scripts if you have them in static #}
  <script src="{% static 'admin/js/ckeditor-init.js' %}"></script>
  <script src="{% static 'admin/js/tiptap-init.js' %}"></script>

  <style>
    /* Local adjustments specific to change form to match admin-modern.css */
    .post-edit-grid { display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
    .meta-panel { position: sticky; top: 86px; }
    .field-label { font-weight:700; margin-bottom:6px; color: #0f172a; }
    .help-text { color: #6b7280; font-size:0.92rem; margin-top:6px; }
    .preview-image { max-width:100%; border-radius:8px; border:1px solid #e8eef8; margin-top:8px; }
    .autosave-indicator { font-size:0.85rem; color:#64748b; margin-left:8px; }
    .slug-auto { font-size:0.85rem; color:#475569; margin-top:6px; display:block; }
    .actions-row { display:flex; gap:10px; align-items:center; }
    .save-primary { background:var(--primary-2); color:#fff; padding:8px 12px; border-radius:8px; border:none; font-weight:700; }
    .save-secondary { background:#f3f4f6; padding:8px 12px; border-radius:8px; border:1px solid #e6eef6; }
  </style>
{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-header" style="display:flex;align-items:center;justify-content:space-between;">
      <div>
        <h1 style="margin:0;">
          {% if original %}
            {{ original }} <small style="color:var(--muted);font-weight:600;">— Редактирование</small>
          {% else %}
            <span>{% trans "Создать новый пост" %}</span>
          {% endif %}
        </h1>
        <div style="margin-top:6px;color:var(--muted);">ID: {% if original %}{{ original.pk }}{% else %}{% trans "не сохранено" %}{% endif %}</div>
      </div>

      <div class="actions-row">
        {# Standard admin save buttons (use submit_row rendered block) #}
        {% if has_delete_permission and original %}
          <a href="{% url opts|admin_urlname:'delete' original.pk %}{% if preserved_filters %}?{{ preserved_filters }}{% endif %}" class="save-secondary">{% trans "Удалить" %}</a>
        {% endif %}

        <button type="submit" form="post-form" class="save-primary" id="btn-save">{% trans "Сохранить" %}</button>

        <button type="button" class="save-secondary" id="btn-preview">{% trans "Предпросмотр" %}</button>
        <span class="autosave-indicator" id="autosave-info">{% trans "Последний автосейв:" %} <span id="autosave-time">—</span></span>
      </div>
    </div>

    <div class="card-body">
      <form id="post-form" method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        <div class="post-edit-grid">
          <section>
            {# Render non-field errors #}
            {% if adminform.non_field_errors %}
              <div class="errors">{{ adminform.non_field_errors }}</div>
            {% endif %}

            {# Main form fields (we render them grouped as in default admin: fieldsets) #}
            {% for fieldset in adminform %}
              <fieldset class="module aligned">
                {% if fieldset.name %}
                  <h2 style="margin:0 0 8px 0;font-size:16px;">{{ fieldset.name }}</h2>
                {% endif %}
                <div class="form-row">
                  {% for field in fieldset %}
                    <div class="form-row item" style="margin-bottom:14px;">
                      {% if field.is_hidden %}
                        {{ field }}
                      {% else %}
                        <div class="field-label">{{ field.label }}</div>
                        <div class="field widget-wrap">
                          {{ field|add_class:"w-full" }}
                          {% if field.errors %}
                            <div class="errors">{{ field.errors }}</div>
                          {% endif %}
                          {% if field.help_text %}
                            <div class="help-text">{{ field.help_text|safe }}</div>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              </fieldset>
            {% endfor %}

            {# Inline formsets (comments, attachments, etc.) #}
            {% for inline_admin_formset in inline_admin_formsets %}
              <div class="inline-group card" style="margin-top:18px; padding:14px;">
                <h3 style="margin:0 0 12px 0;">{{ inline_admin_formset.opts.verbose_name_plural }}</h3>
                {% for frm in inline_admin_formset %}
                  <div class="inline-related" style="margin-bottom:12px;">
                    {% for field in frm %}
                      <div style="margin-bottom:8px;">
                        {% if field.is_hidden %}
                          {{ field }}
                        {% else %}
                          <div class="field-label">{{ field.label }}</div>
                          <div class="field">{{ field }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                    {% if frm.original %}
                      <div class="help-text">ID: {{ frm.original.pk }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
                {% if inline_admin_formset.has_add_permission %}
                  <p><a class="add-related" href="#">{% trans "Добавить ещё" %} {{ inline_admin_formset.opts.verbose_name }}</a></p>
                {% endif %}
              </div>
            {% endfor %}

            {# Submit buttons at bottom too for convenience #}
            <div style="margin-top:18px;display:flex;gap:8px;">
              <button type="submit" class="save-primary">{% trans "Сохранить" %}</button>
              <a href="{% url 'admin:index' %}" class="save-secondary">{% trans "Отмена" %}</a>
            </div>
          </section>

          <aside class="meta-panel card" aria-label="Post metadata">
            <div class="card-body">
              <h3 style="margin-top:0;">{% trans "Статус" %}</h3>

              <div style="display:flex;flex-direction:column;gap:8px;">
                {# Published checkbox or status field #}
                {% if adminform.form.publish %}
                  <label class="field-label">{{ adminform.form.publish.label_tag }}</label>
                  <div>{{ adminform.form.publish }}</div>
                {% else %}
                  {# fallback to status/status_display fields #}
                  {% if original and original.get_status_display %}
                    <div class="status-badge status-green">{{ original.get_status_display }}</div>
                  {% endif %}
                {% endif %}

                {# Published date/time #}
                {% if adminform.form.published_at %}
                  <div>
                    <div class="field-label">{{ adminform.form.published_at.label }}</div>
                    <div>{{ adminform.form.published_at }}</div>
                  </div>
                {% endif %}

                {# Slug helper #}
                {% if adminform.form.slug %}
                  <div>
                    <div class="field-label">{{ adminform.form.slug.label }}</div>
                    <div>{{ adminform.form.slug }}</div>
                    <span class="slug-auto" id="slug-suggestion">{% trans "Подсказка slug будет здесь" %}</span>
                  </div>
                {% endif %}

                {# Featured image preview (if present in form) #}
                {% if adminform.form.featured_image %}
                  <div>
                    <div class="field-label">{{ adminform.form.featured_image.label }}</div>
                    <div>{{ adminform.form.featured_image }}</div>
                    {% if original and original.featured_image %}
                      <img src="{{ original.featured_image.url }}" alt="preview" class="preview-image" id="existing-image-preview" />
                    {% else %}
                      <img src="" alt="" class="preview-image" id="new-image-preview" style="display:none;" />
                    {% endif %}
                  </div>
                {% endif %}

                {# Author / Created info #}
                <div style="margin-top:12px;">
                  <div class="field-label">{% trans "Автор" %}</div>
                  <div style="color:var(--muted);">
                    {% if original %}{{ original.author }}{% else %}{% trans "Не указано" %}{% endif %}
                  </div>

                  <div class="field-label" style="margin-top:8px;">{% trans "Создано" %}</div>
                  <div style="color:var(--muted);">
                    {% if original and original.created_at %}{{ original.created_at|date:"SHORT_DATETIME_FORMAT" }}{% else %}—{% endif %}
                  </div>
                </div>

                {# Preview link (will POST current draft to preview if possible) #}
                <div style="margin-top:12px;">
                  <button type="button" id="btn-preview-sidebar" class="save-secondary">{% trans "Открыть предпросмотр" %}</button>
                </div>
              </div>

              <hr style="margin:12px 0;" />

              <div>
                <h4 style="margin:0 0 8px 0;">{% trans "Дополнительно" %}</h4>
                <div style="font-size:0.95rem;color:var(--muted);">
                  {% if original and original.pk %}
                    <div>{% trans "URL:" %} <br /><a href="{{ original.get_absolute_url }}" target="_blank">{{ original.get_absolute_url }}</a></div>
                    <div style="margin-top:8px;">ID: {{ original.pk }}</div>
                  {% else %}
                    <div>{% trans "Запись ещё не сохранена" %}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </aside>
        </div>

        {# Render hidden fields Django admin needs (prepopulated fields etc.) #}
        {% for hidden in adminform.form.hidden_fields %}
          {{ hidden }}
        {% endfor %}
      </form>
    </div>
  </div>
{% endblock %}

{% block footer_extra %}
  {{ block.super }}
  <script>
    (function () {
      // Basic helpers
      function qs(sel, ctx) { return (ctx || document).querySelector(sel); }
      function qsa(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }
      function nowFmt(){ return new Date().toLocaleString(); }

      // CSRF token setup for AJAX if needed
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken');

      // autosave to localStorage (safe, no server calls). Keyed by admin model & pk (or "new")
      const modelKey = "{{ opts.app_label }}_{{ opts.model_name }}";
      const pk = "{% if original %}{{ original.pk }}{% else %}new{% endif %}";
      const autosaveKey = "autosave:" + modelKey + ":" + pk;

      const form = qs('#post-form');
      const autosaveInfo = qs('#autosave-info');
      const autosaveTime = qs('#autosave-time');
      const btnSave = qs('#btn-save');
      const btnPreview = qs('#btn-preview');
      const btnPreviewSidebar = qs('#btn-preview-sidebar');

      // Load autosaved data (if any) into inputs
      try {
        const saved = localStorage.getItem(autosaveKey);
        if (saved) {
          const data = JSON.parse(saved);
          Object.keys(data).forEach(function(name){
            const el = form.querySelector('[name="'+name+'"]');
            if (!el) return;
            if (el.type === 'checkbox') el.checked = data[name];
            else if (el.tagName === 'SELECT' && el.multiple) {
              Array.from(el.options).forEach(o => o.selected = (data[name]||[]).includes(o.value));
            } else el.value = data[name];
          });
          autosaveTime.textContent = new Date(data._autosave_time).toLocaleString();
        } else {
          autosaveTime.textContent = '—';
        }
      } catch(e){ console.warn('autosave load failed', e); }

      // Collect form fields to save
      function collectFormData() {
        const data = {};
        Array.from(form.elements).forEach(function(el){
          if (!el.name) return;
          if (el.type === 'file') return; // skip files for localStorage
          if (el.type === 'checkbox') data[el.name] = el.checked;
          else if (el.tagName === 'SELECT' && el.multiple) data[el.name] = Array.from(el.selectedOptions).map(o=>o.value);
          else data[el.name] = el.value;
        });
        data._autosave_time = new Date().toISOString();
        return data;
      }

      // Autosave interval
      let autosaveTimer = setInterval(function(){
        try {
          const data = collectFormData();
          localStorage.setItem(autosaveKey, JSON.stringify(data));
          autosaveTime.textContent = new Date(data._autosave_time).toLocaleString();
        } catch(e){ console.warn('autosave failed', e); }
      }, 30000); // every 30s

      // Slug suggestion: from title
      const titleInput = form.querySelector('[name="title"]') || form.querySelector('[name="name"]');
      const slugInput = form.querySelector('[name="slug"]');
      const slugSuggestion = qs('#slug-suggestion');

      function slugify(text){
        return (text || '').toString().toLowerCase()
          .replace(/\s+/g,'-')
          .replace(/[^\w\-]+/g,'')
          .replace(/\-\-+/g,'-')
          .replace(/^-+/, '')
          .replace(/-+$/, '');
      }
      if (titleInput && slugInput && slugSuggestion) {
        const updateSlugHint = () => {
          const hint = slugify(titleInput.value);
          slugSuggestion.textContent = hint ? ('Подсказка: ' + hint) : '{% trans "Подсказка slug будет здесь" %}';
        };
        titleInput.addEventListener('input', updateSlugHint);
        updateSlugHint();
      }

      // Image preview for file inputs named like featured_image
      const imageInput = form.querySelector('input[type=file][name="featured_image"]') || form.querySelector('input[type=file].featured_image');
      const newImagePreview = qs('#new-image-preview');
      if (imageInput && newImagePreview) {
        imageInput.addEventListener('change', function(ev){
          const file = ev.target.files && ev.target.files[0];
          if (!file) { newImagePreview.style.display = 'none'; return; }
          const url = URL.createObjectURL(file);
          newImagePreview.src = url;
          newImagePreview.style.display = 'block';
        });
      }

      // Preview: we create a temporary form and POST it to a new window (to use server-side preview if route exists)
      function openPreview(){
        // try to find preview url on model: preview_url or original.get_absolute_url? fallback to opening a new blank window with form content.
        const previewWindow = window.open('', '_blank');
        if (!previewWindow) { alert('{% trans "Поп-ап блокируется. Разрешите всплывающие окна для этого сайта." %}'); return; }

        // create a form, clone inputs (except files) and post to preview endpoint if provided; otherwise show raw title/content.
        const tempForm = document.createElement('form');
        tempForm.method = 'post';
        tempForm.target = previewWindow.name;
        tempForm.style.display = 'none';

        // use preview endpoint if defined in DOM via data attribute
        const previewUrl = "{{ original.get_preview_url|default:'' }}";
        tempForm.action = previewUrl || window.location.pathname.replace(/\/change\/?$/, '/preview/') || window.location.pathname;

        // csrf
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden'; csrfInput.name = 'csrfmiddlewaretoken'; csrfInput.value = csrftoken;
        tempForm.appendChild(csrfInput);

        // append textual fields only
        Array.from(form.elements).forEach(function(el){
          if (!el.name) return;
          if (el.type === 'file') return;
          if (el.type === 'checkbox') {
            const i = document.createElement('input'); i.type='hidden'; i.name=el.name; i.value = el.checked ? 'on' : '';
            tempForm.appendChild(i);
          } else if (el.tagName === 'SELECT' && el.multiple) {
            Array.from(el.selectedOptions).forEach(function(opt){
              const i = document.createElement('input'); i.type='hidden'; i.name = el.name; i.value = opt.value;
              tempForm.appendChild(i);
            });
          } else {
            const i = document.createElement('input'); i.type='hidden'; i.name=el.name; i.value = el.value;
            tempForm.appendChild(i);
          }
        });

        document.body.appendChild(tempForm);
        tempForm.submit();
        tempForm.remove();
      }

      // Bind preview buttons
      if (btnPreview) btnPreview.addEventListener('click', openPreview);
      if (btnPreviewSidebar) btnPreviewSidebar.addEventListener('click', openPreview);

      // If TipTap or CKEditor initialization script exists, try to initialize editors in page
      function initEditors(){
        try {
          if (window.tiptap && typeof window.initTipTapEditors === 'function') {
            window.initTipTapEditors(); // your static admin js may provide this
          }
          if (window.CKEDITOR && typeof window.initCkeditors === 'function') {
            window.initCkeditors();
          }
        } catch(e){
          // ignore
        }
      }
      document.addEventListener('DOMContentLoaded', initEditors);

      // Clean up autosave on real save (when form successfully submits server-side, user will be redirected; but to be safe we remove key on submit)
      form.addEventListener('submit', function(){
        try { localStorage.removeItem(autosaveKey); } catch(e) {}
      });

      // Show autosave timestamp initially
      if (!autosaveTime.textContent || autosaveTime.textContent === '—') {
        autosaveTime.textContent = '—';
      }

    })();
  </script>
{% endblock %}
