{# backend/templates/admin/media_library.html #}
{% extends "admin/base_site.html" %}
{% load static %}
{% block extrastyle %}
<link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
{% endblock %}

{% block content %}
<div class="media-lib-wrap card" role="main" style="padding:18px;">
  <div style="display:flex;align-items:center;gap:12px;justify-content:space-between;">
    <h1 style="margin:0">Медиа-библиотека</h1>
    <div style="display:flex;gap:8px;align-items:center;">
      <input id="media-search" class="media-search" placeholder="Поиск..." style="padding:8px;border-radius:8px;border:1px solid var(--border);"/>
      <button id="refresh-btn" class="button-secondary small-btn">Обновить</button>
      <button id="upload-open-btn" class="button">Загрузить</button>
    </div>
  </div>

  <div id="upload-area" style="margin-top:14px; display:flex; gap:12px; align-items:stretch;">
    <div id="dropzone" class="card" style="flex:1; min-height:140px; display:flex; align-items:center; justify-content:center; border:2px dashed var(--border); background:#fbfdff;">
      <div style="text-align:center; color:var(--muted);">
        <div style="font-weight:700">Перетащите файлы сюда</div>
        <div style="font-size:13px; margin-top:6px">или нажмите «Загрузить»</div>
      </div>
    </div>

    <div style="width:320px; display:flex;flex-direction:column; gap:8px;">
      <div class="card" style="padding:12px;">
        <div style="font-weight:700; color:var(--muted); margin-bottom:8px">Фильтры</div>
        <label style="display:flex;gap:8px;align-items:center;">
          <input id="filter-unattached" type="checkbox" />
          Показывать только не привязанные к постам
        </label>
      </div>

      <div id="upload-progress-list" class="card" style="padding:8px; min-height:60px;">
        <!-- полосы прогресса -->
      </div>
    </div>
  </div>

  <div id="media-grid" class="media-grid" aria-live="polite" style="margin-top:16px; display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px;">
    {% for a in attachments %}
      <div class="media-item card" data-id="{{ a.id }}" data-url="{{ a.url|default:'' }}" data-title="{{ a.title|default:'' }}" data-filename="{{ a.filename|default:'' }}" style="display:flex;gap:12px; padding:12px; align-items:center;">
        <div class="media-thumb" style="width:96px; height:72px; border-radius:8px; overflow:hidden; display:flex;align-items:center;justify-content:center; background:#f8fafc;">
          {% if a.url %}
            <img src="{{ a.url }}" alt="{{ a.title|default:a.filename }}" style="width:100%;height:100%;object-fit:cover;" />
          {% else %}
            <div style="padding:8px;color:#6b7280">{{ a.filename|default:"файл" }}</div>
          {% endif %}
        </div>
        <div style="flex:1; display:flex;flex-direction:column;gap:6px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:700;">{{ a.title|default:a.filename }}</div>
            <div style="font-size:12px; color:var(--muted);">{{ a.uploaded_at|default:"" }}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="small-btn select-btn">Выбрать</button>
            {% if a.url %}
              <a href="{{ a.url }}" class="small-btn" target="_blank">Открыть</a>
            {% endif %}
            <button class="small-btn delete-btn" data-id="{{ a.id }}">Удалить</button>
          </div>
        </div>
      </div>
    {% empty %}
      <div style="grid-column:1/-1;padding:18px;color:#6b7280">Файлов нет.</div>
    {% endfor %}
  </div>

  {# Hidden file input — если в static/js что-то не сработает, мы создадим input программно в JS.
     Оставим элемент для совместимости. #}
  <input id="file-input" type="file" style="display:none" multiple />
</div>

{# Подключаем основной скрипт (static) и затем — небольшая диагностическая обвязка inline.
   Inline скрипт гарантирует, что даже если static/js не загрузился, кнопка будет работать —
   он создаёт input если его нет и пытается привязать обработчики. #}
<script src="{% static 'admin/media-library.js' %}"></script>

<script>
(function(){
  // very small defensive initializer — runs after DOM, tries to attach fallback handlers if main script failed
  try {
    document.addEventListener('DOMContentLoaded', function () {
      // basic logging
      console.log('[media-library] inline initializer running');

      // ensure file-input exists (fallback)
      var fileInput = document.getElementById('file-input');
      if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.multiple = true;
        fileInput.id = 'file-input';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        console.log('[media-library] created fallback file-input');
      }

      // ensure upload button exists and attach click (defensive)
      var uploadBtn = document.getElementById('upload-open-btn');
      if (uploadBtn) {
        uploadBtn.removeEventListener('click', window._media_fallback_click, false);
        window._media_fallback_click = function (e) {
          e.preventDefault();
          console.log('[media-library] upload button clicked (fallback) — opening file dialog');
          fileInput.click();
        };
        uploadBtn.addEventListener('click', window._media_fallback_click, false);
      } else {
        console.warn('[media-library] upload-open-btn not found in DOM');
      }

      // attach a very simple filechange handler if none exists
      if (!fileInput._hasFallbackHandler) {
        fileInput.addEventListener('change', function (e) {
          console.log('[media-library] fallback file input change — files:', e.target.files && e.target.files.length);
          // if main script provides window.uploadFiles, use it; otherwise, try a simple fetch as test
          if (window.uploadFiles && typeof window.uploadFiles === 'function') {
            window.uploadFiles(e.target.files);
          } else {
            console.warn('[media-library] uploadFiles() not available on window — main script probably failed to initialize');
            alert('JS загрузки не инициализирован. Откройте консоль и пришлите ошибки (Console / Network).');
          }
          // reset
          fileInput.value = '';
        });
        fileInput._hasFallbackHandler = true;
      }

      // attach basic drop handlers (fallback)
      var drop = document.getElementById('dropzone');
      if (drop) {
        drop.addEventListener('dragover', function (ev) { ev.preventDefault(); drop.style.borderColor = 'var(--primary)'; });
        drop.addEventListener('dragleave', function (ev) { ev.preventDefault(); drop.style.borderColor = ''; });
        drop.addEventListener('drop', function (ev) {
          ev.preventDefault();
          drop.style.borderColor = '';
          var dt = ev.dataTransfer;
          if (dt && dt.files && dt.files.length) {
            if (window.uploadFiles && typeof window.uploadFiles === 'function') {
              window.uploadFiles(dt.files);
            } else {
              console.warn('[media-library] uploadFiles() not available — cannot upload dropped files');
              alert('JS загрузки не инициализирован. Откройте консоль и пришлите ошибки (Console / Network).');
            }
          }
        });
      }

    });
  } catch (err) {
    console.error('[media-library] inline initializer error', err);
  }
})();
</script>

{% endblock %}
