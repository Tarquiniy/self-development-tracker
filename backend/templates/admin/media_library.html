{% extends 'admin/base_site.html' %}
{% load static %}

{% block content %}
  <h1>Media Library</h1>
  <p>Загрузите файл или выберите существующий для вставки в редактор.</p>

  <form id="media-upload-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="file" name="file" id="media-file-input">
    <input type="text" name="title" placeholder="Название (опционально)">
    <button type="submit">Загрузить</button>
  </form>

  <hr/>
  <div id="media-list">
    {% for a in attachments %}
      <div class="media-item" data-url="{{ a.file.url }}" data-id="{{ a.id }}">
        <img src="{{ a.file.url }}" alt="{{ a.title }}" style="max-width:120px;max-height:80px;object-fit:cover">
        <div>{{ a.title }}</div>
      </div>
    {% empty %}
      <p>Нет файлов</p>
    {% endfor %}
  </div>

  <script>
    (function(){
      const form = document.getElementById('media-upload-form');
      form.addEventListener('submit', function(e){
        e.preventDefault();
        const fd = new FormData(form);
        fetch(window.location.href, {method: 'POST', body: fd, headers:{'X-Requested-With':'XMLHttpRequest'}})
          .then(r => r.json()).then(j => {
            if (j.success) alert('Загружено: ' + j.url);
            else alert('Ошибка: ' + (j.error||JSON.stringify(j)));
          });
      });
    })();
  </script>

{% endblock %}
