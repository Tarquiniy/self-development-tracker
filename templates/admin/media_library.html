{% extends "admin/base_site.html" %}
{% load i18n %}
{% block content %}
  <h1>{% trans "Media Library" %}</h1>

  <form id="uploadForm" enctype="multipart/form-data" method="post">
    {% csrf_token %}
    <input type="file" name="file" id="fileInput" />
    <input type="text" name="title" placeholder="{% trans 'Title (optional)' %}" />
    <button type="submit" class="button button-primary">{% trans "Upload" %}</button>
  </form>

  <hr/>

  <div id="attachments" class="media-grid">
    {% for a in attachments %}
      <div class="media-item" data-url="{{ a.file.url }}">
        <div class="media-thumb">
          <img src="{{ a.file.url }}" alt="{{ a.title }}" />
        </div>
        <div class="media-title">{{ a.title }}</div>
        <div class="media-meta">
          <span>{{ a.file_size|filesizeformat }}</span>
          <button class="button button-secondary" onclick="insertToEditor('{{ a.file.url }}')">{% trans "Insert" %}</button>
        </div>
      </div>
    {% empty %}
      <div>{% trans "No files" %}</div>
    {% endfor %}
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const resp = await fetch("", {
        method: "POST",
        body: new FormData(uploadForm),
        headers: {'X-Requested-With': 'XMLHttpRequest'}
      });
      const data = await resp.json();
      if (data.success) {
        alert('{% trans "Uploaded successfully." %}');
        location.reload();
      } else {
        alert('{% trans "Error" %}: ' + (data.error||'{% trans "Unknown" %}'));
      }
    });

    function insertToEditor(url) {
      if (window.opener) {
        try {
          const fg = window.opener.document.querySelector('input[name="featured_image"]');
          if (fg) {
            fg.value = url;
            window.close();
            return;
          }
          const cnt = window.opener.document.querySelector('textarea[name="content"]');
          if (cnt) {
            cnt.value = (cnt.value || '') + "\\n<img src='" + url + "' />\\n";
            window.close();
            return;
          }
        } catch (e) { console.error(e); }
      }
      alert('{% trans "Cannot insert image. Please open media library from a post edit form." %}');
    }
  </script>
{% endblock %}
