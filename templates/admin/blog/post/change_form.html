{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{# Change form with CKEditor5 integration + media-library hook #}
{% block title %}{% if is_popup %}{% trans 'Изменить элемент' %}{% else %}{% trans 'Редактировать пост' %}{% endif %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {{ adminform.media }} {# подключаем media виджетов если есть #}

  {# CKEditor 5 Classic build (CDN). Если хочешь локально — замени на статический файл. #}
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

  <style>
    /* небольшие правки стилей для админ-формы */
    .ck-editor__editable_inline { min-height: 260px; background: #fff; color: #111; border-radius:6px; padding:12px; }
    .editor-wrapper { margin: 8px 0 16px 0; }
    .media-button { margin-left: .5rem; }
  </style>
{% endblock %}

{% block content %}
  <div class="change-form">
    <div class="form-header">
      <h1>{{ original|default:_('Новый пост') }}</h1>
      <div class="form-actions">
        <button type="button" class="btn" id="preview-btn">Предпросмотр</button>
        <a class="btn btn-ghost" href="{% url 'admin:blog_post_changelist' %}">Отмена</a>
        <a href="{% url 'admin-media-library' %}" class="btn btn-ghost media-button" id="open-media-lib" onclick="return openMediaLibrary(event)">Медиатека</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate class="nice-form">{% csrf_token %}
      <div class="form-grid">
        <div class="panel main-panel">
          {% for fieldset in adminform %}
            <fieldset class="fieldset">
              {% if fieldset.name %}<legend>{{ fieldset.name }}</legend>{% endif %}
              <div class="fieldset-grid">
                {% for line in fieldset %}
                  <div class="form-row">{{ line }}</div>
                {% endfor %}
              </div>
            </fieldset>
          {% endfor %}
        </div>

        <aside class="panel side-panel">
          <div class="meta">
            <h3>Опубликовать</h3>
            {{ adminform.form.publish_status }}
            <div class="field">
              <label>Изображение</label>
              {{ adminform.form.image }}
              <div id="image-preview" class="image-preview"></div>
            </div>
            <div class="field">
              {{ adminform.form.categories }}
            </div>
          </div>
        </aside>
      </div>

      <div class="form-footer">
        <input type="submit" value="Сохранить" class="btn-primary">
        <input type="submit" name="_continue" value="Сохранить и продолжить" class="btn">
        <a class="btn btn-ghost" href="{% url 'admin:blog_post_changelist' %}">Вернуться</a>
      </div>
    </form>
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Конфигируемые endpoints (передайте в контекст шаблона если они другие)
  const MEDIA_UPLOAD_URL = "{{ media_upload_url|default:'/api/media/upload/' }}";
  const MEDIA_LIST_URL   = "{{ media_list_url|default:'/api/media/list/' }}";

  // CSRF helper
  function getCSRF() {
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : null;
  }

  // Мап редакторов, доступен глобально
  window.editorMap = window.editorMap || {};

  // Популярные имена полей, которые мы попытаемся превратить в CKEditor
  const CANDIDATES = ['content', 'short_description', 'body', 'description', 'summary'];

  // UploadAdapter для CKEditor (загружает файл на MEDIA_UPLOAD_URL и ожидает JSON {url: "..."})
  class SupabaseUploadAdapter {
    constructor(loader){
      this.loader = loader;
    }
    upload() {
      return this.loader.file.then(file => new Promise((resolve, reject) => {
        const fd = new FormData();
        fd.append('file', file);
        // Если требуется, можно добавить bucket/params здесь: fd.append('bucket', '...')

        fetch(MEDIA_UPLOAD_URL, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {
            'X-CSRFToken': getCSRF() || ''
          },
          body: fd
        }).then(async res => {
          if(!res.ok){
            let text;
            try { text = await res.text(); } catch(e){ text = res.statusText; }
            reject(text || 'Upload failed');
            return;
          }
          const json = await res.json();
          // ожидаем { url: "https://..." }
          if(json && json.url){
            resolve({ default: json.url });
          } else {
            reject('Invalid upload response');
          }
        }).catch(err => reject(err.message || String(err)));
      }));
    }
    abort() {
      // optional: поддержка отмены
    }
  }

  function SupabaseAdapterPlugin(editor) {
    editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
      return new SupabaseUploadAdapter(loader);
    };
  }

  // Инициализация CKEditor для найденных textarea
  function initEditors() {
    CANDIDATES.forEach(name => {
      const ta = document.querySelector('textarea[name="' + name + '"]');
      if(!ta) return;
      // Если редактор уже инициализирован, пропустить
      if(window.editorMap[name]) return;

      ClassicEditor.create(ta, {
        extraPlugins: [SupabaseAdapterPlugin],
        toolbar: [
          'heading','|',
          'bold','italic','underline','strikethrough','|',
          'link','bulletedList','numberedList','blockQuote','|',
          'insertTable','mediaEmbed','imageUpload','|',
          'undo','redo'
        ],
        language: 'ru',
        image: {
          toolbar: ['imageTextAlternative','imageStyle:inline','imageStyle:block','imageStyle:side']
        }
      }).then(editor => {
        window.editorMap[name] = editor;
        // при необходимости можно экспортировать для других скриптов
      }).catch(err => console.error('CKEditor init error for', name, err));
    });
  }

  // Попытаться инициализировать на DOMContentLoaded (админка может подгружать формы асинхронно)
  document.addEventListener('DOMContentLoaded', initEditors);
  // Также вызов через setTimeout + ready, на случай динамического рендера
  setTimeout(initEditors, 600);

  // Функция, которую медиабиблиотека вызывает для вставки изображения в активный редактор
  window.__insertMediaToEditor = function(url, preferField){
    try {
      preferField = preferField || 'content';
      if(window.editorMap && window.editorMap[preferField]){
        const editor = window.editorMap[preferField];
        // вставка изображения через модель (CKEditor5)
        editor.model.change(writer => {
          const imageElement = writer.createElement('image', { src: url });
          editor.model.insertContent(imageElement, editor.model.document.selection);
        });
        return true;
      }
      // fallback: найдем любой редактор
      for(const k in window.editorMap){
        const ed = window.editorMap[k];
        if(ed){
          ed.model.change(writer => {
            const imageElement = writer.createElement('image', { src: url });
            ed.model.insertContent(imageElement, ed.model.document.selection);
          });
          return true;
        }
      }
      // fallback: вставка в textarea
      const ta = document.querySelector('textarea[name="'+preferField+'"]') || document.querySelector('textarea');
      if(ta){
        ta.value = (ta.value || '') + "\\n<img src='" + url + "' alt=''/>\\n";
        return true;
      }
    } catch(e){
      console.warn('insertMediaToEditor failed', e);
    }
    return false;
  };

  // Кнопка "Медиатека" (открывает твой маршрут admin-media-library в popup)
  window.openMediaLibrary = function(e){
    try {
      if(e && e.preventDefault) e.preventDefault();
      const url = "{% url 'admin-media-library' %}";
      window.open(url, "media_library", "width=1000,height=700,scrollbars=yes");
    } catch(err){
      console.error('openMediaLibrary error', err);
      alert("{% trans 'Не удалось открыть медиа библиотеку' %}");
    }
    return false;
  };

  // Предпросмотр: собираем данные из редакторов (если есть) и открываем новое окно с HTML
  const previewBtn = document.getElementById('preview-btn');
  if(previewBtn){
    previewBtn.addEventListener('click', function(){
      const form = document.querySelector('form.nice-form');
      if(!form) return;
      const title = (form.querySelector('[name=title]') || {}).value || '';
      // соберём контент: prefer 'content'
      let content = '';
      if(window.editorMap['content']) content = window.editorMap['content'].getData();
      else {
        const ta = form.querySelector('textarea[name="content"]');
        content = ta ? ta.value : '';
      }
      let short = '';
      if(window.editorMap['short_description']) short = window.editorMap['short_description'].getData();
      else {
        const ta2 = form.querySelector('textarea[name="short_description"]');
        short = ta2 ? ta2.value : '';
      }

      const w = window.open('', '_blank');
      const html = `
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8">
            <title>Предпросмотр — ${escapeHtml(title)}</title>
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
          </head>
          <body>
            <article class="container preview-article">
              <h1>${escapeHtml(title)}</h1>
              <section class="preview-short">${short}</section>
              <section class="preview-content">${content}</section>
            </article>
          </body>
        </html>`;
      w.document.open();
      w.document.write(html);
      w.document.close();
    });
  }

  function escapeHtml(s){
    return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  // Перед отправкой формы — синхронизируем содержимое редакторов в соответствующие textarea
  document.addEventListener('submit', function(e){
    const form = e.target;
    if(!(form && form.matches && form.matches('form.nice-form'))) return;
    try {
      for(const name of CANDIDATES){
        if(window.editorMap[name]){
          const ta = form.querySelector('textarea[name="'+name+'"]');
          if(ta){
            ta.value = window.editorMap[name].getData();
          }
        }
      }
    } catch(err){ console.warn('sync editors before submit failed', err); }
  }, true);

})();
</script>
{% endblock %}
