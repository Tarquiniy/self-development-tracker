{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{# Clean CKEditor5 integration for Post change form #}
{% block title %}{% if is_popup %}{% trans 'Изменить элемент' %}{% else %}{% trans 'Редактировать пост' %}{% endif %}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {{ adminform.media }} {# подключим media из формы, если есть #}

  {# CKEditor5 Classic (CDN). Если у тебя запрещён CDN, скажи — подготовлю локальную сборку. #}
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

  <style>
    .ck-editor__editable_inline { min-height: 260px; background: #fff; color: #111; border-radius:6px; padding:12px; }
    .editor-wrapper { margin: 8px 0 16px 0; }
    .media-button { margin-left: .5rem; }
    .preview-article { padding: 24px; max-width: 900px; margin: 0 auto; }
  </style>
{% endblock %}

{% block content %}
  <div class="change-form">
    <div class="form-header">
      <h1>{{ original|default:_('Новый пост') }}</h1>
      <div class="form-actions">
        <button type="button" class="btn" id="preview-btn">Предпросмотр</button>
        <a class="btn btn-ghost" href="{% url 'admin:blog_post_changelist' %}">Отмена</a>
        <a href="{% url 'admin-media-library' %}" class="btn btn-ghost media-button" id="open-media-lib" onclick="return openMediaLibrary(event)">Медиатека</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate class="nice-form">{% csrf_token %}
      <div class="form-grid">
        <div class="panel main-panel">
          {% for fieldset in adminform %}
            <fieldset class="fieldset">
              {% if fieldset.name %}<legend>{{ fieldset.name }}</legend>{% endif %}
              <div class="fieldset-grid">
                {% for line in fieldset %}
                  <div class="form-row">{{ line }}</div>
                {% endfor %}
              </div>
            </fieldset>
          {% endfor %}
        </div>

        <aside class="panel side-panel">
          <div class="meta">
            <h3>Опубликовать</h3>
            {{ adminform.form.publish_status }}
            <div class="field">
              <label>Изображение</label>
              {{ adminform.form.image }}
              <div id="image-preview" class="image-preview"></div>
            </div>
            <div class="field">
              {{ adminform.form.categories }}
            </div>
          </div>
        </aside>
      </div>

      <div class="form-footer">
        <input type="submit" value="Сохранить" class="btn-primary">
        <input type="submit" name="_continue" value="Сохранить и продолжить" class="btn">
        <a class="btn btn-ghost" href="{% url 'admin:blog_post_changelist' %}">Вернуться</a>
      </div>
    </form>
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // значения можно подставить из extra_context в admin.py (мы добавили media_upload_url/media_list_url туда)
  const MEDIA_UPLOAD_URL = "{{ media_upload_url|default:'/api/media/upload/' }}";
  const MEDIA_LIST_URL   = "{{ media_list_url|default:'/api/media/list/' }}";

  function getCSRF(){
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : null;
  }

  // карта редакторов
  window.editorMap = window.editorMap || {};
  let lastFocusedEditorName = null;

  // имена полей, которые будем превращать в CKEditor
  const CANDIDATES = ['content','short_description','body','description','summary'];

  // Инициализация CKEditor для найденных textarea
  function initCKEditors(){
    CANDIDATES.forEach(name => {
      const ta = document.querySelector('textarea[name="'+name+'"]');
      if(!ta) return;
      if(window.editorMap[name]) return; // уже инициализирован

      // Создаём редактор **без** встроенного imageUpload, чтобы не требовать upload-endpoint.
      ClassicEditor.create(ta, {
        toolbar: [
          'heading','|','bold','italic','underline','strikethrough','|',
          'link','bulletedList','numberedList','blockQuote','|',
          'insertTable','mediaEmbed','|','undo','redo'
        ],
        language: 'ru'
      }).then(editor => {
        window.editorMap[name] = editor;
        // track focus
        editor.model.document.on('change:data', () => {
          // nothing — data changed
        });
        editor.editing.view.document.on('focus', () => { lastFocusedEditorName = name; });
      }).catch(err => console.error('CKEditor init error for', name, err));
    });
  }

  // init on DOM ready and shortly after (admin may render fields late)
  document.addEventListener('DOMContentLoaded', initCKEditors);
  setTimeout(initCKEditors, 600);

  // контракт: медиапопап вызывает эту функцию у opener'а
  // window.opener.__insertMediaToEditor(url) — popup должен вызвать так
  window.__insertMediaToEditor = function(url, preferField){
    try {
      preferField = preferField || lastFocusedEditorName || 'content';
      // preferred by name
      if(window.editorMap && window.editorMap[preferField]){
        const editor = window.editorMap[preferField];
        editor.model.change(writer => {
          const imageElement = writer.createElement('image', { src: url });
          editor.model.insertContent(imageElement, editor.model.document.selection);
        });
        return true;
      }
      // fallback: any editor
      for(const k in window.editorMap){
        const ed = window.editorMap[k];
        if(ed){
          ed.model.change(writer => {
            const imageElement = writer.createElement('image', { src: url });
            ed.model.insertContent(imageElement, ed.model.document.selection);
          });
          return true;
        }
      }
      // fallback: plain textarea
      const ta = document.querySelector('textarea[name="'+(preferField||'content')+'"]') || document.querySelector('textarea');
      if(ta){ ta.value = (ta.value || '') + "\\n<img src='" + url + "' alt=''/>\\n"; return true; }
    } catch(e){ console.warn('insertMediaToEditor failed', e); }
    return false;
  };

  // open media library popup
  window.openMediaLibrary = function(e){
    try {
      if(e && e.preventDefault) e.preventDefault();
      const url = "{% url 'admin-media-library' %}";
      window.open(url, "media_library", "width=1000,height=700,scrollbars=yes");
    } catch(err) {
      console.error('openMediaLibrary error', err);
      alert("{% trans 'Не удалось открыть медиа библиотеку' %}");
    }
    return false;
  };

  // preview — собираем данные и показываем
  const previewBtn = document.getElementById('preview-btn');
  if(previewBtn){
    previewBtn.addEventListener('click', function(){
      const form = document.querySelector('form.nice-form');
      if(!form) return;
      const title = (form.querySelector('[name=title]') || {}).value || '';
      let content = '';
      if(window.editorMap['content']) content = window.editorMap['content'].getData();
      else { const t = form.querySelector('textarea[name="content"]'); content = t ? t.value : ''; }
      let short = '';
      if(window.editorMap['short_description']) short = window.editorMap['short_description'].getData();
      else { const s = form.querySelector('textarea[name="short_description"]'); short = s ? s.value : ''; }

      const w = window.open('', '_blank');
      const html = `
        <!doctype html><html><head><meta charset="utf-8"><title>Предпросмотр — ${escapeHtml(title)}</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
        </head><body><article class="container preview-article">
        <h1>${escapeHtml(title)}</h1>
        <section class="preview-short">${short}</section>
        <section class="preview-content">${content}</section>
        </article></body></html>`;
      w.document.open(); w.document.write(html); w.document.close();
    });
  }

  function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // Перед отправкой формы — синхронизируем содержимое редакторов в textarea
  document.addEventListener('submit', function(e){
    const form = e.target;
    if(!(form && form.matches && form.matches('form.nice-form'))) return;
    try {
      for(const name of CANDIDATES){
        if(window.editorMap[name]){
          const ta = form.querySelector('textarea[name="'+name+'"]');
          if(ta){ ta.value = window.editorMap[name].getData(); }
        }
      }
    } catch(err){ console.warn('sync editors before submit failed', err); }
  }, true);

})();
</script>
{% endblock %}
