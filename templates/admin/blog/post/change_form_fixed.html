{% extends "admin/change_form.html" %}
{% load i18n static admin_urls %}

{% block extrahead %}
  {{ block.super }}
  {{ adminform.media }}
  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
  <style>
    /* –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∞—à—É —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É */
    :root{ --pt-maxw:1200px; --pt-sidebar-w:360px; --pt-gap:18px; }
    .post-editor-modern { max-width:var(--pt-maxw); margin:12px auto; padding:0 16px; box-sizing:border-box; overflow-x:hidden; color:#0f1724; }
    .header-content{display:flex;align-items:center;gap:12px;width:100%}
    .header-title{flex:1 1 auto;min-width:0}
    .header-actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;white-space:nowrap;flex-wrap:wrap}
    .editor-main{display:grid;grid-template-columns:1fr var(--pt-sidebar-w);gap:var(--pt-gap);align-items:start;width:100%}
    aside{width:var(--pt-sidebar-w);min-width:240px;box-sizing:border-box}
    .editor-card{background:#fff;border-radius:10px;padding:14px;box-sizing:border-box;border:1px solid rgba(11,17,32,0.04)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;border:1px solid rgba(11,17,32,0.06);background:#f8fafc;color:#0f172a;font-weight:600;cursor:pointer;text-decoration:none}
    .btn-primary{background:#0b5fff;color:#fff;border-color:#0846d8;box-shadow:0 6px 18px rgba(11,85,255,0.12)}
    .char-counter{ text-align:right;font-size:12px;color:#6b7280;margin-top:6px; }
    @media (max-width:1024px){ .editor-main{grid-template-columns:1fr} aside{width:100%} .header-actions{justify-content:flex-start} }
  </style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <header class="editor-header">
    <div class="header-content">
      <div class="header-title">
        <h1 style="margin:0;font-size:20px;color:#0f172a;">
          {% if original %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ original.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:60 }}{% else %}üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞{% endif %}
        </h1>
      </div>

      <div class="header-actions" role="toolbar" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
        <button type="button" class="btn btn-primary" id="pt-save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn" id="pt-continue-btn">üîÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <a href="{% url 'admin:blog_post_changelist' %}" class="btn" title="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.media }}

    <div class="editor-main">
      <div>
        <div class="editor-card" style="margin-bottom:14px;">
          <div style="margin-bottom:12px;">
            {{ adminform.form.title.label_tag }}{{ adminform.form.title }}
            {% if adminform.form.title.errors %}<div class="error">{{ adminform.form.title.errors }}</div>{% endif %}
          </div>
          <div>
            {{ adminform.form.slug.label_tag }}
            <div style="display:flex;gap:8px;align-items:center;">
              {{ adminform.form.slug }}
              <button type="button" class="btn" id="generate-slug">üîÑ</button>
            </div>
            <div class="help-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL</div>
            {% if adminform.form.slug.errors %}<div class="error">{{ adminform.form.slug.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 12px 0;">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
          {{ adminform.form.content }}
          {% if adminform.form.content.errors %}<div class="error">{{ adminform.form.content.errors }}</div>{% endif %}
        </div>

        <div class="editor-card">
          <h3 style="margin:0 0 12px 0;">üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h3>
          {{ adminform.form.excerpt }}
          <div id="excerpt-counter" class="char-counter">0 —Å–∏–º–≤–æ–ª–æ–≤</div>
        </div>
      </div>

      <aside>
        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 8px 0;">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.status.label_tag }}{{ adminform.form.status }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.published_at.label_tag }}{{ adminform.form.published_at }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.author.label_tag }}{{ adminform.form.author }}</div>
        </div>

        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 8px 0;">üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.categories.label_tag }}{{ adminform.form.categories }}</div>
          <div style="margin:0 0 8px 0;">{{ adminform.form.tags.label_tag }}{{ adminform.form.tags }}</div>
        </div>

        <div class="editor-card">
          <h3 style="margin:0 0 8px 0;">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          <button type="button" id="preview-btn" class="btn" style="width:100%;margin-bottom:8px;">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button type="button" id="fill-meta" class="btn" style="width:100%;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO</button>
          <a href="{% url 'admin-media-library' %}" class="btn" onclick="return openMediaLibrary(event)" style="width:100%;margin-top:8px;">üñºÔ∏è –ú–µ–¥–∏–∞—Ç–µ–∫–∞</a>
        </div>
      </aside>
    </div>

    {# –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django –∏ inline-—Ñ–æ—Ä–º—ã ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º #}
    {% for field in adminform.form.hidden_fields %}{{ field }}{% endfor %}
    {% for inline in inline_admin_formsets %}{{ inline }}{% endfor %}
  </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const CANDIDATES = ['content','excerpt','short_description','body','description','summary'];
  const MEDIA_UPLOAD_URL = "{{ media_upload_url|default:'' }}";
  window.editorMap = window.editorMap || {};

  function initEditors(){
    CANDIDATES.forEach(name=>{
      const ta = document.querySelector('textarea[name="'+name+'"]');
      if(!ta) return;
      if(window.editorMap[name]) return;
      const config = { language: 'ru', toolbar: [ 'heading','|','bold','italic','link','bulletedList','numberedList','blockQuote','insertTable','imageUpload','mediaEmbed','undo','redo' ] };
      if(MEDIA_UPLOAD_URL){
        class SimpleUploadAdapter { constructor(loader){ this.loader = loader } upload(){ return this.loader.file.then(file=>new Promise((resolve,reject)=>{ const fd=new FormData(); fd.append('file',file); fetch(MEDIA_UPLOAD_URL,{ method:'POST', credentials:'same-origin', headers:{ 'X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value||'' }, body: fd }).then(async r=>{ if(!r.ok){ reject(await r.text().catch(()=>r.statusText)); return } const j=await r.json().catch(()=>null); if(j && j.url) resolve({ default: j.url }); else reject('Invalid upload response'); }).catch(err=>reject(err.message||String(err))); })) } abort(){} }
        config.extraPlugins = [ editor => { editor.plugins.get('FileRepository').createUploadAdapter = loader => new SimpleUploadAdapter(loader); } ];
      }
      ClassicEditor.create(ta, config).then(editor=>{ window.editorMap[name] = editor; editor.editing.view.document.on('focus', ()=> window._last_focused_editor = name ); }).catch(e=>console.error('CKEditor init error', e));
    });
  }
  initEditors();
  setTimeout(initEditors, 800);

  window.__insertMediaToEditor = function(url, preferField){
    try {
      preferField = preferField || window._last_focused_editor || 'content';
      if(window.editorMap[preferField]){
        const ed = window.editorMap[preferField];
        ed.model.change(writer => {
          const imageElem = writer.createElement('image', { src: url });
          ed.model.insertContent(imageElem, ed.model.document.selection);
        });
        return true;
      }
      for(const k in window.editorMap){
        const ed = window.editorMap[k];
        if(ed){ ed.model.change(writer=>{ const imageElem = writer.createElement('image', { src: url }); ed.model.insertContent(imageElem, ed.model.document.selection); }); return true; }
      }
      const ta = document.querySelector('textarea[name="'+preferField+'"]') || document.querySelector('textarea');
      if(ta){ ta.value = (ta.value||'') + "\\n<img src='" + url + "' alt=''/>\\n"; return true; }
    } catch(e){ console.warn(e); }
    return false;
  };

  window.openMediaLibrary = function(e){ try{ if(e && e.preventDefault) e.preventDefault(); window.open("{% url 'admin-media-library' %}", "media_library", "width=1000,height=700,scrollbars=yes"); } catch(e){ console.error(e); alert('{% trans "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –º–µ–¥–∏–∞—Ç–µ–∫—É" %}'); } return false; };

  function syncEditorsToTextarea(){
    const form = document.getElementById('post_form');
    if(!form) return;
    try {
      for(const name of CANDIDATES){
        if(window.editorMap[name]){
          const ta = form.querySelector('textarea[name="'+name+'"]');
          if(ta) ta.value = window.editorMap[name].getData();
        }
      }
    } catch(e){ console.warn('sync failed', e); }
  }

  function submitWithFlag(flagName){
    syncEditorsToTextarea();
    const form = document.getElementById('post_form');
    if(!form) return;
    const inp = document.createElement('input'); inp.type='hidden'; inp.name=flagName; inp.value='1';
    form.appendChild(inp);
    form.submit();
  }

  const saveBtn = document.getElementById('pt-save-btn');
  const contBtn = document.getElementById('pt-continue-btn');
  if(saveBtn) saveBtn.addEventListener('click', ()=> submitWithFlag('_save'));
  if(contBtn) contBtn.addEventListener('click', ()=> submitWithFlag('_continue'));

  const gen = document.getElementById('generate-slug');
  const titleEl = document.getElementById('id_title');
  const slugEl = document.getElementById('id_slug');
  if(gen && titleEl && slugEl) gen.addEventListener('click', function(){
    const s = titleEl.value.toLowerCase().replace(/[^\w\s-]/g,'').replace(/[\s_-]+/g,'-').replace(/^-+|-+$/g,'').substring(0,60);
    slugEl.value = s;
  });

  const excerpt = document.getElementById('id_excerpt');
  const counter = document.getElementById('excerpt-counter');
  if(excerpt && counter){
    const upd = ()=> counter.textContent = excerpt.value.length + ' —Å–∏–º–≤–æ–ª–æ–≤';
    upd(); excerpt.addEventListener('input', upd);
  }

  const previewBtn = document.getElementById('preview-btn');
  if(previewBtn) previewBtn.addEventListener('click', function(){
    syncEditorsToTextarea();
    const m = window.location.pathname.match(/\/admin\/.+\/post\/(\d+)\/change/);
    if(m && m[1]) window.open('/preview/' + m[1], '_blank'); else alert('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
  });

  const fillMeta = document.getElementById('fill-meta');
  if(fillMeta) fillMeta.addEventListener('click', function(){
    const t = titleEl ? titleEl.value.trim() : '';
    const e = excerpt ? excerpt.value.trim() : '';
    if(!t) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
    const mt = document.getElementById('id_meta_title');
    const md = document.getElementById('id_meta_description');
    if(mt && !mt.value) mt.value = t;
    if(md && !md.value) md.value = e.substring(0,160);
    alert('SEO –∑–∞–ø–æ–ª–Ω–µ–Ω–æ');
  });

  const nativeForm = document.getElementById('post_form');
  if(nativeForm) nativeForm.addEventListener('submit', function(){ syncEditorsToTextarea(); }, true);
});
</script>
{% endblock %}
