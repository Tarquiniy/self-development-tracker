{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
  <style>
    /* –õ–æ–∫–∞–ª—å–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    :root { --pt-maxw:1200px; --pt-sidebar-w:360px; --pt-gap:18px; }

    /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    .post-editor-modern {
      max-width: var(--pt-maxw);
      margin: 12px auto;
      padding: 0 16px;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    /* Header: —Ä–∞–∑–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ —Ä–∞–∑–Ω—ã–µ –∑–æ–Ω—ã */
    .editor-header { margin-bottom: 16px; }
    .header-content {
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      box-sizing:border-box;
    }
    .header-title { flex: 1 1 auto; min-width: 0; }
    .header-actions {
      flex: 0 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      white-space:nowrap;
      box-sizing:border-box;
    }

    /* –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è ‚Äî –æ–Ω–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –∏ –Ω–µ –Ω–∞—Å–ª–∞–∏–≤–∞—é—Ç—Å—è */
    .header-actions { flex-wrap:wrap; }
    .header-actions .btn { margin:0; }

    /* –°–µ—Ç–∫–∞: –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ + –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã */
    .editor-main {
      display:grid;
      grid-template-columns: 1fr var(--pt-sidebar-w);
      gap: var(--pt-gap);
      align-items:start;
      width:100%;
      box-sizing:border-box;
    }

    /* –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ –∑–∞ —ç–∫—Ä–∞–Ω */
    aside { width: var(--pt-sidebar-w); min-width: 240px; box-sizing:border-box; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏: —Ñ–∏–∫—Å–∏—Ä—É–µ–º padding –∏ –±–æ—Ä–¥–µ—Ä */
    .editor-card { background:#fff; border-radius:10px; padding:14px; box-sizing:border-box; border:1px solid rgba(11,17,32,0.04); }

    /* –ü–æ–ª—è: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ –∏ —Ñ–æ–Ω */
    input, textarea, select { background:#fff !important; color:#0f172a !important; }

    /* –ö–Ω–æ–ø–∫–∏: —è–≤–Ω—ã–π —Å—Ç–∏–ª—å, —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª—Å—è –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ */
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; border:1px solid rgba(11,17,32,0.06); background:#f8fafc; color:#0f172a; font-weight:600; cursor:pointer; text-decoration:none; }
    .btn-primary { background:#0b5fff; color:#fff; border-color:#0846d8; box-shadow:0 6px 18px rgba(11,85,255,0.12); }

    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .post-editor-modern *, .post-editor-modern img, .post-editor-modern iframe { max-width:100%; }

    /* –ú–µ–ª–∫–∏–µ —É—Ç–∏–ª–∏—Ç—ã */
    .char-counter { text-align:right; font-size:12px; color:#6b7280; margin-top:6px; }

    /* Responsive: –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç */
    @media (max-width: 1024px) {
      .editor-main { grid-template-columns: 1fr; }
      aside { width:100%; }
      .header-actions { justify-content:flex-start; }
    }

    /* –ï—Å–ª–∏ –∞–¥–º–∏–Ω—Å–∫–∏–π JS/–≤–∏–¥–∂–µ—Ç—ã –∑–∞–¥–∞—é—Ç position:fixed –¥–ª—è –∫–Ω–æ–ø–æ–∫ ‚Äî –ø–æ–Ω–∏–∂–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç */
    .submit-row, .header-actions { position:relative !important; z-index:2; }
  </style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <header class="editor-header">
    <div class="header-content">
      <div class="header-title">
        <h1 style="margin:0;font-size:20px;color:#0f172a;">
          {% if original %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ original.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:60 }}{% else %}üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞{% endif %}
        </h1>
      </div>

      <div class="header-actions" role="toolbar" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
        {# –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ header-actions; –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ–æ—Ä–º—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è POST #}
        <button type="button" class="btn btn-primary" id="pt-save-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn" id="pt-continue-btn">üîÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <a href="{% url 'admin:app_list' 'blog' %}" class="btn" title="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.media }}

    <div class="editor-main">
      <div>
        <div class="editor-card" style="margin-bottom:14px;">
          <div style="margin-bottom:12px;">
            {{ adminform.form.title.label_tag }}{{ adminform.form.title }}
            {% if adminform.form.title.errors %}<div class="error">{{ adminform.form.title.errors }}</div>{% endif %}
          </div>
          <div>
            {{ adminform.form.slug.label_tag }}
            <div style="display:flex;gap:8px;align-items:center;">
              {{ adminform.form.slug }}
              <button type="button" class="btn" id="generate-slug">üîÑ</button>
            </div>
            <div class="help-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL</div>
            {% if adminform.form.slug.errors %}<div class="error">{{ adminform.form.slug.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 12px 0;">üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
          {{ adminform.form.content }}
          {% if adminform.form.content.errors %}<div class="error">{{ adminform.form.content.errors }}</div>{% endif %}
        </div>

        <div class="editor-card">
          <h3 style="margin:0 0 12px 0;">üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h3>
          {{ adminform.form.excerpt }}
          <div id="excerpt-counter" class="char-counter">0 —Å–∏–º–≤–æ–ª–æ–≤</div>
        </div>
      </div>

      <aside>
        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 8px 0;">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.status.label_tag }}{{ adminform.form.status }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.published_at.label_tag }}{{ adminform.form.published_at }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.author.label_tag }}{{ adminform.form.author }}</div>
        </div>

        <div class="editor-card" style="margin-bottom:14px;">
          <h3 style="margin:0 0 8px 0;">üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.categories.label_tag }}{{ adminform.form.categories }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.tags.label_tag }}{{ adminform.form.tags }}</div>
        </div>

        <div class="editor-card">
          <h3 style="margin:0 0 8px 0;">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          <button type="button" id="preview-btn" class="btn" style="width:100%;margin-bottom:8px;">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button type="button" id="fill-meta" class="btn" style="width:100%;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO</button>
        </div>
      </aside>
    </div>

    {# –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django #}
    {% for field in adminform.form.hidden_fields %}{{ field }}{% endfor %}
    {% for inline in inline_admin_formsets %}{{ inline }}{% endfor %}
  </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function(){
  var form = document.getElementById('post_form');
  if (!form) return;

  function submitWithFlag(name){
    var inp = document.createElement('input'); inp.type='hidden'; inp.name=name; inp.value='1';
    form.appendChild(inp);
    form.submit();
  }

  var saveBtn = document.getElementById('pt-save-btn');
  var contBtn = document.getElementById('pt-continue-btn');
  if (saveBtn) saveBtn.addEventListener('click', function(){ submitWithFlag('_save'); });
  if (contBtn) contBtn.addEventListener('click', function(){ submitWithFlag('_continue'); });

  var gen = document.getElementById('generate-slug');
  var title = document.getElementById('id_title');
  var slug = document.getElementById('id_slug');
  if (gen && title && slug) gen.addEventListener('click', function(){
    var s = title.value.toLowerCase().replace(/[^\w\s-]/g,'').replace(/[\s_-]+/g,'-').replace(/^-+|-+$/g,'').substring(0,60);
    slug.value = s;
  });

  var excerpt = document.getElementById('id_excerpt');
  var counter = document.getElementById('excerpt-counter');
  if (excerpt && counter){
    function upd(){ counter.textContent = excerpt.value.length + ' —Å–∏–º–≤–æ–ª–æ–≤'; }
    upd(); excerpt.addEventListener('input', upd);
  }

  var previewBtn = document.getElementById('preview-btn');
  if (previewBtn) previewBtn.addEventListener('click', function(){
    var m = window.location.pathname.match(/\/admin\/.+\/post\/(\d+)\/change/);
    if (m && m[1]) window.open('/preview/' + m[1], '_blank'); else alert('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
  });

  var fillMeta = document.getElementById('fill-meta');
  if (fillMeta) fillMeta.addEventListener('click', function(){
    var t = title ? title.value.trim() : '';
    var e = excerpt ? excerpt.value.trim() : '';
    if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
    var metaTitle = document.getElementById('id_meta_title');
    var metaDesc = document.getElementById('id_meta_description');
    if (metaTitle && !metaTitle.value) metaTitle.value = t;
    if (metaDesc && !metaDesc.value) metaDesc.value = e.substring(0,160);
    alert('SEO –∑–∞–ø–æ–ª–Ω–µ–Ω–æ');
  });
});
</script>
{% endblock %}
