{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
  <style>
    /* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî —É—Å—Ç—Ä–∞–Ω—è—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –±–∞–∑–æ–≤—ã–º–∏ admin-—Å—Ç–∏–ª–∞–º–∏ */
    /* –ö–æ–Ω—Ç—Ä–∞—Å—Ç –∫–Ω–æ–ø–æ–∫, —É–±–∏—Ä–∞–µ–º –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –±–µ–ª–æ–º —Ñ–æ–Ω–µ */
    .post-editor-modern .btn,
    .post-editor-modern .button,
    .post-editor-modern input[type="submit"],
    .post-editor-modern .submit-row .default {
      color: #0f172a !important;
      background: #f3f4f6 !important;
      border: 1px solid rgba(15,23,42,0.06) !important;
      box-shadow: none !important;
    }
    .post-editor-modern .btn-primary,
    .post-editor-modern input[type="submit"].primary,
    .post-editor-modern .submit-row .default.button-primary {
      color: #fff !important;
      background: #0b5fff !important;
      border-color: #0846d8 !important;
      box-shadow: 0 6px 18px rgba(11,85,255,0.12) !important;
    }

    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞ (–≤ —Å–ª—É—á–∞–µ –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞) */
    .post-editor-modern .btn[disabled],
    .post-editor-modern .btn[aria-disabled="true"] {
      opacity: 0.9 !important;
      color: rgba(0,0,0,0.65) !important;
    }

    /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–µ–∑–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã */
    .post-editor-modern .header-actions,
    .post-editor-modern .header-actions .btn {
      display: inline-flex !important;
      align-items: center !important;
      gap: 8px !important;
      white-space: nowrap !important;
    }
    .post-editor-modern .header-actions .btn {
      padding: 8px 12px !important;
      min-height: 38px !important;
      line-height: 1 !important;
      border-radius: 8px !important;
    }

    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞–µ–º submit-row –≤–∏–¥–∏–º—ã–º –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º */
    .post-editor-modern .submit-row { display:flex !important; gap:8px !important; align-items:center !important; }
    .post-editor-modern .submit-row .deletelink { margin-left:auto !important; }

    /* –í—ã—Ä–æ–≤–Ω—è—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ iframe –≤–∏–¥–∂–µ—Ç—ã */
    .post-editor-modern .editor, .post-editor-modern .cke, .post-editor-modern .tox-tinymce, .post-editor-modern iframe {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }

    /* –£–±–∏—Ä–∞–µ–º –Ω–∞—Å–ª–µ–¥—É–µ–º—ã–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—ã, –ª–æ–º–∞–≤—à–∏–µ –≤–∏–¥ */
    .post-editor-modern * { background-blend-mode: normal !important; filter: none !important; }

    /* –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã ‚Äî —á—Ç–æ–±—ã –Ω–µ —Å–∫—Ä—ã–≤–∞–ª–∏—Å—å */
    .post-editor-modern input, .post-editor-modern textarea, .post-editor-modern select {
      background: #fff !important;
      color: #0b1220 !important;
      border: 1px solid rgba(11,17,32,0.06) !important;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 1000px) {
      .post-editor-modern .editor-main { grid-template-columns: 1fr !important; }
      .post-editor-modern .header-actions { width: 100%; justify-content: flex-start; flex-wrap:wrap; }
    }
  </style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <header class="editor-header">
    <div class="header-content" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
      <div class="header-title">
        <h1 style="margin:0;font-size:20px;color:#0f172a;">
          {% if original %}
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ original.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:60 }}
          {% else %}
            üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
          {% endif %}
        </h1>
      </div>

      <div class="header-actions" role="toolbar" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
        {# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ –∫–Ω–æ–ø–æ–∫ Django #}
        <form id="pt-action-form" method="post" style="display:inline-block;">
          {% csrf_token %}
          <button type="submit" name="_save" class="btn btn-primary" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="submit" name="_continue" class="btn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å">üîÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
          <a href="{% url 'admin:app_list' 'blog' %}" class="btn" title="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</a>
        </form>
      </div>
    </div>
  </header>

  {# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞: –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–¥–∏–Ω—ã–π form —á—Ç–æ–±—ã Django –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–Ω—è–ª –ø–æ–ª—è –∏ –≤–∏–¥–∂–µ—Ç—ã #}
  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ adminform.media }}

    <div class="editor-main" style="display:grid;grid-template-columns:1fr 360px;gap:18px;">
      <div>
        <div class="editor-card" style="margin-bottom:12px;padding:12px;background:#fff;border-radius:8px;">
          <div style="margin-bottom:12px;">
            {{ adminform.form.title.label_tag }}{{ adminform.form.title }}
            {% if adminform.form.title.errors %}<div class="error">{{ adminform.form.title.errors }}</div>{% endif %}
          </div>

          <div style="margin-bottom:12px;">
            {{ adminform.form.slug.label_tag }}
            <div style="display:flex;gap:8px;align-items:center;">
              {{ adminform.form.slug }}
              <button type="button" class="btn" id="generate-slug">üîÑ</button>
            </div>
            <div class="help-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL</div>
            {% if adminform.form.slug.errors %}<div class="error">{{ adminform.form.slug.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="editor-card" style="padding:12px;background:#fff;border-radius:8px;">
          <h3 style="margin-top:0;margin-bottom:12px;">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
          {{ adminform.form.content }}
          {% if adminform.form.content.errors %}<div class="error">{{ adminform.form.content.errors }}</div>{% endif %}
        </div>

        <div class="editor-card" style="margin-top:12px;padding:12px;background:#fff;border-radius:8px;">
          <h3 style="margin-top:0;margin-bottom:12px;">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h3>
          {{ adminform.form.excerpt }}
          <div id="excerpt-counter" class="char-counter" style="margin-top:8px;">0 —Å–∏–º–≤–æ–ª–æ–≤</div>
        </div>
      </div>

      <aside>
        <div class="editor-card" style="margin-bottom:12px;padding:12px;background:#fff;border-radius:8px;">
          <h3 style="margin:0 0 8px 0;">–ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.status.label_tag }}{{ adminform.form.status }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.published_at.label_tag }}{{ adminform.form.published_at }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.author.label_tag }}{{ adminform.form.author }}</div>
        </div>

        <div class="editor-card" style="margin-bottom:12px;padding:12px;background:#fff;border-radius:8px;">
          <h3 style="margin:0 0 8px 0;">–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
          <div style="margin-bottom:8px;">{{ adminform.form.categories.label_tag }}{{ adminform.form.categories }}</div>
          <div style="margin-bottom:8px;">{{ adminform.form.tags.label_tag }}{{ adminform.form.tags }}</div>
        </div>

        <div class="editor-card" style="padding:12px;background:#fff;border-radius:8px;">
          <h3 style="margin:0 0 8px 0;">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          <button type="button" id="preview-btn" class="btn" style="width:100%;margin-bottom:8px;">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button type="button" id="fill-meta" class="btn" style="width:100%;">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO</button>
        </div>
      </aside>
    </div>

    {# –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django #}
    {% for field in adminform.form.hidden_fields %}{{ field }}{% endfor %}
    {% for inline in inline_admin_formsets %}{{ inline }}{% endfor %}
  </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è slug
  var gen = document.getElementById('generate-slug');
  var title = document.getElementById('id_title');
  var slug = document.getElementById('id_slug');
  if (gen && title && slug) gen.addEventListener('click', function(){ var s=title.value.toLowerCase().replace(/[^\w\s-]/g,'').replace(/[\s_-]+/g,'-').replace(/^-+|-+$/g,'').substring(0,60); slug.value=s; });

  // Excerpt counter
  var excerpt = document.getElementById('id_excerpt');
  var counter = document.getElementById('excerpt-counter');
  if (excerpt && counter) {
    function upd(){ counter.textContent = excerpt.value.length + ' —Å–∏–º–≤–æ–ª–æ–≤'; }
    upd(); excerpt.addEventListener('input', upd);
  }

  // Preview
  var previewBtn = document.getElementById('preview-btn');
  if (previewBtn) previewBtn.addEventListener('click', function(){
    var m = window.location.pathname.match(/\/admin\/.+\/post\/(\d+)\/change/);
    if (m && m[1]) window.open('/preview/' + m[1], '_blank'); else alert('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞');
  });

  // Fill meta
  var fillMeta = document.getElementById('fill-meta');
  if (fillMeta) fillMeta.addEventListener('click', function(){
    var t = title ? title.value.trim() : '';
    var e = excerpt ? excerpt.value.trim() : '';
    if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
    var metaTitle = document.getElementById('id_meta_title');
    var metaDesc = document.getElementById('id_meta_description');
    if (metaTitle && !metaTitle.value) metaTitle.value = t;
    if (metaDesc && !metaDesc.value) metaDesc.value = e.substring(0,160);
    alert('SEO –∑–∞–ø–æ–ª–Ω–µ–Ω–æ');
  });

  // –ï—Å–ª–∏ –≤–µ—Ä—Ö–Ω—è—è —Ñ–æ—Ä–º–∞ (pt-action-form) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –¥–ª—è –∫–ª–∏–∫–∞ ‚Äî –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π form
  var actionForm = document.getElementById('pt-action-form');
  if (actionForm) {
    actionForm.addEventListener('submit', function(e){
      e.preventDefault();
      // –ù–∞–π–¥—ë–º –∫–∞–∫–æ–π button –±—ã–ª –Ω–∞–∂–∞—Ç–∞
      var pressed = document.activeElement;
      var name = pressed && pressed.name ? pressed.name : '_save';
      var val = pressed && pressed.value ? pressed.value : '1';
      // –°–æ–∑–¥–∞—ë–º hidden –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
      var mainForm = document.getElementById('post_form');
      if (!mainForm) return;
      var h = document.createElement('input'); h.type='hidden'; h.name = name; h.value = val; mainForm.appendChild(h);
      mainForm.submit();
    });
  }
});
</script>
{% endblock %}
