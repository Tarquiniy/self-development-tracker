<!-- backend/templates/admin/blog/post/change_form_fixed.html -->
{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
/* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ */
.post-editor-modern {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.editor-header {
  background: white;
  border-bottom: 1px solid #e5e7eb;
  padding: 1rem 2rem;
  margin: -1rem -2rem 2rem;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-actions {
  display: flex;
  gap: 0.75rem;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-secondary {
  background: #6b7280;
  color: white;
}

.btn-outline {
  background: transparent;
  border: 1px solid #d1d5db;
  color: #374151;
}

.editor-main {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 2rem;
  margin-top: 2rem;
}

.content-area, .sidebar-area {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.editor-card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
}

.card-header {
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
}

.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: #374151;
}

.form-input, .form-textarea, .form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.875rem;
}

.title-field {
  font-size: 1.25rem !important;
  font-weight: 600;
}

.quick-actions {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.btn-action {
  width: 100%;
  justify-content: center;
  padding: 0.875rem 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <!-- Header -->
  <header class="editor-header">
    <div class="header-content">
      <div class="header-title">
        <h1>
          {% if original %}
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ original.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:50 }}
          {% else %}
            üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
          {% endif %}
        </h1>
      </div>
      <div class="header-actions">
        <!-- –≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–æ—Ä–º—É Django -->
        <button type="submit" name="_save" class="btn btn-primary" form="post_form">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button type="submit" name="_continue" class="btn btn-secondary" form="post_form">
          üîÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
        {# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞–∑–∞–¥: –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è blog –≤ –∞–¥–º–∏–Ω–∫–µ #}
        <a href="{% url 'admin:app_list' 'blog' %}" class="btn btn-outline">
          ‚Üê –ù–∞–∑–∞–¥
        </a>
      </div>
    </div>
  </header>

  <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ–æ—Ä–º—É Django, –Ω–æ —Å –Ω–∞—à–µ–π —Ä–∞–∑–º–µ—Ç–∫–æ–π -->
  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    
    <div class="editor-main">
      <!-- Left Column - Content -->
      <div class="content-area">
        <!-- Title & Slug -->
        <div class="editor-card">
          <div class="card-header">
            <h3>üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label" for="id_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞ *</label>
              <input type="text" name="title" value="{{ adminform.form.title.value|default:'' }}" id="id_title" class="form-input title-field" placeholder="–í–≤–µ–¥–∏—Ç–µ captivating –∑–∞–≥–æ–ª–æ–≤–æ–∫..." maxlength="255" required>
              {% if adminform.form.title.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.title.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="form-label" for="id_slug">URL Slug</label>
              <input type="text" name="slug" value="{{ adminform.form.slug.value|default:'' }}" id="id_slug" class="form-input" placeholder="avtomaticeskiy-slug">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                <span>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL</span>
                <button type="button" id="generate-slug" class="btn btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
              {% if adminform.form.slug.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.slug.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Content Editor -->
        <div class="editor-card">
          <div class="card-header">
            <h3>üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              {{ adminform.form.content }}
              {% if adminform.form.content.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.content.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Excerpt -->
        <div class="editor-card">
          <div class="card-header">
            <h3>üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <textarea name="excerpt" id="id_excerpt" class="form-textarea" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—Ç–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –ø—Ä–µ–≤—å—é..." rows="3">{{ adminform.form.excerpt.value|default:'' }}</textarea>
              <div class="char-counter" style="text-align: right; font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                <span id="excerpt-counter">0</span>/320 —Å–∏–º–≤–æ–ª–æ–≤
              </div>
              {% if adminform.form.excerpt.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.excerpt.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Sidebar -->
      <div class="sidebar-area">
        <!-- Publication -->
        <div class="editor-card">
          <div class="card-header">
            <h3>üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
          </div>
          <div class="card-body">
            <!-- Status -->
            <div class="form-group">
              <label class="form-label" for="id_status">–°—Ç–∞—Ç—É—Å</label>
              <select name="status" id="id_status" class="form-select">
                {% for value, label in adminform.form.status.field.choices %}
                  <option value="{{ value }}" {% if adminform.form.status.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              {% if adminform.form.status.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.status.errors }}</div>
              {% endif %}
            </div>

            <!-- Published At -->
<div class="form-group">
    <label class="form-label" for="id_published_at">–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
    <input type="datetime-local" name="published_at" value="{{ adminform.form.published_at.value|default:'' }}" id="id_published_at" class="form-input">
    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
        –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    </div>
    {% if adminform.form.published_at.errors %}
    <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">
        {% for error in adminform.form.published_at.errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}
</div>

            <!-- Author -->
            <div class="form-group">
              <label class="form-label" for="id_author">–ê–≤—Ç–æ—Ä</label>
              <select name="author" id="id_author" class="form-select">
                <option value="">---------</option>
                {% for value, label in adminform.form.author.field.choices %}
                  <option value="{{ value }}" {% if adminform.form.author.value == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              {% if adminform.form.author.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.author.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Categories & Tags -->
        <div class="editor-card">
          <div class="card-header">
            <h3>üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
          </div>
          <div class="card-body">
            <!-- Categories -->
            <div class="form-group">
              <label class="form-label" for="id_categories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
              <select name="categories" id="id_categories" class="form-select" multiple style="height: 120px;">
                {% for value, label in adminform.form.categories.field.choices %}
                  <option value="{{ value }}" {% if value in adminform.form.categories.value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              {% if adminform.form.categories.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.categories.errors }}</div>
              {% endif %}
            </div>

            <!-- Tags -->
            <div class="form-group">
              <label class="form-label" for="id_tags">–¢–µ–≥–∏</label>
              <select name="tags" id="id_tags" class="form-select" multiple style="height: 120px;">
                {% for value, label in adminform.form.tags.field.choices %}
                  <option value="{{ value }}" {% if value in adminform.form.tags.value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              {% if adminform.form.tags.errors %}
              <div class="error" style="color: red; font-size: 0.875rem; margin-top: 0.25rem;">{{ adminform.form.tags.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="editor-card">
          <div class="card-header">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
          </div>
          <div class="card-body">
            <div class="quick-actions">
              <button type="button" id="preview-btn" class="btn btn-action">
                üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
              </button>
              <button type="button" id="fill-meta" class="btn btn-action">
                üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO
              </button>
              {# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–ø–∏—Å–æ–∫ app blog –≤ –∞–¥–º–∏–Ω–∫–µ –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ model change list #}
              <a href="{% url 'admin:app_list' 'blog' %}" class="btn btn-action" target="_blank">
                üóÇÔ∏è –ú–µ–¥–∏–∞—Ç–µ–∫–∞ / Blog
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django -->
    {% for field in adminform.form.hidden_fields %}
      {{ field }}
    {% endfor %}
  </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Fixed Post Editor initialized');

  // –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
  initDateTimeFields();  // <-- –î–û–ë–ê–í–õ–ï–ù–û: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  initSlugGeneration();
  initCharacterCounters();
  initQuickActions();

  function initDateTimeFields() {
    const publishedAtField = document.getElementById('id_published_at');
    
    if (publishedAtField && !publishedAtField.value) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤
        const now = new Date();
        const timezoneOffset = now.getTimezoneOffset() * 60000; // –°–º–µ—â–µ–Ω–∏–µ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const localISOTime = new Date(now - timezoneOffset).toISOString().slice(0, 16);
        publishedAtField.value = localISOTime;
        console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', localISOTime);
    } else if (publishedAtField && publishedAtField.value) {
        console.log('‚úÖ –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', publishedAtField.value);
    }
  }

  function initSlugGeneration() {
    const generateBtn = document.getElementById('generate-slug');
    const titleField = document.getElementById('id_title');
    const slugField = document.getElementById('id_slug');

    if (generateBtn && titleField && slugField) {
      generateBtn.addEventListener('click', function() {
        const title = titleField.value.trim();
        if (title) {
          const slug = generateSlug(title);
          slugField.value = slug;
          showNotification('Slug —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        } else {
          showNotification('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–Ω–∞—á–∞–ª–∞', 'warning');
        }
      });

      // Auto-generate slug when title changes (if slug is empty)
      titleField.addEventListener('blur', function() {
        if (!slugField.value.trim()) {
          const title = titleField.value.trim();
          if (title) {
            slugField.value = generateSlug(title);
          }
        }
      });
    }
  }

  function initCharacterCounters() {
    const excerptField = document.getElementById('id_excerpt');
    const metaDescField = document.getElementById('id_meta_description');

    function updateCounter(field, counterId, maxLength) {
      const counter = document.getElementById(counterId);
      if (!counter || !field) return;

      const length = field.value.length;
      counter.textContent = length;

      // Update counter color based on length
      if (length > maxLength) {
        counter.style.color = '#ef4444';
      } else if (length > maxLength * 0.9) {
        counter.style.color = '#f59e0b';
      } else {
        counter.style.color = '';
      }
    }

    if (excerptField) {
      updateCounter(excerptField, 'excerpt-counter', 320);
      excerptField.addEventListener('input', () => updateCounter(excerptField, 'excerpt-counter', 320));
    }
  }

  function initQuickActions() {
    // Preview button
    const previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
      previewBtn.addEventListener('click', function() {
        const postId = getPostId();
        if (postId) {
          window.open(`/preview/${postId}`, '_blank');
        } else {
          showNotification('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Å—Ç –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'warning');
        }
      });
    }

    // Fill meta button
    const fillMetaBtn = document.getElementById('fill-meta');
    const titleField = document.getElementById('id_title');
    const excerptField = document.getElementById('id_excerpt');

    if (fillMetaBtn && titleField) {
      fillMetaBtn.addEventListener('click', function() {
        const title = titleField.value.trim();
        const excerpt = excerptField ? excerptField.value.trim() : '';

        if (title) {
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è SEO –ø–æ–ª–µ–π
          showNotification('SEO –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã', 'success');
        } else {
          showNotification('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–Ω–∞—á–∞–ª–∞', 'warning');
        }
      });
    }
  }

  function generateSlug(text) {
    return text
      .toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/[\s_-]+/g, '-')
      .replace(/^-+|-+$/g, '')
      .substring(0, 50);
  }

  function getPostId() {
    const urlMatch = window.location.pathname.match(/\/admin\/blog\/post\/(\d+)\/change/);
    return urlMatch ? urlMatch[1] : null;
  }

  function showNotification(message, type = 'info', duration = 3000) {
    // Remove existing notifications
    const existing = document.querySelector('.custom-notification');
    if (existing) existing.remove();

    // Create notification
    const notification = document.createElement('div');
    notification.className = `custom-notification`;
    notification.innerHTML = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      border-left: 4px solid ${type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
      max-width: 300px;
    `;

    document.body.appendChild(notification);

    // Auto remove
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, duration);
  }

  // –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
  const form = document.getElementById('post_form');
  if (form) {
    form.addEventListener('submit', function(e) {
      const title = document.getElementById('id_title').value.trim();
      if (!title) {
        e.preventDefault();
        showNotification('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è', 'error');
        document.getElementById('id_title').focus();
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      const submitBtn = document.querySelector('button[name="_save"]');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      }
    });
  }
});
</script>
{% endblock %}
