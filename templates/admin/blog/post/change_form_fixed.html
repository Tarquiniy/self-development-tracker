{% extends "admin/change_form.html" %}
{% load static i18n %}

{% block extrahead %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/admin-modern.css' %}">
  <link rel="stylesheet" href="{% static 'admin/css/main.css' %}">
  <style>
    /* –ù–µ–±–æ–ª—å—à–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∫–∏ */
    .post-editor-modern { max-width: 1400px; margin: 0 auto; padding: 8px; box-sizing: border-box; }
    .editor-header { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .header-content { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .header-title h1 { margin:0; font-size:20px; color:#0f172a; }
    .header-actions { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .editor-main { display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
    @media (max-width:1000px) { .editor-main { grid-template-columns: 1fr; } .post-preview{position:relative; width:100%; top:0;} }

    .editor-card { background:#fff; border-radius:8px; padding:14px; box-shadow:0 1px 3px rgba(0,0,0,0.04); border:1px solid rgba(15,23,42,0.04); }
    .card-header h3 { margin:0; font-size:16px; color:#0f172a; display:flex; align-items:center; gap:8px; }

    .form-input, .form-textarea, .form-select, textarea, input[type="text"], input[type="datetime-local"] {
      width:100%; box-sizing:border-box; padding:10px 12px; border-radius:6px; border:1px solid #e6eef6; background:#fff;
      font-size:14px; color:#0f172a;
    }

    .form-textarea { min-height:120px; resize:vertical; }
    /* –í—ã—Ä–æ–≤–Ω—è—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä (CKEditor/TinyMCE) */
    .editor iframe, .editor textarea, .editor .cke, .editor .tox-tinymce { width:100% !important; box-sizing:border-box; }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; cursor:pointer; text-decoration:none; border:1px solid rgba(15,23,42,0.06); background:#f8fafc; color:#0f172a; font-weight:600; }
    .btn-primary { background: #3b82f6; color: #fff; border: none; box-shadow: 0 6px 18px rgba(59,130,246,0.12); }
    .btn-secondary { background: #f3f4f6; color: #0f172a; border:1px solid #e6eef6; }
    .btn-action { display:block; width:100%; padding:10px 12px; border-radius:8px; text-align:center; background:#f8fafc; border:1px solid rgba(15,23,42,0.04); }

    /* –ë—ã—Å—Ç—Ä–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–¥ –ø–æ–ª—è–º–∏ */
    .help-text { font-size:12px; color:#6b7280; margin-top:6px; }

    /* –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ —Å–ø—Ä–∞–≤–∞ */
    .char-counter { text-align:right; font-size:12px; color:#6b7280; }

    /* –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –∏—Ö –Ω–µ–≤–∏–¥–∏–º—ã–º–∏, –Ω–æ –≤ DOM */
    .hidden-django-field { display:none !important; }
  </style>
{% endblock %}

{% block content %}
<div class="post-editor-modern">
  <!-- Header -->
  <header class="editor-header">
    <div class="header-content">
      <div class="header-title">
        <h1>
          {% if original %}
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {{ original.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:60 }}
          {% else %}
            üìù –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
          {% endif %}
        </h1>
      </div>

      <div class="header-actions" role="toolbar" aria-label="–î–µ–π—Å—Ç–≤–∏—è">
        <!-- –ö–Ω–æ–ø–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–º–µ–Ω–∞ Django: _save, _continue, _addanother -->
        <button type="button" class="btn btn-primary" id="pt-save-btn" name="_save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-secondary" id="pt-continue-btn" name="_continue" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å">üîÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        <a href="{% url 'admin:app_list' 'blog' %}" class="btn" title="–ù–∞–∑–∞–¥">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <form method="post" id="post_form" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {# –í—Å—Ç–∞–≤–ª—è–µ–º media, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å js –≤–∏–¥–∂–µ—Ç–æ–≤ (WYSIWYG, datepicker –∏ —Ç.–ø.) #}
    {{ adminform.media }}

    <div class="editor-main">
      <!-- Left Column - Content -->
      <div>
        <div class="editor-card">
          <div class="card-header"><h3>üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3></div>
          <div>
            <div style="margin-bottom:12px;">
              {{ adminform.form.title.label_tag }} 
              {{ adminform.form.title }}
              {% if adminform.form.title.errors %}<div class="error">{{ adminform.form.title.errors }}</div>{% endif %}
            </div>

            <div style="margin-bottom:12px;">
              {{ adminform.form.slug.label_tag }}
              <div style="display:flex; gap:8px; align-items:center;">
                {{ adminform.form.slug }}
                <button type="button" class="btn" id="generate-slug" title="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å slug">üîÑ</button>
              </div>
              <div class="help-text">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ URL</div>
              {% if adminform.form.slug.errors %}<div class="error">{{ adminform.form.slug.errors }}</div>{% endif %}
            </div>
          </div>
        </div>

        <div class="editor-card" style="margin-top:12px;">
          <div class="card-header"><h3>üìù –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</h3></div>
          <div>
            {{ adminform.form.content }}
            {% if adminform.form.content.errors %}<div class="error">{{ adminform.form.content.errors }}</div>{% endif %}
            <div class="help-text" style="margin-top:8px;">–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –°–ª–æ–≤–∞/—Å–∏–º–≤–æ–ª—ã —Å—á–∏—Ç–∞—é—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º.</div>
          </div>
        </div>

        <div class="editor-card" style="margin-top:12px;">
          <div class="card-header"><h3>üìã –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</h3></div>
          <div>
            {{ adminform.form.excerpt }}
            <div class="char-counter" id="excerpt-counter">0</div>
            {% if adminform.form.excerpt.errors %}<div class="error">{{ adminform.form.excerpt.errors }}</div>{% endif %}
          </div>
        </div>
      </div>

      <!-- Right Column - Sidebar -->
      <aside>
        <div class="editor-card">
          <div class="card-header"><h3>üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3></div>
          <div>
            <div style="margin-bottom:10px;">{{ adminform.form.status.label_tag }} {{ adminform.form.status }}</div>
            <div style="margin-bottom:10px;">{{ adminform.form.published_at.label_tag }} {{ adminform.form.published_at }}</div>
            <div style="margin-bottom:10px;">{{ adminform.form.author.label_tag }} {{ adminform.form.author }}</div>
            {% if adminform.form.published_at.errors %}<div class="error">{{ adminform.form.published_at.errors }}</div>{% endif %}
          </div>
        </div>

        <div class="editor-card" style="margin-top:12px;">
          <div class="card-header"><h3>üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è</h3></div>
          <div>
            <div style="margin-bottom:10px;">{{ adminform.form.categories.label_tag }} {{ adminform.form.categories }}</div>
            <div style="margin-bottom:10px;">{{ adminform.form.tags.label_tag }} {{ adminform.form.tags }}</div>
          </div>
        </div>

        <div class="editor-card" style="margin-top:12px;">
          <div class="card-header"><h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3></div>
          <div>
            <button type="button" class="btn-action" id="preview-btn">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button type="button" class="btn-action" id="fill-meta">üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å SEO</button>
            <a class="btn-action" href="{% url 'admin:app_list' 'blog' %}" target="_blank">üóÇÔ∏è –ú–µ–¥–∏–∞—Ç–µ–∫–∞</a>
          </div>
        </div>
      </aside>
    </div>

    {# –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è Django (–∫–ª—é—á–µ–≤—ã–µ hidden fields –∏ management form) #}
    {% for field in adminform.form.hidden_fields %}
      {{ field }}
    {% endfor %}
    {# inlines, formsets –∏ —Ç.–¥. –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ adminform.instance #}
    {% for inline in inline_admin_formsets %}
      {{ inline }}
    {% endfor %}
  </form>
</div>
{% endblock %}

{% block footer %}
{{ block.super }}
<script src="{% static 'admin/js/custom_admin.js' %}"></script>
<script>
(function(){
  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç Django-—Ñ–æ—Ä–º—É —Å –Ω—É–∂–Ω—ã–º name
  function submitWithName(form, name, value) {
    // —Å–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å –∏–º–µ–Ω–µ–º
    var inpt = document.createElement('input');
    inpt.type = 'hidden';
    inpt.name = name;
    if (value !== undefined) inpt.value = value;
    form.appendChild(inpt);
    form.submit();
  }

  document.addEventListener('DOMContentLoaded', function(){
    var form = document.getElementById('post_form');
    if (!form) return;

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π admin submit-row —Å–∫—Ä–∏–ø—Ç–∞–º –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—à–∏—Ö –∫–Ω–æ–ø–æ–∫
    var saveBtn = document.getElementById('pt-save-btn');
    var contBtn = document.getElementById('pt-continue-btn');

    if (saveBtn) saveBtn.addEventListener('click', function(){ submitWithName(form, '_save', '1'); });
    if (contBtn) contBtn.addEventListener('click', function(){ submitWithName(form, '_continue', '1'); });

    // Generate slug
    var gen = document.getElementById('generate-slug');
    var title = document.getElementById('id_title');
    var slug = document.getElementById('id_slug');
    if (gen && title && slug) {
      gen.addEventListener('click', function(){
        var t = title.value.trim();
        if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π slug'); return; }
        var s = t.toLowerCase().replace(/[^\w\s-]/g,'').replace(/[\s_-]+/g,'-').replace(/^-+|-+$/g,'').substring(0,60);
        slug.value = s;
      });
    }

    // Excerpt counter
    var excerpt = document.getElementById('id_excerpt');
    var counter = document.getElementById('excerpt-counter');
    if (excerpt && counter) {
      function update() { counter.textContent = excerpt.value.length + ' —Å–∏–º–≤–æ–ª–æ–≤'; }
      update();
      excerpt.addEventListener('input', update);
    }

    // Preview button - –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π ID, –æ—Ç–∫—Ä—ã–≤–∞–µ–º preview
    var previewBtn = document.getElementById('preview-btn');
    if (previewBtn) {
      previewBtn.addEventListener('click', function(){
        // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å ID –∏–∑ URL –≤–∏–¥–∞ /admin/blog/post/<id>/change/
        var m = window.location.pathname.match(/\/admin\/.+\/post\/(\d+)\/change/);
        if (m && m[1]) { window.open('/preview/' + m[1], '_blank'); return; }
        alert('–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Å—Ç, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä');
      });
    }

    // Fill meta - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π placeholder
    var fillMeta = document.getElementById('fill-meta');
    if (fillMeta) fillMeta.addEventListener('click', function(){
      var t = title ? title.value.trim() : '';
      var e = excerpt ? excerpt.value.trim() : '';
      if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
      // –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª—è meta_title/meta_description, –ø—Ä–æ–±—É–µ–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å
      var metaTitle = document.getElementById('id_meta_title');
      var metaDesc = document.getElementById('id_meta_description');
      if (metaTitle && !metaTitle.value) metaTitle.value = t;
      if (metaDesc && !metaDesc.value) metaDesc.value = e.substring(0,160);
      alert('SEO –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã (–ª–æ–∫–∞–ª—å–Ω–æ)');
    });

    // Safety: –µ—Å–ª–∏ –∞–¥–º–∏–Ω –ø–æ–¥–∫–ª—é—á–∏–ª –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ submit handlers, –æ—Å—Ç–∞–≤–∏—Ç—å –∏—Ö
    // –ù–∏—á–µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –ª–æ–º–∞–µ–º
  });
})();
</script>
{% endblock %}
