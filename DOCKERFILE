# ========================
# 1. Build frontend (React + Vite)
# ========================
FROM node:20 AS frontend-builder
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ ./
RUN npm run build

# ========================
# 2. Build backend (Django)
# ========================
FROM python:3.12-slim AS backend
WORKDIR /app

# Устанавливаем зависимости Python
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Копируем backend
COPY backend/ ./backend/

# Копируем frontend сборку внутрь Django (STATICFILES_DIRS уже настроены)
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# ========================
# 3. Production image
# ========================
FROM python:3.12-slim

# Устанавливаем зависимости для запуска
WORKDIR /app
COPY --from=backend /usr/local/lib/python3.12 /usr/local/lib/python3.12
COPY --from=backend /usr/local/bin /usr/local/bin
COPY --from=backend /app /app

# Collect static files
RUN python backend/manage.py collectstatic --noinput

# Запуск через gunicorn
CMD ["gunicorn", "core.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "4"]
